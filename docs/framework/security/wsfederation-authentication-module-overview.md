---
title: WSFederation 身份验证模块概述
ms.date: 03/30/2017
ms.assetid: 02c4d5e8-f0a7-49ee-9cf5-3647578510ad
author: BrucePerlerMS
ms.openlocfilehash: 63090efdf97066b4a276880d4f4be0f843de6800
ms.sourcegitcommit: c7a7e1468bf0fa7f7065de951d60dfc8d5ba89f5
ms.translationtype: MT
ms.contentlocale: zh-CN
ms.lasthandoff: 05/14/2019
ms.locfileid: "65586051"
---
# <a name="wsfederation-authentication-module-overview"></a><span data-ttu-id="46940-102">WSFederation 身份验证模块概述</span><span class="sxs-lookup"><span data-stu-id="46940-102">WSFederation Authentication Module Overview</span></span>
<span data-ttu-id="46940-103">Windows Identity Foundation (WIF) 包括通过 WS-联合身份验证模块 (WS-FAM) 对 ASP.NET 应用程序中联合身份验证的支持。</span><span class="sxs-lookup"><span data-stu-id="46940-103">Windows Identity Foundation (WIF) includes support for federated authentication in ASP.NET applications through the WS-Federated Authentication Module (WS-FAM).</span></span> <span data-ttu-id="46940-104">本主题有助于理解联合身份验证的工作原理和使用方法。</span><span class="sxs-lookup"><span data-stu-id="46940-104">This topic will help you understand how federated authentication works and how to use it.</span></span>  
  
### <a name="overview-of-federated-authentication"></a><span data-ttu-id="46940-105">联合身份验证概述</span><span class="sxs-lookup"><span data-stu-id="46940-105">Overview of Federated Authentication</span></span>  
 <span data-ttu-id="46940-106">当两个信任域之间存在信任关系时，联合身份验证允许一个信任域中的安全令牌服务 (STS) 向另一个信任域中的 STS 提供身份验证信息。</span><span class="sxs-lookup"><span data-stu-id="46940-106">Federated authentication allows a Security Token Service (STS) in one trust domain to provide authentication information to an STS in another trust domain when there is a trust relationship between the two domains.</span></span> <span data-ttu-id="46940-107">出现这种是在下图中所示：</span><span class="sxs-lookup"><span data-stu-id="46940-107">An example of this is shown in the following illustration:</span></span>  
  
 ![联合身份验证方案的图示。](./media/wsfederation-authentication-module-overview/federated-authentication.gif)  
  
1. <span data-ttu-id="46940-109">Fabrikam 信任域中的客户端向 Contoso 信任域中的信赖方 (RP) 应用发送请求。</span><span class="sxs-lookup"><span data-stu-id="46940-109">A client in the Fabrikam trust domain sends a request to a Relying Party (RP) application in the Contoso trust domain.</span></span>  
  
2. <span data-ttu-id="46940-110">RP 将客户端重定向到 Contoso 信任域中的 STS。</span><span class="sxs-lookup"><span data-stu-id="46940-110">The RP redirects the client to an STS in the Contoso trust domain.</span></span> <span data-ttu-id="46940-111">此 STS 完全不了解该客户端。</span><span class="sxs-lookup"><span data-stu-id="46940-111">This STS has no knowledge of the client.</span></span>  
  
3. <span data-ttu-id="46940-112">Contoso STS 将该客户端重定向到 Fabrikam 信任域中的 STS，此信任域与 Contoso 信任域之间存在信任关系。</span><span class="sxs-lookup"><span data-stu-id="46940-112">The Contoso STS redirects the client to an STS in the Fabrikam trust domain, with which the Contoso trust domain has a trust relationship.</span></span>  
  
4. <span data-ttu-id="46940-113">Fabrikam STS 验证客户端的标识，并向 Contoso STS 颁发安全令牌。</span><span class="sxs-lookup"><span data-stu-id="46940-113">The Fabrikam STS verifies the client’s identity and issues a security token to the Contoso STS.</span></span>  
  
5. <span data-ttu-id="46940-114">Contoso STS 使用 Fabrikam 令牌来创建自己的令牌（可由 RP 使用）并将其发送到 RP。</span><span class="sxs-lookup"><span data-stu-id="46940-114">The Contoso STS uses the Fabrikam token to create its own token that can be used by the RP and sends it to the RP.</span></span>  
  
6. <span data-ttu-id="46940-115">RP 从安全令牌中提取客户端声明并做出授权决策。</span><span class="sxs-lookup"><span data-stu-id="46940-115">The RP extracts the client’s claims from the security token and makes an authorization decision.</span></span>  
  
### <a name="using-the-federated-authentication-module-with-aspnet"></a><span data-ttu-id="46940-116">将联合身份验证模块与 ASP.NET 搭配使用</span><span class="sxs-lookup"><span data-stu-id="46940-116">Using the Federated Authentication Module with ASP.NET</span></span>  
 <span data-ttu-id="46940-117"><xref:System.IdentityModel.Services.WSFederationAuthenticationModule> (WS-FAM) 是一个可以将联合身份验证添加到 [!INCLUDE[vstecasp](../../../includes/vstecasp-md.md)] 应用程序的 HTTP 模块。</span><span class="sxs-lookup"><span data-stu-id="46940-117"><xref:System.IdentityModel.Services.WSFederationAuthenticationModule> (WS-FAM) is an HTTP module that lets you add federated authentication to an [!INCLUDE[vstecasp](../../../includes/vstecasp-md.md)] application.</span></span> <span data-ttu-id="46940-118">联合身份验证将身份验证逻辑交由 STS 处理，让你可以集中注意力编写业务逻辑。</span><span class="sxs-lookup"><span data-stu-id="46940-118">Federated authentication lets authentication logic be handled by the STS and lets you focus on writing business logic.</span></span>  
  
 <span data-ttu-id="46940-119">可以配置 WS-FAM 来指定未经身份验证的请求应重定向到的 STS。</span><span class="sxs-lookup"><span data-stu-id="46940-119">You configure the WS-FAM to specify the STS to which non-authenticated requests should be redirected.</span></span> <span data-ttu-id="46940-120">使用 WIF，可采用两种方式对用户进行身份验证：</span><span class="sxs-lookup"><span data-stu-id="46940-120">WIF lets you authenticate a user in two ways:</span></span>  
  
1. <span data-ttu-id="46940-121">被动重定向：当未经身份验证的用户尝试访问受保护的资源，并且想要将它们重定向到 STS 而无需登录页时，这是正确的方法。</span><span class="sxs-lookup"><span data-stu-id="46940-121">Passive redirect: When an unauthenticated user tries to access a protected resource, and you want to simply redirect them to an STS without requiring a login page, then this is the right approach.</span></span> <span data-ttu-id="46940-122">STS 验证用户标识，并颁发包含适合该用户的声明的安全令牌。</span><span class="sxs-lookup"><span data-stu-id="46940-122">The STS verifies the user’s identity, and issues a security token that contains the appropriate claims for that user.</span></span> <span data-ttu-id="46940-123">此选项需要将 WS-FAM 添加到 HTTP 模块管道。</span><span class="sxs-lookup"><span data-stu-id="46940-123">This option requires the WS-FAM to be added in the HTTP Modules pipeline.</span></span> <span data-ttu-id="46940-124">可以使用用于 Visual Studio 2012 的标识和访问工具修改应用程序配置文件，以便使用 WS FAM 以及与 STS 联合。</span><span class="sxs-lookup"><span data-stu-id="46940-124">You can use the Identity and Access Tool for Visual Studio 2012 to modify your application’s configuration file to use the WS-FAM and to federate with an STS.</span></span> <span data-ttu-id="46940-125">有关详细信息，请参阅[用于 Visual Studio 2012 的标识和访问工具](../../../docs/framework/security/identity-and-access-tool-for-vs.md)。</span><span class="sxs-lookup"><span data-stu-id="46940-125">For more information, see [Identity and Access Tool for Visual Studio 2012](../../../docs/framework/security/identity-and-access-tool-for-vs.md).</span></span>  
  
2. <span data-ttu-id="46940-126">对于信赖方应用程序中的登录页，可以从代码隐藏调用 <xref:System.IdentityModel.Services.WSFederationAuthenticationModule.SignIn%2A?displayProperty=nameWithType> 方法或 <xref:System.IdentityModel.Services.WSFederationAuthenticationModule.RedirectToIdentityProvider%2A> 方法。</span><span class="sxs-lookup"><span data-stu-id="46940-126">You can call the <xref:System.IdentityModel.Services.WSFederationAuthenticationModule.SignIn%2A?displayProperty=nameWithType> method or the <xref:System.IdentityModel.Services.WSFederationAuthenticationModule.RedirectToIdentityProvider%2A> method from the code-behind for a sign-in page in your RP application.</span></span>  
  
 <span data-ttu-id="46940-127">在被动重定向中，所有通信通过来自客户端（通常为浏览器）的响应/重定向执行。</span><span class="sxs-lookup"><span data-stu-id="46940-127">In passive redirect, all communication is performed through response/redirect from the client (typically a browser).</span></span> <span data-ttu-id="46940-128">可将 WS-FAM 添加到应用程序的 HTTP 管道，它将在管道中监视未经身份验证的用户请求并将用户重定向到指定的 STS。</span><span class="sxs-lookup"><span data-stu-id="46940-128">You can add the WS-FAM to your application’s HTTP pipeline, where it watches for unauthenticated user requests and redirects users to the STS you specify.</span></span>  
  
 <span data-ttu-id="46940-129">WS-FAM 也会引发几个事件，可以通过这些事件在 [!INCLUDE[vstecasp](../../../includes/vstecasp-md.md)] 应用程序中自定义它的功能。</span><span class="sxs-lookup"><span data-stu-id="46940-129">The WS-FAM also raises several events that let you customize its functionality in an [!INCLUDE[vstecasp](../../../includes/vstecasp-md.md)] application.</span></span>  
  
### <a name="how-the-ws-fam-works"></a><span data-ttu-id="46940-130">WS-FAM 的工作原理</span><span class="sxs-lookup"><span data-stu-id="46940-130">How the WS-FAM Works</span></span>  
 <span data-ttu-id="46940-131">WS-FAM 在 <xref:System.IdentityModel.Services.WSFederationAuthenticationModule> 类中实现。</span><span class="sxs-lookup"><span data-stu-id="46940-131">The WS-FAM is implemented in the <xref:System.IdentityModel.Services.WSFederationAuthenticationModule> class.</span></span> <span data-ttu-id="46940-132">通常情况下，将 WS-FAM 添加到 [!INCLUDE[vstecasp](../../../includes/vstecasp-md.md)] 信赖方应用的 HTTP 管道。</span><span class="sxs-lookup"><span data-stu-id="46940-132">Typically, you add the WS-FAM to the HTTP pipeline of your [!INCLUDE[vstecasp](../../../includes/vstecasp-md.md)] RP application.</span></span> <span data-ttu-id="46940-133">未经身份验证的用户尝试访问受保护资源时，RP 将返回 HTTP 响应“401 拒绝授权”。</span><span class="sxs-lookup"><span data-stu-id="46940-133">When an unauthenticated user tries to access a protected resource, the RP returns a "401 authorization denied" HTTP response.</span></span> <span data-ttu-id="46940-134">WS-FAM 截获此响应，而不是让客户端接收它，然后将用户重定向到指定的 STS。</span><span class="sxs-lookup"><span data-stu-id="46940-134">The WS-FAM intercepts this response instead of allowing the client to receive it, then it redirects the user to the specified STS.</span></span> <span data-ttu-id="46940-135">STS 颁发安全令牌，WS-FAM 再次将其截获。</span><span class="sxs-lookup"><span data-stu-id="46940-135">The STS issues a security token, which the WS-FAM again intercepts.</span></span> <span data-ttu-id="46940-136">WS-FAM 使用该令牌创建的实例<xref:System.Security.Claims.ClaimsPrincipal>身份验证的用户，这使正则.NET Framework 授权机制得以运行。</span><span class="sxs-lookup"><span data-stu-id="46940-136">The WS-FAM uses the token to create an instance of <xref:System.Security.Claims.ClaimsPrincipal> for the authenticated user, which enables regular .NET Framework authorization mechanisms to function.</span></span>  
  
 <span data-ttu-id="46940-137">因为 HTTP 无状态，所以需要一种方法来避免在每次用户尝试访问另一个受保护资源时重复上述过程。</span><span class="sxs-lookup"><span data-stu-id="46940-137">Because HTTP is stateless, we need a way to avoid repeating this whole process every time that the user tries to access another protected resource.</span></span> <span data-ttu-id="46940-138">这时 <xref:System.IdentityModel.Services.SessionAuthenticationModule> 便可派上用场。</span><span class="sxs-lookup"><span data-stu-id="46940-138">This is where the <xref:System.IdentityModel.Services.SessionAuthenticationModule> comes in.</span></span> <span data-ttu-id="46940-139">当 STS 向用户颁发安全令牌时，<xref:System.IdentityModel.Services.SessionAuthenticationModule> 也会为该用户创建会话安全令牌并将其放置于 Cookie 中。</span><span class="sxs-lookup"><span data-stu-id="46940-139">When the STS issues a security token for the user, <xref:System.IdentityModel.Services.SessionAuthenticationModule> also creates a session security token for the user and puts it in a cookie.</span></span> <span data-ttu-id="46940-140">在后续请求中，<xref:System.IdentityModel.Services.SessionAuthenticationModule> 将截获此 Cookie 并使用它来重新构造用户的 <xref:System.Security.Claims.ClaimsPrincipal>。</span><span class="sxs-lookup"><span data-stu-id="46940-140">On subsequent requests, the <xref:System.IdentityModel.Services.SessionAuthenticationModule> intercepts this cookie and uses it to reconstruct the user’s <xref:System.Security.Claims.ClaimsPrincipal>.</span></span>  
  
 <span data-ttu-id="46940-141">下方的关系图展示了被动重定向事例中整体信息流。</span><span class="sxs-lookup"><span data-stu-id="46940-141">The following diagram shows the overall flow of information in the passive redirect case.</span></span> <span data-ttu-id="46940-142">通过 STS 自动重定向请求，无需登录页便可建立凭据：</span><span class="sxs-lookup"><span data-stu-id="46940-142">The request is automatically redirected via the STS to establish credentials without a login page:</span></span>  
  
 ![使用被动重定向的登录中显示的关系图。](./media/wsfederation-authentication-module-overview/sign-in-using-passive-redirect.gif)  
  
 <span data-ttu-id="46940-144">下方的关系图展示了用户经过身份验证访问 STS 且由 <xref:System.IdentityModel.Services.WSFederationAuthenticationModule> 处理其安全令牌后的更多详细信息：</span><span class="sxs-lookup"><span data-stu-id="46940-144">The following diagram shows more detail on what happens when the user has authenticated to the STS and their security tokens are processed by the <xref:System.IdentityModel.Services.WSFederationAuthenticationModule>:</span></span>  
  
 <span data-ttu-id="46940-145">![使用被动重定向处理令牌的时序](../../../docs/framework/security/media/signinusingpassiveredirect-tokenprocessing.gif "SignInUsingPassiveRedirect_TokenProcessing")</span><span class="sxs-lookup"><span data-stu-id="46940-145">![Timing for token processing with passive redirect](../../../docs/framework/security/media/signinusingpassiveredirect-tokenprocessing.gif "SignInUsingPassiveRedirect_TokenProcessing")</span></span>  
  
 <span data-ttu-id="46940-146">下方的关系图展示了将用户的安全令牌串行化成 Cookie 并由 <xref:System.IdentityModel.Services.SessionAuthenticationModule> 截获后的更多详细信息：</span><span class="sxs-lookup"><span data-stu-id="46940-146">The following diagram shows more detail on what happens when the user’s security tokens have been serialized into cookies and are intercepted by the <xref:System.IdentityModel.Services.SessionAuthenticationModule>:</span></span>  
  
 <span data-ttu-id="46940-147">![显示使用控件登录的 SAM 时序图](../../../docs/framework/security/media/signinusingconrols-sam.gif "SignInUsingConrols_SAM")</span><span class="sxs-lookup"><span data-stu-id="46940-147">![SAM timing diagram showing sign&#45;in using controls](../../../docs/framework/security/media/signinusingconrols-sam.gif "SignInUsingConrols_SAM")</span></span>  
  
### <a name="events"></a><span data-ttu-id="46940-148">事件</span><span class="sxs-lookup"><span data-stu-id="46940-148">Events</span></span>  
 <span data-ttu-id="46940-149"><xref:System.IdentityModel.Services.WSFederationAuthenticationModule>、<xref:System.IdentityModel.Services.SessionAuthenticationModule> 和它们的父类 <xref:System.IdentityModel.Services.HttpModuleBase> 在处理 HTTP 请求的各个阶段引发事件。</span><span class="sxs-lookup"><span data-stu-id="46940-149"><xref:System.IdentityModel.Services.WSFederationAuthenticationModule>, <xref:System.IdentityModel.Services.SessionAuthenticationModule>, and their parent class, <xref:System.IdentityModel.Services.HttpModuleBase>, raise events at various stages of processing of an HTTP request.</span></span> <span data-ttu-id="46940-150">可以在 [!INCLUDE[vstecasp](../../../includes/vstecasp-md.md)] 应用程序的 `global.asax` 文件中处理这些事件。</span><span class="sxs-lookup"><span data-stu-id="46940-150">You can handle these events in the `global.asax` file of your [!INCLUDE[vstecasp](../../../includes/vstecasp-md.md)] application.</span></span>  
  
- <span data-ttu-id="46940-151">ASP.NET 基础结构调用模块的 <xref:System.IdentityModel.Services.HttpModuleBase.Init%2A> 方法来初始化模块。</span><span class="sxs-lookup"><span data-stu-id="46940-151">The ASP.NET infrastructure invokes the module’s <xref:System.IdentityModel.Services.HttpModuleBase.Init%2A> method to initialize the module.</span></span>  
  
- <span data-ttu-id="46940-152">ASP.NET 基础结构首次在派生于 <xref:System.IdentityModel.Services.HttpModuleBase> 的某个应用程序模块上调用 <xref:System.IdentityModel.Services.HttpModuleBase.Init%2A> 方法时将引发 <xref:System.IdentityModel.Services.FederatedAuthentication.FederationConfigurationCreated?displayProperty=nameWithType> 事件。</span><span class="sxs-lookup"><span data-stu-id="46940-152">The <xref:System.IdentityModel.Services.FederatedAuthentication.FederationConfigurationCreated?displayProperty=nameWithType> event is raised when the ASP.NET infrastructure invokes the <xref:System.IdentityModel.Services.HttpModuleBase.Init%2A> method for the first time on one of the application’s modules that derive from <xref:System.IdentityModel.Services.HttpModuleBase>.</span></span> <span data-ttu-id="46940-153">此方法访问静态 <xref:System.IdentityModel.Services.FederatedAuthentication.FederationConfiguration%2A?displayProperty=nameWithType> 属性，导致从 Web.config 文件加载配置。</span><span class="sxs-lookup"><span data-stu-id="46940-153">This method accesses the static <xref:System.IdentityModel.Services.FederatedAuthentication.FederationConfiguration%2A?displayProperty=nameWithType> property, which causes configuration to be loaded from the Web.config file.</span></span> <span data-ttu-id="46940-154">仅在首次访问此属性时引发该事件。</span><span class="sxs-lookup"><span data-stu-id="46940-154">This event is only raised the first time this property is accessed.</span></span> <span data-ttu-id="46940-155">可以通过事件处理程序中的 <xref:System.IdentityModel.Services.Configuration.FederationConfigurationCreatedEventArgs.FederationConfiguration%2A?displayProperty=nameWithType> 属性访问从配置中初始化的 <xref:System.IdentityModel.Services.Configuration.FederationConfiguration> 对象。</span><span class="sxs-lookup"><span data-stu-id="46940-155">The <xref:System.IdentityModel.Services.Configuration.FederationConfiguration> object that is initialized from configuration can be accessed through the <xref:System.IdentityModel.Services.Configuration.FederationConfigurationCreatedEventArgs.FederationConfiguration%2A?displayProperty=nameWithType> property in an event handler.</span></span> <span data-ttu-id="46940-156">可以在将配置应用到任何模块前使用此事件修改配置。</span><span class="sxs-lookup"><span data-stu-id="46940-156">You can use this event to modify the configuration before it is applied to any modules.</span></span> <span data-ttu-id="46940-157">可以在 Application_Start 方法中为此事件添加处理程序：</span><span class="sxs-lookup"><span data-stu-id="46940-157">You can add a handler for this event in the Application_Start method:</span></span>  
  
    ```  
    void Application_Start(object sender, EventArgs e)  
    {  
        FederatedAuthentication.FederationConfigurationCreated += new EventHandler<FederationConfigurationCreatedEventArgs>(FederatedAuthentication_FederationConfigurationCreated);  
    }  
    ```  
  
     <span data-ttu-id="46940-158">每个模块替代 <xref:System.IdentityModel.Services.HttpModuleBase.InitializeModule%2A?displayProperty=nameWithType> 和 <xref:System.IdentityModel.Services.HttpModuleBase.InitializePropertiesFromConfiguration%2A?displayProperty=nameWithType> 抽象方法。</span><span class="sxs-lookup"><span data-stu-id="46940-158">Each module overrides the <xref:System.IdentityModel.Services.HttpModuleBase.InitializeModule%2A?displayProperty=nameWithType> and <xref:System.IdentityModel.Services.HttpModuleBase.InitializePropertiesFromConfiguration%2A?displayProperty=nameWithType> abstract methods.</span></span> <span data-ttu-id="46940-159">第一种方法为与模块相关的 ASP.NET 管道事件添加处理程序。</span><span class="sxs-lookup"><span data-stu-id="46940-159">The first of these methods adds handlers for ASP.NET pipeline events that are of interest to the module.</span></span> <span data-ttu-id="46940-160">大多数情况下，模块的默认实现便已足够。</span><span class="sxs-lookup"><span data-stu-id="46940-160">In most cases the module’s default implementation will suffice.</span></span> <span data-ttu-id="46940-161">第二种方法从模块的 <xref:System.IdentityModel.Services.HttpModuleBase.FederationConfiguration%2A?displayProperty=nameWithType> 属性初始化其各个属性。</span><span class="sxs-lookup"><span data-stu-id="46940-161">The second of these methods initializes the module’s properties from its <xref:System.IdentityModel.Services.HttpModuleBase.FederationConfiguration%2A?displayProperty=nameWithType> property.</span></span> <span data-ttu-id="46940-162">（这是之前加载的配置的副本。）如果要支持从派生自 <xref:System.IdentityModel.Services.WSFederationAuthenticationModule> 或 <xref:System.IdentityModel.Services.SessionAuthenticationModule> 的类中的配置初始化新属性，则需要替代第二种方法。</span><span class="sxs-lookup"><span data-stu-id="46940-162">(This is a copy of the configuration that was loaded previously.) You may need to override this second method if you want to support the initialization of new properties from configuration in classes that you derive from <xref:System.IdentityModel.Services.WSFederationAuthenticationModule> or <xref:System.IdentityModel.Services.SessionAuthenticationModule>.</span></span> <span data-ttu-id="46940-163">在此情况下，也需要从相应的配置对象进行派生，从而支持添加的配置属性；例如，从 <xref:System.IdentityModel.Configuration.IdentityConfiguration>、<xref:System.IdentityModel.Services.Configuration.WsFederationConfiguration> 或 <xref:System.IdentityModel.Services.Configuration.FederationConfiguration> 派生。</span><span class="sxs-lookup"><span data-stu-id="46940-163">In such cases you would also need to derive from the appropriate configuration objects to support the added configuration properties; for example, from <xref:System.IdentityModel.Configuration.IdentityConfiguration>, <xref:System.IdentityModel.Services.Configuration.WsFederationConfiguration>, or <xref:System.IdentityModel.Services.Configuration.FederationConfiguration>.</span></span>  
  
- <span data-ttu-id="46940-164">WS-FAM 截获由 STS 颁发的安全令牌时引发 <xref:System.IdentityModel.Services.WSFederationAuthenticationModule.SecurityTokenReceived> 事件。</span><span class="sxs-lookup"><span data-stu-id="46940-164">The WS-FAM raises the <xref:System.IdentityModel.Services.WSFederationAuthenticationModule.SecurityTokenReceived> event when it intercepts a security token that has been issued by the STS.</span></span>  
  
- <span data-ttu-id="46940-165">WS-FAM 在验证令牌后引发 <xref:System.IdentityModel.Services.WSFederationAuthenticationModule.SecurityTokenValidated> 事件。</span><span class="sxs-lookup"><span data-stu-id="46940-165">The WS-FAM raises the <xref:System.IdentityModel.Services.WSFederationAuthenticationModule.SecurityTokenValidated> event after it has validated the token.</span></span>  
  
- <span data-ttu-id="46940-166"><xref:System.IdentityModel.Services.SessionAuthenticationModule> 在为用户创建会话安全令牌时，引发 <xref:System.IdentityModel.Services.SessionAuthenticationModule.SessionSecurityTokenCreated> 事件。</span><span class="sxs-lookup"><span data-stu-id="46940-166">The <xref:System.IdentityModel.Services.SessionAuthenticationModule> raises the <xref:System.IdentityModel.Services.SessionAuthenticationModule.SessionSecurityTokenCreated> event when it creates a session security token for the user.</span></span>  
  
- <span data-ttu-id="46940-167"><xref:System.IdentityModel.Services.SessionAuthenticationModule> 使用包含会话安全令牌的 Cookie 截获后续请求时，引发 <xref:System.IdentityModel.Services.SessionAuthenticationModule.SessionSecurityTokenReceived> 事件。</span><span class="sxs-lookup"><span data-stu-id="46940-167">The <xref:System.IdentityModel.Services.SessionAuthenticationModule> raises the <xref:System.IdentityModel.Services.SessionAuthenticationModule.SessionSecurityTokenReceived> event when it intercepts subsequent requests with the cookie that contains the session security token.</span></span>  
  
- <span data-ttu-id="46940-168">在 WS-FAM 将用户重定向到颁发者之前引发 <xref:System.IdentityModel.Services.WSFederationAuthenticationModule.RedirectingToIdentityProvider> 事件。</span><span class="sxs-lookup"><span data-stu-id="46940-168">Before the WS-FAM redirects the user to the issuer, it raises the <xref:System.IdentityModel.Services.WSFederationAuthenticationModule.RedirectingToIdentityProvider> event.</span></span> <span data-ttu-id="46940-169">事件中传递的 <xref:System.IdentityModel.Services.RedirectingToIdentityProviderEventArgs> 的 <xref:System.IdentityModel.Services.RedirectingToIdentityProviderEventArgs.SignInRequestMessage%2A> 属性提供 WS 联合身份验证登录请求。</span><span class="sxs-lookup"><span data-stu-id="46940-169">The WS-Federation sign-in request is available through the <xref:System.IdentityModel.Services.RedirectingToIdentityProviderEventArgs.SignInRequestMessage%2A> property of the <xref:System.IdentityModel.Services.RedirectingToIdentityProviderEventArgs> passed in the event.</span></span> <span data-ttu-id="46940-170">可选择在将请求发送到颁发者之前修改请求。</span><span class="sxs-lookup"><span data-stu-id="46940-170">You may choose to modify the request before sending this out to the issuer.</span></span>  
  
- <span data-ttu-id="46940-171">成功写入 Cookie 且用户登录后，WS-FAM 引发 <xref:System.IdentityModel.Services.WSFederationAuthenticationModule.SignedIn> 事件。</span><span class="sxs-lookup"><span data-stu-id="46940-171">The WS-FAM raises the <xref:System.IdentityModel.Services.WSFederationAuthenticationModule.SignedIn> event when the cookie is successfully written and the user is signed in.</span></span>  
  
- <span data-ttu-id="46940-172">为每个用户关闭会话时，WS FAM 将对每个会话引发一次 <xref:System.IdentityModel.Services.WSFederationAuthenticationModule.SigningOut> 事件。</span><span class="sxs-lookup"><span data-stu-id="46940-172">The WS-FAM raises the <xref:System.IdentityModel.Services.WSFederationAuthenticationModule.SigningOut> event one time per session as the session is being closed down for each user.</span></span> <span data-ttu-id="46940-173">如果在客户端上关闭会话（例如，通过删除会话 Cookie 的方式），则不会引发该事件。</span><span class="sxs-lookup"><span data-stu-id="46940-173">It is not raised if the session is closed down on the client-side (for example, by deleting the session cookie).</span></span> <span data-ttu-id="46940-174">在 SSO 环境中，IP-STS 也可以请求每个 RP 注销。</span><span class="sxs-lookup"><span data-stu-id="46940-174">In an SSO environment, the IP-STS can request each RP to sign out, too.</span></span> <span data-ttu-id="46940-175">这也将引发此事件，这时 <xref:System.IdentityModel.Services.SigningOutEventArgs.IsIPInitiated%2A> 设置为 `true`。</span><span class="sxs-lookup"><span data-stu-id="46940-175">This will also raise this event, with <xref:System.IdentityModel.Services.SigningOutEventArgs.IsIPInitiated%2A> set to `true`.</span></span>  
  
> [!NOTE]
>  <span data-ttu-id="46940-176">不应在由 <xref:System.IdentityModel.Services.WSFederationAuthenticationModule> 或 <xref:System.IdentityModel.Services.SessionAuthenticationModule> 引发的任何事件期间使用 <xref:System.Threading.Thread.CurrentPrincipal%2A?displayProperty=nameWithType> 属性。</span><span class="sxs-lookup"><span data-stu-id="46940-176">You should not use the <xref:System.Threading.Thread.CurrentPrincipal%2A?displayProperty=nameWithType> property during any event raised by <xref:System.IdentityModel.Services.WSFederationAuthenticationModule> or <xref:System.IdentityModel.Services.SessionAuthenticationModule>.</span></span> <span data-ttu-id="46940-177">这是因为 <xref:System.Threading.Thread.CurrentPrincipal%2A?displayProperty=nameWithType> 是在身份验证进程后设置的，而事件是在身份验证进程中引发的。</span><span class="sxs-lookup"><span data-stu-id="46940-177">This is because <xref:System.Threading.Thread.CurrentPrincipal%2A?displayProperty=nameWithType> is set after the authentication process, while events are raised during the authentication process.</span></span>  
  
### <a name="configuration-of-federated-authentication"></a><span data-ttu-id="46940-178">联合身份验证的配置</span><span class="sxs-lookup"><span data-stu-id="46940-178">Configuration of Federated Authentication</span></span>  
 <span data-ttu-id="46940-179">WS-FAM 和 SAM 通过 [\<federationConfiguration>](../../../docs/framework/configure-apps/file-schema/windows-identity-foundation/federationconfiguration.md) 元素进行配置。</span><span class="sxs-lookup"><span data-stu-id="46940-179">The WS-FAM and SAM are configured through the [\<federationConfiguration>](../../../docs/framework/configure-apps/file-schema/windows-identity-foundation/federationconfiguration.md) element.</span></span> <span data-ttu-id="46940-180">[\<wsFederation>](../../../docs/framework/configure-apps/file-schema/windows-identity-foundation/wsfederation.md) 子元素配置 WS-FAM 属性的默认值；例如 <xref:System.IdentityModel.Services.WSFederationAuthenticationModule.Issuer%2A> 属性和 <xref:System.IdentityModel.Services.WSFederationAuthenticationModule.Realm%2A> 属性。</span><span class="sxs-lookup"><span data-stu-id="46940-180">The [\<wsFederation>](../../../docs/framework/configure-apps/file-schema/windows-identity-foundation/wsfederation.md) child element configures default values for the WS-FAM properties; such as the <xref:System.IdentityModel.Services.WSFederationAuthenticationModule.Issuer%2A> property and the <xref:System.IdentityModel.Services.WSFederationAuthenticationModule.Realm%2A> property.</span></span> <span data-ttu-id="46940-181">（可以通过为一些 WS-FAM 事件提供处理程序来按请求更改这些值；例如 <xref:System.IdentityModel.Services.WSFederationAuthenticationModule.RedirectingToIdentityProvider>。）由 SAM 使用的 Cookie 处理程序通过 [\<cookieHandler>](../../../docs/framework/configure-apps/file-schema/windows-identity-foundation/cookiehandler.md) 子元素进行配置。</span><span class="sxs-lookup"><span data-stu-id="46940-181">(These values can be changed on a per request basis by providing handlers for some of the WS-FAM events; for example, <xref:System.IdentityModel.Services.WSFederationAuthenticationModule.RedirectingToIdentityProvider>.) The cookie handler that is used by the SAM is configured through the [\<cookieHandler>](../../../docs/framework/configure-apps/file-schema/windows-identity-foundation/cookiehandler.md) child element.</span></span> <span data-ttu-id="46940-182">WIF 提供在 <xref:System.IdentityModel.Services.ChunkedCookieHandler> 类中实现的默认 Cookie 处理程序，可以通过 [\<chunkedCookieHandler>](../../../docs/framework/configure-apps/file-schema/windows-identity-foundation/chunkedcookiehandler.md) 元素设置该处理程序的区块大小。</span><span class="sxs-lookup"><span data-stu-id="46940-182">WIF provides a default cookie handler implemented in the <xref:System.IdentityModel.Services.ChunkedCookieHandler> class that can have its chunk size set through the [\<chunkedCookieHandler>](../../../docs/framework/configure-apps/file-schema/windows-identity-foundation/chunkedcookiehandler.md) element.</span></span> <span data-ttu-id="46940-183">`<federationConfiguration>` 元素引用 <xref:System.IdentityModel.Configuration.IdentityConfiguration>，为在应用程序中使用的其他 WIF 组件提供配置，如 <xref:System.Security.Claims.ClaimsAuthenticationManager> 和 <xref:System.Security.Claims.ClaimsAuthorizationManager>。</span><span class="sxs-lookup"><span data-stu-id="46940-183">The `<federationConfiguration>` element references an <xref:System.IdentityModel.Configuration.IdentityConfiguration>, which provides configuration for other WIF components used in the application, such as the <xref:System.Security.Claims.ClaimsAuthenticationManager> and the <xref:System.Security.Claims.ClaimsAuthorizationManager>.</span></span> <span data-ttu-id="46940-184">可以通过指定 `<federationConfiguration>` 元素的 `identityConfigurationName` 属性中名为 [\<identityConfiguration>](../../../docs/framework/configure-apps/file-schema/windows-identity-foundation/identityconfiguration.md) 的元素显式引用标识配置。</span><span class="sxs-lookup"><span data-stu-id="46940-184">The identity configuration may be referenced explicitly by specifying a named [\<identityConfiguration>](../../../docs/framework/configure-apps/file-schema/windows-identity-foundation/identityconfiguration.md) element in the `identityConfigurationName` attribute of the `<federationConfiguration>` element.</span></span> <span data-ttu-id="46940-185">如果未显式引用标识配置，则将使用默认标识配置。</span><span class="sxs-lookup"><span data-stu-id="46940-185">If the identity configuration is not referenced explicitly, the default identity configuration will be used.</span></span>  
  
 <span data-ttu-id="46940-186">以下 XML 演示 ASP.NET 信赖方 (RP) 应用的配置。</span><span class="sxs-lookup"><span data-stu-id="46940-186">The following XML shows a configuration of an ASP.NET relying party (RP) application.</span></span> <span data-ttu-id="46940-187"><xref:System.IdentityModel.Configuration.SystemIdentityModelSection> 和 <xref:System.IdentityModel.Services.Configuration.SystemIdentityModelServicesSection> 配置部分添加在 `<configSections>` 元素之下。</span><span class="sxs-lookup"><span data-stu-id="46940-187">The <xref:System.IdentityModel.Configuration.SystemIdentityModelSection> and <xref:System.IdentityModel.Services.Configuration.SystemIdentityModelServicesSection> configuration sections are added under the `<configSections>` element.</span></span> <span data-ttu-id="46940-188">SAM 和 WS-FAM 添加到 `<system.webServer>`/`<modules>` 元素下的 HTTP 模块。</span><span class="sxs-lookup"><span data-stu-id="46940-188">The SAM and WS-FAM are added to the HTTP Modules under the `<system.webServer>`/`<modules>` element.</span></span> <span data-ttu-id="46940-189">最后，WIF 组件在 `<system.identityModel>`/`<identityConfiguration>` 和 `<system.identityModel.services>`/`<federationConfiguration>` 元素下进行配置。</span><span class="sxs-lookup"><span data-stu-id="46940-189">Finally the WIF components are configured under the `<system.identityModel>`/`<identityConfiguration>` and `<system.identityModel.services>`/`<federationConfiguration>` elements.</span></span> <span data-ttu-id="46940-190">此配置指定分块 Cookie 处理程序（因为它是默认 Cookie 处理程序），且 `<cookieHandler>` 元素中没有指定的 Cookie 处理程序类型。</span><span class="sxs-lookup"><span data-stu-id="46940-190">This configuration specifies the chunked cookie handler as it is the default cookie handler and there is not a cookie handler type specified in the `<cookieHandler>` element.</span></span>  
  
> [!WARNING]
>  <span data-ttu-id="46940-191">在以下示例中，`<wsFederation>` 元素的 `requireHttps` 属性和 `<cookieHandler>` 元素的 `requireSsl` 属性皆为 `false`。</span><span class="sxs-lookup"><span data-stu-id="46940-191">In the following example, both the `requireHttps` attribute of the `<wsFederation>` element and the `requireSsl` attribute of the `<cookieHandler>` element are `false`.</span></span> <span data-ttu-id="46940-192">这表示潜在的安全威胁。</span><span class="sxs-lookup"><span data-stu-id="46940-192">This presents a potential security threat.</span></span> <span data-ttu-id="46940-193">在生产中，这两个值都应设置为 `true`。</span><span class="sxs-lookup"><span data-stu-id="46940-193">In production, both these values should be set `true`.</span></span>  
  
```xml  
<configuration>  
  <configSections>  
    <section name="system.identityModel" type="System.IdentityModel.Configuration.SystemIdentityModelSection, System.IdentityModel, Version=4.0.0.0, Culture=neutral, PublicKeyToken=B77A5C561934E089" />  
    <section name="system.identityModel.services" type="System.IdentityModel.Services.Configuration.SystemIdentityModelServicesSection, System.IdentityModel.Services, Version=4.0.0.0, Culture=neutral, PublicKeyToken=B77A5C561934E089" />  
  </configSections>  
  
  ...  
  
  <system.webServer>  
    <modules>  
      <add name="WSFederationAuthenticationModule" type="System.IdentityModel.Services.WSFederationAuthenticationModule, System.IdentityModel.Services, Version=4.0.0.0, Culture=neutral, PublicKeyToken=b77a5c561934e089" preCondition="managedHandler" />  
      <add name="SessionAuthenticationModule" type="System.IdentityModel.Services.SessionAuthenticationModule, System.IdentityModel.Services, Version=4.0.0.0, Culture=neutral, PublicKeyToken=b77a5c561934e089" preCondition="managedHandler" />  
    </modules>  
  </system.webServer>  
  
  <system.identityModel>  
    <identityConfiguration>  
      <audienceUris>  
        <add value="http://localhost:50969/" />  
      </audienceUris>  
      <certificateValidation certificateValidationMode="None" />  
      <issuerNameRegistry type="System.IdentityModel.Tokens.ConfigurationBasedIssuerNameRegistry, System.IdentityModel, Version=4.0.0.0, Culture=neutral, PublicKeyToken=b77a5c561934e089">  
        <trustedIssuers>  
          <add thumbprint="9B74CB2F320F7AAFC156E1252270B1DC01EF40D0" name="LocalSTS" />  
        </trustedIssuers>  
      </issuerNameRegistry>  
    </identityConfiguration>  
  </system.identityModel>  
  <system.identityModel.services>  
    <federationConfiguration>  
      <wsFederation passiveRedirectEnabled="true" issuer="http://localhost:15839/wsFederationSTS/Issue" realm="http://localhost:50969/" reply="http://localhost:50969/" requireHttps="false" />  
      <cookieHandler requireSsl="false" />  
    </federationConfiguration>  
  </system.identityModel.services>  
</configuration>  
```  
  
## <a name="see-also"></a><span data-ttu-id="46940-194">请参阅</span><span class="sxs-lookup"><span data-stu-id="46940-194">See also</span></span>

- <xref:System.IdentityModel.Services.SessionAuthenticationModule>
- <xref:System.IdentityModel.Services.WSFederationAuthenticationModule>
- [<span data-ttu-id="46940-195">\<federationConfiguration></span><span class="sxs-lookup"><span data-stu-id="46940-195">\<federationConfiguration></span></span>](../../../docs/framework/configure-apps/file-schema/windows-identity-foundation/federationconfiguration.md)
