---
title: 如何：创建自定义令牌
ms.date: 03/30/2017
dev_langs:
- csharp
- vb
helpviewer_keywords:
- SecurityTokenParameters class
- security [WCF], creating custom tokens
- WSSecurityTokenSerializer class
- SecurityToken class
ms.assetid: 6d892973-1558-4115-a9e1-696777776125
ms.openlocfilehash: 3bd44d197a655b67253ff363ef15937d4c021e08
ms.sourcegitcommit: d2e1dfa7ef2d4e9ffae3d431cf6a4ffd9c8d378f
ms.translationtype: MT
ms.contentlocale: zh-CN
ms.lasthandoff: 09/07/2019
ms.locfileid: "70797053"
---
# <a name="how-to-create-a-custom-token"></a><span data-ttu-id="e29dc-102">如何：创建自定义令牌</span><span class="sxs-lookup"><span data-stu-id="e29dc-102">How to: Create a Custom Token</span></span>
<span data-ttu-id="e29dc-103">本主题介绍如何使用 <xref:System.IdentityModel.Tokens.SecurityToken> 类创建自定义安全令牌，以及如何将其与自定义安全令牌提供程序和身份验证器进行集成。</span><span class="sxs-lookup"><span data-stu-id="e29dc-103">This topic shows how to create a custom security token using the <xref:System.IdentityModel.Tokens.SecurityToken> class, and how to integrate it with a custom security token provider and authenticator.</span></span> <span data-ttu-id="e29dc-104">有关完整的代码示例，请参阅[自定义令牌](../samples/custom-token.md)示例。</span><span class="sxs-lookup"><span data-stu-id="e29dc-104">For a complete code example see the [Custom Token](../samples/custom-token.md) sample.</span></span>  
  
 <span data-ttu-id="e29dc-105">*安全令牌*实质上是一个 XML 元素，WINDOWS COMMUNICATION FOUNDATION （WCF）安全框架使用它来表示有关 SOAP 消息内的发送方的声明。</span><span class="sxs-lookup"><span data-stu-id="e29dc-105">A *security token* is essentially an XML element that is used by the Windows Communication Foundation (WCF) security framework to represent claims about a sender inside the SOAP message.</span></span> <span data-ttu-id="e29dc-106">WCF 安全为系统提供的身份验证模式提供各种令牌。</span><span class="sxs-lookup"><span data-stu-id="e29dc-106">WCF security provides various tokens for system-provided authentication modes.</span></span> <span data-ttu-id="e29dc-107">包括由 <xref:System.IdentityModel.Tokens.X509SecurityToken> 类表示的 X.509 证书安全令牌，或由 <xref:System.IdentityModel.Tokens.UserNameSecurityToken> 类表示的用户名安全令牌。</span><span class="sxs-lookup"><span data-stu-id="e29dc-107">Examples include an X.509 certificate security token represented by the <xref:System.IdentityModel.Tokens.X509SecurityToken> class or a Username security token represented by the <xref:System.IdentityModel.Tokens.UserNameSecurityToken> class.</span></span>  
  
 <span data-ttu-id="e29dc-108">有时，所提供的类型不支持某种身份验证模式或凭据。</span><span class="sxs-lookup"><span data-stu-id="e29dc-108">Sometimes an authentication mode or credential is not supported by the provided types.</span></span> <span data-ttu-id="e29dc-109">这种情况下，必须创建自定义安全令牌来提供 SOAP 消息内部自定义凭据的 XML 表示形式。</span><span class="sxs-lookup"><span data-stu-id="e29dc-109">In that case, it is necessary to create a custom security token to provide an XML representation of the custom credential inside the SOAP message.</span></span>  
  
 <span data-ttu-id="e29dc-110">下面的过程演示如何创建自定义安全令牌，以及如何将其与 WCF 安全基础结构集成。</span><span class="sxs-lookup"><span data-stu-id="e29dc-110">The following procedures show how to create a custom security token and how to integrate it with the WCF security infrastructure.</span></span> <span data-ttu-id="e29dc-111">本主题创建一个信用卡令牌，用于将客户端的信用卡相关信息传递到服务器。</span><span class="sxs-lookup"><span data-stu-id="e29dc-111">This topic creates a credit card token that is used to pass information about the client's credit card to the server.</span></span>  
  
 <span data-ttu-id="e29dc-112">有关自定义凭据和安全令牌管理器的详细信息[，请参阅演练：创建自定义客户端和](walkthrough-creating-custom-client-and-service-credentials.md)服务凭据。</span><span class="sxs-lookup"><span data-stu-id="e29dc-112">For more information about custom credentials and security token manager, see [Walkthrough: Creating Custom Client and Service Credentials](walkthrough-creating-custom-client-and-service-credentials.md).</span></span>  
  
 <span data-ttu-id="e29dc-113">若要了解更多表示安全令牌的类，请参见 <xref:System.IdentityModel.Tokens> 命名空间。</span><span class="sxs-lookup"><span data-stu-id="e29dc-113">See the <xref:System.IdentityModel.Tokens> namespace for more classes that represent security tokens.</span></span>  
  
## <a name="procedures"></a><span data-ttu-id="e29dc-114">过程</span><span class="sxs-lookup"><span data-stu-id="e29dc-114">Procedures</span></span>  
 <span data-ttu-id="e29dc-115">客户端应用程序必须有一种方式来指定安全基础结构的信用卡信息。</span><span class="sxs-lookup"><span data-stu-id="e29dc-115">A client application must be provided with a way to specify credit card information for the security infrastructure.</span></span> <span data-ttu-id="e29dc-116">应用程序通过自定义客户端凭据类可访问此信息。</span><span class="sxs-lookup"><span data-stu-id="e29dc-116">This information is made available to the application by a custom client credentials class.</span></span> <span data-ttu-id="e29dc-117">第一步是创建一个类，用以表示自定义客户端凭据的信用卡信息。</span><span class="sxs-lookup"><span data-stu-id="e29dc-117">The first step is to create a class to represent the credit card information for custom client credentials.</span></span>  
  
#### <a name="to-create-a-class-that-represents-credit-card-information-inside-client-credentials"></a><span data-ttu-id="e29dc-118">创建一个表示客户端凭据内信用卡信息的类</span><span class="sxs-lookup"><span data-stu-id="e29dc-118">To create a class that represents credit card information inside client credentials</span></span>  
  
1. <span data-ttu-id="e29dc-119">定义一个新类，该类在应用程序中表示信用卡信息。</span><span class="sxs-lookup"><span data-stu-id="e29dc-119">Define a new class that represents the credit card information for the application.</span></span> <span data-ttu-id="e29dc-120">下面的示例将该类命名为 `CreditCardInfo`。</span><span class="sxs-lookup"><span data-stu-id="e29dc-120">The following example names the class `CreditCardInfo`.</span></span>  
  
2. <span data-ttu-id="e29dc-121">向类添加相应的属性，以便应用程序可以设置自定义令牌所需的必要信息。</span><span class="sxs-lookup"><span data-stu-id="e29dc-121">Add appropriate properties to the class to allow an application set the necessary information required for the custom token.</span></span> <span data-ttu-id="e29dc-122">在此示例中，该类具有三个属性：`CardNumber`、`CardIssuer` 和 `ExpirationDate`。</span><span class="sxs-lookup"><span data-stu-id="e29dc-122">In this example, the class has three properties: `CardNumber`, `CardIssuer`, and `ExpirationDate`.</span></span>  
  
     [!code-csharp[c_CustomToken#4](../../../../samples/snippets/csharp/VS_Snippets_CFX/c_customtoken/cs/source.cs#4)]
     [!code-vb[c_CustomToken#4](../../../../samples/snippets/visualbasic/VS_Snippets_CFX/c_customtoken/vb/source.vb#4)]  
  
 <span data-ttu-id="e29dc-123">接下来，必须创建一个表示自定义安全令牌的类。</span><span class="sxs-lookup"><span data-stu-id="e29dc-123">Next, a class that represents the custom security token must be created.</span></span> <span data-ttu-id="e29dc-124">安全令牌提供程序、身份验证器和序列化程序类使用此类将有关安全令牌的信息传递到 WCF 安全基础结构。</span><span class="sxs-lookup"><span data-stu-id="e29dc-124">This class is used by the security token provider, authenticator, and serializer classes to pass information about the security token to and from the WCF security infrastructure.</span></span>  
  
#### <a name="to-create-a-custom-security-token-class"></a><span data-ttu-id="e29dc-125">创建自定义安全令牌类</span><span class="sxs-lookup"><span data-stu-id="e29dc-125">To create a custom security token class</span></span>  
  
1. <span data-ttu-id="e29dc-126">定义一个从 <xref:System.IdentityModel.Tokens.SecurityToken> 类派生的新类。</span><span class="sxs-lookup"><span data-stu-id="e29dc-126">Define a new class derived from the <xref:System.IdentityModel.Tokens.SecurityToken> class.</span></span> <span data-ttu-id="e29dc-127">此示例创建一个名为 `CreditCardToken` 的类。</span><span class="sxs-lookup"><span data-stu-id="e29dc-127">This example creates a class named `CreditCardToken`.</span></span>  
  
2. <span data-ttu-id="e29dc-128">重写 <xref:System.IdentityModel.Tokens.SecurityToken.Id%2A> 属性。</span><span class="sxs-lookup"><span data-stu-id="e29dc-128">Override the <xref:System.IdentityModel.Tokens.SecurityToken.Id%2A> property.</span></span> <span data-ttu-id="e29dc-129">该属性用于获取安全令牌的本地标识符，本地标识符用于从 SOAP 消息内其他元素指向安全令牌 XML 表示形式。</span><span class="sxs-lookup"><span data-stu-id="e29dc-129">This property is used to get the local identifier of the security token that is used to point to the security token XML representation from other elements inside the SOAP message.</span></span> <span data-ttu-id="e29dc-130">在本示例中，令牌标识符可以作为构造函数参数传递给该属性，也可以在每次创建安全令牌实例时随机生成一个新的令牌标识符。</span><span class="sxs-lookup"><span data-stu-id="e29dc-130">In this example, a token identifier can be either passed to it as a constructor parameter or a new random one is generated every time a security token instance is created.</span></span>  
  
3. <span data-ttu-id="e29dc-131">实现 <xref:System.IdentityModel.Tokens.SecurityToken.SecurityKeys%2A> 属性。</span><span class="sxs-lookup"><span data-stu-id="e29dc-131">Implement the <xref:System.IdentityModel.Tokens.SecurityToken.SecurityKeys%2A> property.</span></span> <span data-ttu-id="e29dc-132">该属性返回一个安全密钥集合，这些密钥是安全令牌实例表示的。</span><span class="sxs-lookup"><span data-stu-id="e29dc-132">This property returns a collection of security keys that the security token instance represents.</span></span> <span data-ttu-id="e29dc-133">WCF 可以使用此类密钥对 SOAP 消息的部分进行签名或加密。</span><span class="sxs-lookup"><span data-stu-id="e29dc-133">Such keys can be used by WCF to sign or encrypt parts of the SOAP message.</span></span> <span data-ttu-id="e29dc-134">在本示例中，信用卡安全令牌不能包含任何安全密钥；因此，该实现始终返回一个空集合。</span><span class="sxs-lookup"><span data-stu-id="e29dc-134">In this example, the credit card security token cannot contain any security keys; therefore, the implementation always returns an empty collection.</span></span>  
  
4. <span data-ttu-id="e29dc-135">重写 <xref:System.IdentityModel.Tokens.SecurityToken.ValidFrom%2A> 和 <xref:System.IdentityModel.Tokens.SecurityToken.ValidTo%2A> 属性。</span><span class="sxs-lookup"><span data-stu-id="e29dc-135">Override the <xref:System.IdentityModel.Tokens.SecurityToken.ValidFrom%2A> and <xref:System.IdentityModel.Tokens.SecurityToken.ValidTo%2A> properties.</span></span> <span data-ttu-id="e29dc-136">WCF 使用这些属性来确定安全令牌实例的有效性。</span><span class="sxs-lookup"><span data-stu-id="e29dc-136">These properties are used by WCF to determine the validity of the security token instance.</span></span> <span data-ttu-id="e29dc-137">在本示例中，信用卡安全令牌只有到期日期，因此，`ValidFrom` 属性返回一个 <xref:System.DateTime>，它表示实例的创建日期和时间。</span><span class="sxs-lookup"><span data-stu-id="e29dc-137">In this example, the credit card security token has only an expiration date, so the `ValidFrom` property returns a <xref:System.DateTime> that represents the date and time of the instance creation.</span></span>  
  
     [!code-csharp[c_CustomToken#1](../../../../samples/snippets/csharp/VS_Snippets_CFX/c_customtoken/cs/source.cs#1)]
     [!code-vb[c_CustomToken#1](../../../../samples/snippets/visualbasic/VS_Snippets_CFX/c_customtoken/vb/source.vb#1)]  
  
 <span data-ttu-id="e29dc-138">在创建新的安全令牌类型时，需要实现 <xref:System.ServiceModel.Security.Tokens.SecurityTokenParameters> 类。</span><span class="sxs-lookup"><span data-stu-id="e29dc-138">When a new security token type is created, it requires an implementation of the <xref:System.ServiceModel.Security.Tokens.SecurityTokenParameters> class.</span></span> <span data-ttu-id="e29dc-139">该实现在安全绑定元素配置中用于表示新的令牌类型。</span><span class="sxs-lookup"><span data-stu-id="e29dc-139">The implementation is used in the security binding element configuration to represent the new token type.</span></span> <span data-ttu-id="e29dc-140">安全令牌参数类用作模板，用于在处理消息时与实际安全令牌实例进行匹配。</span><span class="sxs-lookup"><span data-stu-id="e29dc-140">The security token parameters class serves as a template that is used to match the actual security token instance to when a message is processed.</span></span> <span data-ttu-id="e29dc-141">该模板提供附加属性，应用程序可以使用这些附加属性来指定标准，安全令牌必须符合该标准才能使用或进行身份验证。</span><span class="sxs-lookup"><span data-stu-id="e29dc-141">The template provides additional properties that an application can use to specify criteria that the security token must match to be used or authenticated.</span></span> <span data-ttu-id="e29dc-142">下面的示例未添加任何其他属性，因此在 WCF 基础结构搜索要使用或验证的安全令牌实例时只匹配安全令牌类型。</span><span class="sxs-lookup"><span data-stu-id="e29dc-142">The following example does not add any additional properties, so only the security token type is matched when the WCF infrastructure searches for a security token instance to use or to validate.</span></span>  
  
#### <a name="to-create-a-custom-security-token-parameters-class"></a><span data-ttu-id="e29dc-143">创建自定义安全令牌参数类</span><span class="sxs-lookup"><span data-stu-id="e29dc-143">To create a custom security token parameters class</span></span>  
  
1. <span data-ttu-id="e29dc-144">定义一个从 <xref:System.ServiceModel.Security.Tokens.SecurityTokenParameters> 类派生的新类。</span><span class="sxs-lookup"><span data-stu-id="e29dc-144">Define a new class derived from the <xref:System.ServiceModel.Security.Tokens.SecurityTokenParameters> class.</span></span>  
  
2. <span data-ttu-id="e29dc-145">实现 <xref:System.ServiceModel.Security.Tokens.SecurityTokenParameters.CloneCore%2A> 方法。</span><span class="sxs-lookup"><span data-stu-id="e29dc-145">Implement the <xref:System.ServiceModel.Security.Tokens.SecurityTokenParameters.CloneCore%2A> method.</span></span> <span data-ttu-id="e29dc-146">复制类中定义的所有内部字段（如果有）。</span><span class="sxs-lookup"><span data-stu-id="e29dc-146">Copy all internal fields defined in your class, if any.</span></span> <span data-ttu-id="e29dc-147">此示例未定义任何附加字段。</span><span class="sxs-lookup"><span data-stu-id="e29dc-147">This example does not define any additional fields.</span></span>  
  
3. <span data-ttu-id="e29dc-148">实现 <xref:System.ServiceModel.Security.Tokens.SecurityTokenParameters.SupportsClientAuthentication%2A> 只读属性。</span><span class="sxs-lookup"><span data-stu-id="e29dc-148">Implement the <xref:System.ServiceModel.Security.Tokens.SecurityTokenParameters.SupportsClientAuthentication%2A> read-only property.</span></span> <span data-ttu-id="e29dc-149">如果该类表示的安全令牌类型可以用来向服务验证客户端身份，则该属性返回 `true`。</span><span class="sxs-lookup"><span data-stu-id="e29dc-149">This property returns `true` if the security token type represented by this class can be used to authenticate a client to a service.</span></span> <span data-ttu-id="e29dc-150">在本示例中，信用卡安全令牌可以用来向服务验证客户端身份。</span><span class="sxs-lookup"><span data-stu-id="e29dc-150">In this example, the credit card security token can be used to authenticate a client to a service.</span></span>  
  
4. <span data-ttu-id="e29dc-151">实现 <xref:System.ServiceModel.Security.Tokens.SecurityTokenParameters.SupportsServerAuthentication%2A> 只读属性。</span><span class="sxs-lookup"><span data-stu-id="e29dc-151">Implement the <xref:System.ServiceModel.Security.Tokens.SecurityTokenParameters.SupportsServerAuthentication%2A> read-only property.</span></span> <span data-ttu-id="e29dc-152">如果该类表示的安全令牌类型可以用来向客户端验证服务身份，则该属性返回 `true`。</span><span class="sxs-lookup"><span data-stu-id="e29dc-152">This property returns `true` if the security token type represented by this class can be used to authenticate a service to a client.</span></span> <span data-ttu-id="e29dc-153">在本示例中，信用卡安全令牌不能用来向客户端验证服务身份。</span><span class="sxs-lookup"><span data-stu-id="e29dc-153">In this example, the credit card security token cannot be used to authenticate a service to a client.</span></span>  
  
5. <span data-ttu-id="e29dc-154">实现 <xref:System.ServiceModel.Security.Tokens.SecurityTokenParameters.SupportsClientWindowsIdentity%2A> 只读属性。</span><span class="sxs-lookup"><span data-stu-id="e29dc-154">Implement the <xref:System.ServiceModel.Security.Tokens.SecurityTokenParameters.SupportsClientWindowsIdentity%2A> read-only property.</span></span> <span data-ttu-id="e29dc-155">如果该类表示的安全令牌类型可以映射到 Windows 帐户，则该属性返回 `true`。</span><span class="sxs-lookup"><span data-stu-id="e29dc-155">This property returns `true` if the security token type represented by this class can be mapped to a Windows account.</span></span> <span data-ttu-id="e29dc-156">这种情况下，身份验证结果由一个 <xref:System.Security.Principal.WindowsIdentity> 类实例表示。</span><span class="sxs-lookup"><span data-stu-id="e29dc-156">If so, the authentication result is represented by a <xref:System.Security.Principal.WindowsIdentity> class instance.</span></span> <span data-ttu-id="e29dc-157">在本示例中，令牌无法映射到 Windows 帐户。</span><span class="sxs-lookup"><span data-stu-id="e29dc-157">In this example, the token cannot be mapped to a Windows account.</span></span>  
  
6. <span data-ttu-id="e29dc-158">实现 <xref:System.ServiceModel.Security.Tokens.SecurityTokenParameters.CreateKeyIdentifierClause%28System.IdentityModel.Tokens.SecurityToken%2CSystem.ServiceModel.Security.Tokens.SecurityTokenReferenceStyle%29> 方法。</span><span class="sxs-lookup"><span data-stu-id="e29dc-158">Implement the <xref:System.ServiceModel.Security.Tokens.SecurityTokenParameters.CreateKeyIdentifierClause%28System.IdentityModel.Tokens.SecurityToken%2CSystem.ServiceModel.Security.Tokens.SecurityTokenReferenceStyle%29> method.</span></span> <span data-ttu-id="e29dc-159">此方法由 WCF 安全框架调用，要求引用此安全令牌参数类所表示的安全标记实例。</span><span class="sxs-lookup"><span data-stu-id="e29dc-159">This method is called by WCF security framework when it requires a reference to the security token instance represented by this security token parameters class.</span></span> <span data-ttu-id="e29dc-160">实际安全令牌实例和 <xref:System.ServiceModel.Security.Tokens.SecurityTokenReferenceStyle>（指定所请求的引用类型）都作为自变量传递到此方法。</span><span class="sxs-lookup"><span data-stu-id="e29dc-160">Both the actual security token instance and <xref:System.ServiceModel.Security.Tokens.SecurityTokenReferenceStyle> that specifies the type of the reference that is being requested are passed to this method as arguments.</span></span> <span data-ttu-id="e29dc-161">在本示例中，信用卡安全令牌仅支持内部引用。</span><span class="sxs-lookup"><span data-stu-id="e29dc-161">In this example, only internal references are supported by the credit card security token.</span></span> <span data-ttu-id="e29dc-162"><xref:System.IdentityModel.Tokens.SecurityToken> 类具有创建内部引用的功能，因此，该实现不需要附加代码。</span><span class="sxs-lookup"><span data-stu-id="e29dc-162">The <xref:System.IdentityModel.Tokens.SecurityToken> class has functionality to create internal references; therefore, the implementation does not require additional code.</span></span>  
  
7. <span data-ttu-id="e29dc-163">实现 <xref:System.ServiceModel.Security.Tokens.SecurityTokenParameters.InitializeSecurityTokenRequirement%28System.IdentityModel.Selectors.SecurityTokenRequirement%29> 方法。</span><span class="sxs-lookup"><span data-stu-id="e29dc-163">Implement the <xref:System.ServiceModel.Security.Tokens.SecurityTokenParameters.InitializeSecurityTokenRequirement%28System.IdentityModel.Selectors.SecurityTokenRequirement%29> method.</span></span> <span data-ttu-id="e29dc-164">此方法由 WCF 调用，以将安全令牌参数类实例转换为<xref:System.IdentityModel.Selectors.SecurityTokenRequirement>类的实例。</span><span class="sxs-lookup"><span data-stu-id="e29dc-164">This method is called by WCF to convert the security token parameters class instance into an instance of the <xref:System.IdentityModel.Selectors.SecurityTokenRequirement> class.</span></span> <span data-ttu-id="e29dc-165">安全令牌提供程序使用转换结果来创建相应的安全令牌实例。</span><span class="sxs-lookup"><span data-stu-id="e29dc-165">The result is used by security token providers to create the appropriate security token instance.</span></span>  
  
     [!code-csharp[c_CustomToken#2](../../../../samples/snippets/csharp/VS_Snippets_CFX/c_customtoken/cs/source.cs#2)]
     [!code-vb[c_CustomToken#2](../../../../samples/snippets/visualbasic/VS_Snippets_CFX/c_customtoken/vb/source.vb#2)]  
  
 <span data-ttu-id="e29dc-166">安全令牌被传递到 SOAP 消息内部，这要求在安全令牌的内存中表示形式与网络表示形式之间有一种转换机制。</span><span class="sxs-lookup"><span data-stu-id="e29dc-166">Security tokens are transmitted inside SOAP messages, which requires a translation mechanism between the in-memory security token representation and the on-the-wire representation.</span></span> <span data-ttu-id="e29dc-167">WCF 使用安全令牌序列化程序来完成此任务。</span><span class="sxs-lookup"><span data-stu-id="e29dc-167">WCF uses a security token serializer to accomplish this task.</span></span> <span data-ttu-id="e29dc-168">每个自定义令牌都必须有一个自定义安全令牌序列化程序，用于对 SOAP 消息中的自定义安全令牌进行序列化和反序列化。</span><span class="sxs-lookup"><span data-stu-id="e29dc-168">Every custom token must be accompanied by a custom security token serializer that can serialize and deserialize the custom security token from the SOAP message.</span></span>  
  
> [!NOTE]
> <span data-ttu-id="e29dc-169">默认情况下启用派生密钥。</span><span class="sxs-lookup"><span data-stu-id="e29dc-169">Derived keys are enabled by default.</span></span> <span data-ttu-id="e29dc-170">如果创建自定义安全令牌并将其用作主要令牌，WCF 将从中派生一个密钥。</span><span class="sxs-lookup"><span data-stu-id="e29dc-170">If you create a custom security token and use it as the primary token, WCF derives a key from it.</span></span> <span data-ttu-id="e29dc-171">如果这样做，则它将调用自定义安全令牌序列化程序以便为自定义安全令牌写入 <xref:System.IdentityModel.Tokens.SecurityKeyIdentifierClause>，同时将 `DerivedKeyToken` 序列化到网络。</span><span class="sxs-lookup"><span data-stu-id="e29dc-171">While doing so, it calls the custom security token serializer to write the <xref:System.IdentityModel.Tokens.SecurityKeyIdentifierClause> for the custom security token while serializing the `DerivedKeyToken` to the wire.</span></span> <span data-ttu-id="e29dc-172">在接收端，如果从网络反序列化令牌，则 `DerivedKeyToken` 序列化程序期望 `SecurityTokenReference` 元素作为其下的顶级子元素。</span><span class="sxs-lookup"><span data-stu-id="e29dc-172">On the receiving end, when deserializing the token off the wire, the `DerivedKeyToken` serializer expects a `SecurityTokenReference` element as the top-level child under itself.</span></span> <span data-ttu-id="e29dc-173">如果自定义安全令牌序列化程序在序列化其子句类型时未添加 `SecurityTokenReference` 元素，则会引发异常。</span><span class="sxs-lookup"><span data-stu-id="e29dc-173">If the custom security token serializer did not add a `SecurityTokenReference` element while serializing its clause type, an exception is thrown.</span></span>  
  
#### <a name="to-create-a-custom-security-token-serializer"></a><span data-ttu-id="e29dc-174">创建自定义安全令牌序列化程序</span><span class="sxs-lookup"><span data-stu-id="e29dc-174">To create a custom security token serializer</span></span>  
  
1. <span data-ttu-id="e29dc-175">定义一个从 <xref:System.ServiceModel.Security.WSSecurityTokenSerializer> 类派生的新类。</span><span class="sxs-lookup"><span data-stu-id="e29dc-175">Define a new class derived from the <xref:System.ServiceModel.Security.WSSecurityTokenSerializer> class.</span></span>  
  
2. <span data-ttu-id="e29dc-176">重写 <xref:System.ServiceModel.Security.WSSecurityTokenSerializer.CanReadTokenCore%28System.Xml.XmlReader%29> 方法，该方法使用一个 <xref:System.Xml.XmlReader> 来读取 XML 流。</span><span class="sxs-lookup"><span data-stu-id="e29dc-176">Override the <xref:System.ServiceModel.Security.WSSecurityTokenSerializer.CanReadTokenCore%28System.Xml.XmlReader%29> method, which relies on an <xref:System.Xml.XmlReader> to read the XML stream.</span></span> <span data-ttu-id="e29dc-177">如果序列化程序实现可以根据给定的当前元素对安全令牌进行反序列化，则该方法返回 `true`。</span><span class="sxs-lookup"><span data-stu-id="e29dc-177">The method returns `true` if the serializer implementation can deserialize the security token based given its current element.</span></span> <span data-ttu-id="e29dc-178">在本示例中，该方法检查 XML 读取器的当前 XML 元素是否具有正确的元素名称和命名空间。</span><span class="sxs-lookup"><span data-stu-id="e29dc-178">In this example, this method checks whether the XML reader's current XML element has the correct element name and namespace.</span></span> <span data-ttu-id="e29dc-179">如果不具有，则调用该方法的基类实现来处理该 XML 元素。</span><span class="sxs-lookup"><span data-stu-id="e29dc-179">If it does not, it calls the base class implementation of this method to handle the XML element.</span></span>  
  
3. <span data-ttu-id="e29dc-180">重写 <xref:System.ServiceModel.Security.WSSecurityTokenSerializer.ReadTokenCore%28System.Xml.XmlReader%2CSystem.IdentityModel.Selectors.SecurityTokenResolver%29> 方法。</span><span class="sxs-lookup"><span data-stu-id="e29dc-180">Override the <xref:System.ServiceModel.Security.WSSecurityTokenSerializer.ReadTokenCore%28System.Xml.XmlReader%2CSystem.IdentityModel.Selectors.SecurityTokenResolver%29> method.</span></span> <span data-ttu-id="e29dc-181">此方法读取安全令牌的 XML 内容，并为其构造相应的内存表示形式。</span><span class="sxs-lookup"><span data-stu-id="e29dc-181">This method reads the XML content of the security token and constructs the appropriate in-memory representation for it.</span></span> <span data-ttu-id="e29dc-182">如果它不能识别传入的 XML 读取器当前读取的 XML 元素，则会调用基类实现来处理系统提供的令牌类型。</span><span class="sxs-lookup"><span data-stu-id="e29dc-182">If it does not recognize the XML element on which the passed-in XML reader is standing, it calls the base class implementation to process the system-provided token types.</span></span>  
  
4. <span data-ttu-id="e29dc-183">重写 <xref:System.ServiceModel.Security.WSSecurityTokenSerializer.CanWriteTokenCore%28System.IdentityModel.Tokens.SecurityToken%29> 方法。</span><span class="sxs-lookup"><span data-stu-id="e29dc-183">Override the <xref:System.ServiceModel.Security.WSSecurityTokenSerializer.CanWriteTokenCore%28System.IdentityModel.Tokens.SecurityToken%29> method.</span></span> <span data-ttu-id="e29dc-184">如果可以将令牌的内存表示形式（作为参数传入）转换为 XML 表示形式，则此方法返回 `true`。</span><span class="sxs-lookup"><span data-stu-id="e29dc-184">This method returns `true` if it can convert the in-memory token representation (passed in as an argument) to the XML representation.</span></span> <span data-ttu-id="e29dc-185">如果无法转换，则会调用基类实现。</span><span class="sxs-lookup"><span data-stu-id="e29dc-185">If it cannot convert, it calls the base class implementation.</span></span>  
  
5. <span data-ttu-id="e29dc-186">重写 <xref:System.ServiceModel.Security.WSSecurityTokenSerializer.WriteTokenCore%28System.Xml.XmlWriter%2CSystem.IdentityModel.Tokens.SecurityToken%29> 方法。</span><span class="sxs-lookup"><span data-stu-id="e29dc-186">Override the <xref:System.ServiceModel.Security.WSSecurityTokenSerializer.WriteTokenCore%28System.Xml.XmlWriter%2CSystem.IdentityModel.Tokens.SecurityToken%29> method.</span></span> <span data-ttu-id="e29dc-187">此方法将安全令牌的内存表示形式转换为 XML 表示形式。</span><span class="sxs-lookup"><span data-stu-id="e29dc-187">This method converts an in-memory security token representation into an XML representation.</span></span> <span data-ttu-id="e29dc-188">如果此方法无法转换，则会调用基类实现。</span><span class="sxs-lookup"><span data-stu-id="e29dc-188">If the method cannot convert, it calls the base class implementation.</span></span>  
  
     [!code-csharp[c_CustomToken#3](../../../../samples/snippets/csharp/VS_Snippets_CFX/c_customtoken/cs/source.cs#3)]
     [!code-vb[c_CustomToken#3](../../../../samples/snippets/visualbasic/VS_Snippets_CFX/c_customtoken/vb/source.vb#3)]  
  
 <span data-ttu-id="e29dc-189">完成前面四个过程之后，将自定义安全令牌与安全令牌提供程序、身份验证器、管理器以及客户端和服务凭据进行集成。</span><span class="sxs-lookup"><span data-stu-id="e29dc-189">After completing the four previous procedures, integrate the custom security token with the security token provider, authenticator, manager, and client and service credentials.</span></span>  
  
#### <a name="to-integrate-the-custom-security-token-with-a-security-token-provider"></a><span data-ttu-id="e29dc-190">将自定义安全令牌与安全令牌提供程序进行集成</span><span class="sxs-lookup"><span data-stu-id="e29dc-190">To integrate the custom security token with a security token provider</span></span>  
  
1. <span data-ttu-id="e29dc-191">安全令牌提供程序可以创建、修改（如果需要）和返回令牌的实例。</span><span class="sxs-lookup"><span data-stu-id="e29dc-191">The security token provider creates, modifies (if necessary), and returns an instance of the token.</span></span> <span data-ttu-id="e29dc-192">若要创建自定义安全令牌的自定义提供程序，请创建一个从 <xref:System.IdentityModel.Selectors.SecurityTokenProvider> 类继承的类。</span><span class="sxs-lookup"><span data-stu-id="e29dc-192">To create a custom provider for the custom security token, create a class that inherits from the <xref:System.IdentityModel.Selectors.SecurityTokenProvider> class.</span></span> <span data-ttu-id="e29dc-193">下面的示例重写 <xref:System.IdentityModel.Selectors.SecurityTokenProvider.GetTokenCore%2A> 方法以返回 `CreditCardToken` 的实例。</span><span class="sxs-lookup"><span data-stu-id="e29dc-193">The following example overrides the <xref:System.IdentityModel.Selectors.SecurityTokenProvider.GetTokenCore%2A> method to return an instance of the `CreditCardToken`.</span></span> <span data-ttu-id="e29dc-194">有关自定义安全令牌提供程序的详细信息[，请参阅如何：创建自定义安全令牌提供](how-to-create-a-custom-security-token-provider.md)程序。</span><span class="sxs-lookup"><span data-stu-id="e29dc-194">For more information about custom security token providers, see [How to: Create a Custom Security Token Provider](how-to-create-a-custom-security-token-provider.md).</span></span>  
  
     [!code-csharp[c_CustomToken#6](../../../../samples/snippets/csharp/VS_Snippets_CFX/c_customtoken/cs/source.cs#6)]
     [!code-vb[c_CustomToken#6](../../../../samples/snippets/visualbasic/VS_Snippets_CFX/c_customtoken/vb/source.vb#6)]  
  
#### <a name="to-integrate-the-custom-security-token-with-a-security-token-authenticator"></a><span data-ttu-id="e29dc-195">将自定义安全令牌与安全令牌身份验证器进行集成</span><span class="sxs-lookup"><span data-stu-id="e29dc-195">To integrate the custom security token with a security token authenticator</span></span>  
  
1. <span data-ttu-id="e29dc-196">当安全令牌从消息中提取出来，安全令牌身份验证器即对其内容进行验证。</span><span class="sxs-lookup"><span data-stu-id="e29dc-196">The security token authenticator validates the content of the security token when it is extracted from the message.</span></span> <span data-ttu-id="e29dc-197">若要为自定义安全令牌创建自定义身份验证器，请创建一个从 <xref:System.IdentityModel.Selectors.SecurityTokenAuthenticator> 类继承的类。</span><span class="sxs-lookup"><span data-stu-id="e29dc-197">To create a custom authenticator for the custom security token, create a class that inherits from the <xref:System.IdentityModel.Selectors.SecurityTokenAuthenticator> class.</span></span> <span data-ttu-id="e29dc-198">下面的示例将会重写 <xref:System.IdentityModel.Selectors.SecurityTokenAuthenticator.ValidateTokenCore%2A> 方法。</span><span class="sxs-lookup"><span data-stu-id="e29dc-198">The following example overrides the <xref:System.IdentityModel.Selectors.SecurityTokenAuthenticator.ValidateTokenCore%2A> method.</span></span> <span data-ttu-id="e29dc-199">有关自定义安全令牌验证器的详细信息， [请参阅如何：创建自定义安全令牌身份](how-to-create-a-custom-security-token-authenticator.md)验证器。</span><span class="sxs-lookup"><span data-stu-id="e29dc-199">For more information about custom security token authenticators, see [How to: Create a Custom Security Token Authenticator](how-to-create-a-custom-security-token-authenticator.md).</span></span>  
  
     [!code-csharp[c_CustomToken#7](../../../../samples/snippets/csharp/VS_Snippets_CFX/c_customtoken/cs/source.cs#7)]
     [!code-vb[c_CustomToken#7](../../../../samples/snippets/visualbasic/VS_Snippets_CFX/c_customtoken/vb/source.vb#7)]  
  
     [!code-csharp[c_CustomToken#12](../../../../samples/snippets/csharp/VS_Snippets_CFX/c_customtoken/cs/source.cs#12)]
     [!code-vb[c_CustomToken#12](../../../../samples/snippets/visualbasic/VS_Snippets_CFX/c_customtoken/vb/source.vb#12)]  
  
#### <a name="to-integrate-the-custom-security-token-with-a-security-token-manager"></a><span data-ttu-id="e29dc-200">将自定义安全令牌与安全令牌管理器进行集成</span><span class="sxs-lookup"><span data-stu-id="e29dc-200">To integrate the custom security token with a security token manager</span></span>  
  
1. <span data-ttu-id="e29dc-201">安全令牌管理器可以创建相应的令牌提供程序、安全身份验证器和令牌序列化程序实例。</span><span class="sxs-lookup"><span data-stu-id="e29dc-201">The security token manager creates the appropriate token provider, security authenticator, and token serializer instances.</span></span> <span data-ttu-id="e29dc-202">若要创建自定义令牌管理器，请创建一个从 <xref:System.ServiceModel.ClientCredentialsSecurityTokenManager> 类继承的类。</span><span class="sxs-lookup"><span data-stu-id="e29dc-202">To create a custom token manager, create a class that inherits from the <xref:System.ServiceModel.ClientCredentialsSecurityTokenManager> class.</span></span> <span data-ttu-id="e29dc-203">该类的主要方法使用 <xref:System.IdentityModel.Selectors.SecurityTokenRequirement> 来创建相应的提供程序以及客户端或服务凭据。</span><span class="sxs-lookup"><span data-stu-id="e29dc-203">The primary methods of the class use a <xref:System.IdentityModel.Selectors.SecurityTokenRequirement> to create the appropriate provider and client or service credentials.</span></span> <span data-ttu-id="e29dc-204">有关自定义安全令牌管理器的详细信息[，请参阅演练：创建自定义客户端和](walkthrough-creating-custom-client-and-service-credentials.md)服务凭据。</span><span class="sxs-lookup"><span data-stu-id="e29dc-204">For more information about custom security token managers, see [Walkthrough: Creating Custom Client and Service Credentials](walkthrough-creating-custom-client-and-service-credentials.md).</span></span>  
  
     [!code-csharp[c_CustomToken#8](../../../../samples/snippets/csharp/VS_Snippets_CFX/c_customtoken/cs/source.cs#8)]
     [!code-vb[c_CustomToken#8](../../../../samples/snippets/visualbasic/VS_Snippets_CFX/c_customtoken/vb/source.vb#8)]  
  
     [!code-csharp[c_CustomToken#9](../../../../samples/snippets/csharp/VS_Snippets_CFX/c_customtoken/cs/source.cs#9)]
     [!code-vb[c_CustomToken#9](../../../../samples/snippets/visualbasic/VS_Snippets_CFX/c_customtoken/vb/source.vb#9)]  
  
#### <a name="to-integrate-the-custom-security-token-with-custom-client-and-service-credentials"></a><span data-ttu-id="e29dc-205">将自定义安全令牌与自定义客户端和服务凭据进行集成</span><span class="sxs-lookup"><span data-stu-id="e29dc-205">To integrate the custom security token with custom client and service credentials</span></span>  
  
1. <span data-ttu-id="e29dc-206">必须添加自定义客户端和服务凭据，才能向应用程序提供一个 API，使其能够指定先前创建的自定义安全令牌基础结构所使用的自定义令牌信息，从而提供自定义安全令牌内容并对内容进行身份验证。</span><span class="sxs-lookup"><span data-stu-id="e29dc-206">The custom client and service credentials must be added to provide an API for the application to allow specifying custom token information that is used by the custom security token infrastructure created previously to provide and authenticate the custom security token content.</span></span> <span data-ttu-id="e29dc-207">下面的示例演示如何执行此操作。</span><span class="sxs-lookup"><span data-stu-id="e29dc-207">The following samples show how this can be done.</span></span> <span data-ttu-id="e29dc-208">有关自定义客户端和服务凭据的详细信息[，请参阅演练：创建自定义客户端和](walkthrough-creating-custom-client-and-service-credentials.md)服务凭据。</span><span class="sxs-lookup"><span data-stu-id="e29dc-208">For more information about custom client and service credentials, see [Walkthrough: Creating Custom Client and Service Credentials](walkthrough-creating-custom-client-and-service-credentials.md).</span></span>  
  
     [!code-csharp[c_CustomToken#10](../../../../samples/snippets/csharp/VS_Snippets_CFX/c_customtoken/cs/source.cs#10)]
     [!code-vb[c_CustomToken#10](../../../../samples/snippets/visualbasic/VS_Snippets_CFX/c_customtoken/vb/source.vb#10)]  
  
     [!code-csharp[c_customToken#11](../../../../samples/snippets/csharp/VS_Snippets_CFX/c_customtoken/cs/source.cs#11)]
     [!code-vb[c_customToken#11](../../../../samples/snippets/visualbasic/VS_Snippets_CFX/c_customtoken/vb/source.vb#11)]  
  
 <span data-ttu-id="e29dc-209">先前创建的自定义安全令牌参数类用于告知 WCF 安全框架，当与服务通信时，必须使用自定义安全令牌。</span><span class="sxs-lookup"><span data-stu-id="e29dc-209">The custom security token parameters class created previously is used to tell the WCF security framework that a custom security token must be used when communicating with a service.</span></span> <span data-ttu-id="e29dc-210">下面的过程演示如何执行此操作。</span><span class="sxs-lookup"><span data-stu-id="e29dc-210">The following procedure shows how this can be done.</span></span>  
  
#### <a name="to-integrate-the-custom-security-token-with-the-binding"></a><span data-ttu-id="e29dc-211">将自定义安全令牌与绑定进行集成</span><span class="sxs-lookup"><span data-stu-id="e29dc-211">To integrate the custom security token with the binding</span></span>  
  
1. <span data-ttu-id="e29dc-212">在 <xref:System.ServiceModel.Channels.SecurityBindingElement> 类上公开的一个令牌参数集合中，必须指定自定义安全令牌参数类。</span><span class="sxs-lookup"><span data-stu-id="e29dc-212">The custom security token parameters class must be specified in one of the token parameters collections that are exposed on the <xref:System.ServiceModel.Channels.SecurityBindingElement> class.</span></span> <span data-ttu-id="e29dc-213">下面的示例使用 `SignedEncrypted` 所返回的集合。</span><span class="sxs-lookup"><span data-stu-id="e29dc-213">The following example uses the collection returned by `SignedEncrypted`.</span></span> <span data-ttu-id="e29dc-214">代码将信用卡自定义令牌添加到从客户端发送到服务的每个消息中，并对令牌内容自动进行了签名和加密。</span><span class="sxs-lookup"><span data-stu-id="e29dc-214">The code adds the credit card custom token to every message sent from the client to the service with its content automatically signed and encrypted.</span></span>  
  
     [!code-csharp[c_CustomToken#13](../../../../samples/snippets/csharp/VS_Snippets_CFX/c_customtoken/cs/source.cs#13)]
     [!code-vb[c_CustomToken#13](../../../../samples/snippets/visualbasic/VS_Snippets_CFX/c_customtoken/vb/source.vb#13)]  
  
 <span data-ttu-id="e29dc-215">本主题显示实现和使用自定义令牌所需的各种不同的代码块。</span><span class="sxs-lookup"><span data-stu-id="e29dc-215">This topic shows the various pieces of code necessary to implement and use a custom token.</span></span> <span data-ttu-id="e29dc-216">若要查看所有这些代码片段如何结合在一起的完整示例，请参阅[自定义令牌](../samples/custom-token.md)。</span><span class="sxs-lookup"><span data-stu-id="e29dc-216">To see a complete example of how all these pieces of code fit together see, [Custom Token](../samples/custom-token.md).</span></span>  
  
## <a name="see-also"></a><span data-ttu-id="e29dc-217">请参阅</span><span class="sxs-lookup"><span data-stu-id="e29dc-217">See also</span></span>

- <xref:System.IdentityModel.Tokens.SecurityToken>
- <xref:System.ServiceModel.Security.Tokens.SecurityTokenParameters>
- <xref:System.ServiceModel.Security.WSSecurityTokenSerializer>
- <xref:System.IdentityModel.Selectors.SecurityTokenProvider>
- <xref:System.IdentityModel.Selectors.SecurityTokenAuthenticator>
- <xref:System.IdentityModel.Policy.IAuthorizationPolicy>
- <xref:System.IdentityModel.Selectors.SecurityTokenRequirement>
- <xref:System.IdentityModel.Selectors.SecurityTokenManager>
- <xref:System.ServiceModel.Description.ClientCredentials>
- <xref:System.ServiceModel.Description.ServiceCredentials>
- <xref:System.ServiceModel.Channels.SecurityBindingElement>
- [<span data-ttu-id="e29dc-218">演练：创建自定义客户端和服务凭据</span><span class="sxs-lookup"><span data-stu-id="e29dc-218">Walkthrough: Creating Custom Client and Service Credentials</span></span>](walkthrough-creating-custom-client-and-service-credentials.md)
- [<span data-ttu-id="e29dc-219">如何：创建自定义安全令牌身份验证器</span><span class="sxs-lookup"><span data-stu-id="e29dc-219">How to: Create a Custom Security Token Authenticator</span></span>](how-to-create-a-custom-security-token-authenticator.md)
- [<span data-ttu-id="e29dc-220">如何：创建自定义安全令牌提供程序</span><span class="sxs-lookup"><span data-stu-id="e29dc-220">How to: Create a Custom Security Token Provider</span></span>](how-to-create-a-custom-security-token-provider.md)
