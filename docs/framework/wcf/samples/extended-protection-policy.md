---
title: 扩展保护策略
ms.date: 03/30/2017
ms.assetid: e2616a10-317e-4c34-8023-0c015a80a82f
ms.openlocfilehash: 645b48b3c7ce3daaaedac372ba5ba6fd5edfc8f8
ms.sourcegitcommit: 0be8a279af6d8a43e03141e349d3efd5d35f8767
ms.translationtype: HT
ms.contentlocale: zh-CN
ms.lasthandoff: 04/18/2019
ms.locfileid: "59768418"
---
# <a name="extended-protection-policy"></a><span data-ttu-id="6d151-102">扩展保护策略</span><span class="sxs-lookup"><span data-stu-id="6d151-102">Extended Protection Policy</span></span>
<span data-ttu-id="6d151-103">扩展保护是一种针对中间人 (MITM) 攻击提供保护的安全计划。</span><span class="sxs-lookup"><span data-stu-id="6d151-103">Extended Protection is a security initiative for protecting against man-in-the-middle (MITM) attacks.</span></span> <span data-ttu-id="6d151-104">MITM 攻击是一种安全威胁，MITM 在该攻击中获取客户端凭据并将其转发给服务器。</span><span class="sxs-lookup"><span data-stu-id="6d151-104">A MITM attack is a security threat in which a MITM takes a client’s credentials and forwards it to a server.</span></span>  
  
## <a name="demonstrates"></a><span data-ttu-id="6d151-105">演示</span><span class="sxs-lookup"><span data-stu-id="6d151-105">Demonstrates</span></span>  
 <span data-ttu-id="6d151-106">扩展保护</span><span class="sxs-lookup"><span data-stu-id="6d151-106">Extended protection</span></span>  
  
## <a name="discussion"></a><span data-ttu-id="6d151-107">讨论</span><span class="sxs-lookup"><span data-stu-id="6d151-107">Discussion</span></span>  
 <span data-ttu-id="6d151-108">当应用程序通过 HTTPS 使用 Kerberos、Digest 或 NTLM 进行身份验证时，首先会建立一个传输层安全 (TLS) 通道，然后使用此安全通道进行身份验证。</span><span class="sxs-lookup"><span data-stu-id="6d151-108">When applications authenticate using Kerberos, Digest or NTLM using HTTPS, a Transport Level Security (TLS) channel is first established and then authentication takes place using the secure channel.</span></span> <span data-ttu-id="6d151-109">但是，SSL 生成的会话密钥和身份验证期间生成的会话密钥之间没有任何绑定。</span><span class="sxs-lookup"><span data-stu-id="6d151-109">However, there is no binding between the session key generated by SSL and the session key generated during authentication.</span></span> <span data-ttu-id="6d151-110">即使传输通道本身是安全的，任何 MITM 也可以在客户端和服务器之间建立自身，然后开始转发来自客户端的请求，因为服务器无法知道安全通道是从客户端还是 MITM 建立的。</span><span class="sxs-lookup"><span data-stu-id="6d151-110">Any MITM can establish itself between the client and the server and start forwarding the requests from the client, even when the transport channel itself is secure, because the server has no way of knowing whether the secure channel has been established from the client or a MITM.</span></span> <span data-ttu-id="6d151-111">此方案中的解决方案是将外部 TLS 通道与内部身份验证通道绑定，从而使服务器可以检测是否存在 MITM。</span><span class="sxs-lookup"><span data-stu-id="6d151-111">The solution in this scenario is to bind the outer TLS channel with the inner authentication channel such that the server can detect if there is a MITM.</span></span>  
  
> [!NOTE]
>  <span data-ttu-id="6d151-112">本示例仅当在 IIS 上承载时才可正常运行，而不适用于 Cassini（Visual Studio 开发服务器），因为 Cassini 不支持 HTTPS。</span><span class="sxs-lookup"><span data-stu-id="6d151-112">This sample only works when hosted on IIS and cannot work on Cassini – Visual Studio Development Server because Cassini does not support HTTPS.</span></span>  
  
> [!NOTE]
>  <span data-ttu-id="6d151-113">此功能当前只在 Windows 7 上可用。</span><span class="sxs-lookup"><span data-stu-id="6d151-113">This feature is currently only available on Windows 7.</span></span> <span data-ttu-id="6d151-114">以下步骤特定于 Windows 7。</span><span class="sxs-lookup"><span data-stu-id="6d151-114">The following steps are specific to Windows 7.</span></span>  
  
#### <a name="to-set-up-build-and-run-the-sample"></a><span data-ttu-id="6d151-115">设置、生成和运行示例</span><span class="sxs-lookup"><span data-stu-id="6d151-115">To set up, build, and run the sample</span></span>  
  
1. <span data-ttu-id="6d151-116">安装 Internet 信息服务从**控制面板**，**添加/删除程序**， **Windows 功能**。</span><span class="sxs-lookup"><span data-stu-id="6d151-116">Install Internet Information Services from **Control Panel**, **Add/Remove Programs**, **Windows Features**.</span></span>  
  
2. <span data-ttu-id="6d151-117">安装**Windows 身份验证**中**Windows 功能**， **Internet 信息服务**，**万维网服务**， **安全**，并**Windows 身份验证**。</span><span class="sxs-lookup"><span data-stu-id="6d151-117">Install **Windows Authentication** in **Windows Features**, **Internet Information Services**, **World Wide Web Services**, **Security**, and **Windows Authentication**.</span></span>  
  
3. <span data-ttu-id="6d151-118">安装**Windows Communication Foundation HTTP 激活**中**Windows 功能**， **Microsoft.NET Framework 3.5.1**，和**Windows 通信Foundation HTTP 激活**。</span><span class="sxs-lookup"><span data-stu-id="6d151-118">Install **Windows Communication Foundation HTTP Activation** in **Windows Features**, **Microsoft .NET Framework 3.5.1**, and **Windows Communication Foundation HTTP Activation**.</span></span>  
  
4. <span data-ttu-id="6d151-119">本示例要求客户端与服务器建立一个安全通道，因此它要求存在服务器证书，此证书可从 Internet 信息服务 (IIS) 管理器进行安装。</span><span class="sxs-lookup"><span data-stu-id="6d151-119">This sample requires the client to establish a secure channel with the server, so it requires the presence of a server certificate which can be installed from Internet Information Services (IIS) Manager.</span></span>  
  
    1.  <span data-ttu-id="6d151-120">打开 IIS 管理器。</span><span class="sxs-lookup"><span data-stu-id="6d151-120">Open IIS Manager.</span></span> <span data-ttu-id="6d151-121">打开**服务器证书**，后者在中显示**功能查看**选项卡上选择根节点 （计算机名称） 时。</span><span class="sxs-lookup"><span data-stu-id="6d151-121">Open **Server certificates**, which appears in the **Feature View** tab when the root node (machine name) is selected.</span></span>  
  
    2.  <span data-ttu-id="6d151-122">为了测试此示例，可以创建一个自签名证书。</span><span class="sxs-lookup"><span data-stu-id="6d151-122">For the purpose of testing this sample, create a self-signed certificate.</span></span> <span data-ttu-id="6d151-123">如果不希望 Internet Explorer 提示证书不安全，可将证书安装到受信任的证书根颁发机构存储区中。</span><span class="sxs-lookup"><span data-stu-id="6d151-123">If you do not want Internet Explorer to prompt you about the certificate not being secure, install the certificate in the Trusted Certificate Root authority store.</span></span>  
  
5. <span data-ttu-id="6d151-124">打开**操作**默认网站上的窗格。</span><span class="sxs-lookup"><span data-stu-id="6d151-124">Open the **Actions** pane for the default Web site.</span></span> <span data-ttu-id="6d151-125">单击**编辑站点**，**绑定**。</span><span class="sxs-lookup"><span data-stu-id="6d151-125">Click **Edit Site**, **Bindings**.</span></span> <span data-ttu-id="6d151-126">如果 HTTPS 尚不存在，请将其作为类型添加，使用端口号 443。</span><span class="sxs-lookup"><span data-stu-id="6d151-126">Add HTTPS as a type if not already present, with port number 443.</span></span> <span data-ttu-id="6d151-127">分配在上一步中创建的 SSL 证书。</span><span class="sxs-lookup"><span data-stu-id="6d151-127">Assign the SSL certificate created in the preceding step.</span></span>  
  
6. <span data-ttu-id="6d151-128">生成服务。</span><span class="sxs-lookup"><span data-stu-id="6d151-128">Build the service.</span></span> <span data-ttu-id="6d151-129">这会在 IIS 中创建一个虚拟目录，并根据需要为要进行 Web 承载的服务复制 .dll、.svc 和 .config 文件。</span><span class="sxs-lookup"><span data-stu-id="6d151-129">This creates a virtual directory in IIS, and copies the .dll, .svc and .config files as required for the service to be Web hosted.</span></span>  
  
7. <span data-ttu-id="6d151-130">打开 IIS 管理器。</span><span class="sxs-lookup"><span data-stu-id="6d151-130">Open IIS Manager.</span></span> <span data-ttu-id="6d151-131">右键单击虚拟目录 (**ExtendedProtection**)，其中上一步中创建。</span><span class="sxs-lookup"><span data-stu-id="6d151-131">Right-click the virtual directory (**ExtendedProtection**), which was created in the preceding step.</span></span> <span data-ttu-id="6d151-132">选择**转换为应用程序**。</span><span class="sxs-lookup"><span data-stu-id="6d151-132">Select **Convert to Application**.</span></span>  
  
8. <span data-ttu-id="6d151-133">打开**身份验证**模块在 IIS 管理器用于此虚拟目录和启用**Windows 身份验证**。</span><span class="sxs-lookup"><span data-stu-id="6d151-133">Open the **Authentication** module in IIS Manager for this virtual directory and enable **Windows Authentication**.</span></span>  
  
9. <span data-ttu-id="6d151-134">打开**高级设置**下**Windows 身份验证**为此虚拟目录并将其设置为**所需**。</span><span class="sxs-lookup"><span data-stu-id="6d151-134">Open **Advanced Settings** under **Windows Authentication** for this virtual directory and set it to **Required**.</span></span>  
  
10. <span data-ttu-id="6d151-135">通过从浏览器窗口（提供完全限定的域名）访问 HTTPS URL 可测试服务。</span><span class="sxs-lookup"><span data-stu-id="6d151-135">You can test the service by accessing the HTTPS URL from a browser window (Provide a fully-qualified domain name).</span></span> <span data-ttu-id="6d151-136">如果想要从远程计算机访问此 URL，请确保为所有传入 HTTP 和 HTTPS 连接打开了防火墙。</span><span class="sxs-lookup"><span data-stu-id="6d151-136">If you want to access this URL from a remote machine, make sure that the firewall is opened for all incoming HTTP and HTTPS connections.</span></span>  
  
11. <span data-ttu-id="6d151-137">打开客户端配置文件，并为客户端或终结点地址特性提供完全限定的域名，以替换 `<<full_machine_name>>`。</span><span class="sxs-lookup"><span data-stu-id="6d151-137">Open the client configuration file and provide a fully-qualified domain name for the client or endpoint address attribute that replaces `<<full_machine_name>>`.</span></span>  
  
12. <span data-ttu-id="6d151-138">运行客户端。</span><span class="sxs-lookup"><span data-stu-id="6d151-138">Run the client.</span></span> <span data-ttu-id="6d151-139">客户端与服务进行通信，这会建立安全通道并使用扩展保护。</span><span class="sxs-lookup"><span data-stu-id="6d151-139">The client communicates with the service, which establishes a secure channel and uses extended protection.</span></span>  
  
> [!IMPORTANT]
>  <span data-ttu-id="6d151-140">您的计算机上可能已安装这些示例。</span><span class="sxs-lookup"><span data-stu-id="6d151-140">The samples may already be installed on your machine.</span></span> <span data-ttu-id="6d151-141">在继续操作之前，请先检查以下（默认）目录：</span><span class="sxs-lookup"><span data-stu-id="6d151-141">Check for the following (default) directory before continuing.</span></span>  
>   
>  `<InstallDrive>:\WF_WCF_Samples`  
>   
>  <span data-ttu-id="6d151-142">如果此目录不存在，请转到[Windows Communication Foundation (WCF) 和.NET Framework 4 的 Windows Workflow Foundation (WF) 示例](https://go.microsoft.com/fwlink/?LinkId=150780)若要下载所有 Windows Communication Foundation (WCF) 和[!INCLUDE[wf1](../../../../includes/wf1-md.md)]示例。</span><span class="sxs-lookup"><span data-stu-id="6d151-142">If this directory does not exist, go to [Windows Communication Foundation (WCF) and Windows Workflow Foundation (WF) Samples for .NET Framework 4](https://go.microsoft.com/fwlink/?LinkId=150780) to download all Windows Communication Foundation (WCF) and [!INCLUDE[wf1](../../../../includes/wf1-md.md)] samples.</span></span> <span data-ttu-id="6d151-143">此示例位于以下目录：</span><span class="sxs-lookup"><span data-stu-id="6d151-143">This sample is located in the following directory.</span></span>  
>   
>  `<InstallDrive>:\WF_WCF_Samples\WCF\Basic\Services\Security\ExtendedProtection`
