---
title: 发现安全示例
ms.date: 03/30/2017
ms.assetid: b8db01f4-b4a1-43fe-8e31-26d4e9304a65
ms.openlocfilehash: 00f81d1879d9157a7ecdfa0db8d2ea0d505ad5b6
ms.sourcegitcommit: 7588136e355e10cbc2582f389c90c127363c02a5
ms.translationtype: MT
ms.contentlocale: zh-CN
ms.lasthandoff: 03/12/2020
ms.locfileid: "79183742"
---
# <a name="discovery-security-sample"></a><span data-ttu-id="cbf8d-102">发现安全示例</span><span class="sxs-lookup"><span data-stu-id="cbf8d-102">Discovery Security Sample</span></span>

<span data-ttu-id="cbf8d-103">Discovery 规范不要求参与发现过程的终结点是安全的。</span><span class="sxs-lookup"><span data-stu-id="cbf8d-103">The Discovery specification does not require that endpoints that participate in the discovery process to be secure.</span></span> <span data-ttu-id="cbf8d-104">增强发现消息的安全性可缓解各种类型的攻击（消息更改、拒绝服务、重播、欺骗）。</span><span class="sxs-lookup"><span data-stu-id="cbf8d-104">Enhancing the discovery messages with security mitigates various types of attacks (message alteration, denial of service, replay, spoofing).</span></span> <span data-ttu-id="cbf8d-105">本示例实现自定义通道，这些通道计算和验证使用精简签名格式（在 WS-Discovery 规范的第 8.2 节中进行了介绍）的消息签名。</span><span class="sxs-lookup"><span data-stu-id="cbf8d-105">This sample implements custom channels that compute and verify message signatures using the compact signature format (described in Section 8.2 of the WS-Discovery specification).</span></span> <span data-ttu-id="cbf8d-106">该示例同时支持[2005 年发现规范和](http://specs.xmlsoap.org/ws/2005/04/discovery/ws-discovery.pdf) [1.1 版本](http://docs.oasis-open.org/ws-dd/discovery/1.1/cs-01/wsdd-discovery-1.1-spec-cs-01.pdf)。</span><span class="sxs-lookup"><span data-stu-id="cbf8d-106">The sample supports both the [2005 Discovery specification](http://specs.xmlsoap.org/ws/2005/04/discovery/ws-discovery.pdf) and the [1.1 version](http://docs.oasis-open.org/ws-dd/discovery/1.1/cs-01/wsdd-discovery-1.1-spec-cs-01.pdf).</span></span>  
  
 <span data-ttu-id="cbf8d-107">自定义通道应用于发现和公告终结点的现有通道堆栈顶部。</span><span class="sxs-lookup"><span data-stu-id="cbf8d-107">The custom channel is applied on top of the existing channel stack for Discovery and Announcement endpoints.</span></span> <span data-ttu-id="cbf8d-108">这样，对于发送的每个消息都应用一个签名标头。</span><span class="sxs-lookup"><span data-stu-id="cbf8d-108">This way, a signature header is applied for every message sent.</span></span> <span data-ttu-id="cbf8d-109">会对接收的消息验证签名，如果签名不匹配或消息没有签名，则丢弃消息。</span><span class="sxs-lookup"><span data-stu-id="cbf8d-109">The signature is verified on received messages and when it does not match or when the messages do not have a signature, the messages are dropped.</span></span> <span data-ttu-id="cbf8d-110">本示例使用证书对消息进行签名和验证。</span><span class="sxs-lookup"><span data-stu-id="cbf8d-110">To sign and verify messages, the sample uses certificates.</span></span>  
  
## <a name="discussion"></a><span data-ttu-id="cbf8d-111">讨论区</span><span class="sxs-lookup"><span data-stu-id="cbf8d-111">Discussion</span></span>  
 <span data-ttu-id="cbf8d-112">WCF 具有很强的可扩展性，使用户可以根据需要自定义通道。</span><span class="sxs-lookup"><span data-stu-id="cbf8d-112">WCF is very extensible and allows users the possibility to customize channels as desired.</span></span> <span data-ttu-id="cbf8d-113">本示例实现一个生成安全通道的发现安全绑定元素。</span><span class="sxs-lookup"><span data-stu-id="cbf8d-113">The sample implements a discovery secure binding element that builds secure channels.</span></span> <span data-ttu-id="cbf8d-114">安全通道应用并验证消息签名，在当前堆栈顶部应用。</span><span class="sxs-lookup"><span data-stu-id="cbf8d-114">The secure channels apply and verify message signatures and are applied on top of the current stack.</span></span>  
  
 <span data-ttu-id="cbf8d-115">安全绑定元素生成安全通道工厂和通道侦听器。</span><span class="sxs-lookup"><span data-stu-id="cbf8d-115">The secure binding element builds secure channel factories and channel listeners.</span></span>  
  
## <a name="secure-channel-factory"></a><span data-ttu-id="cbf8d-116">安全通道工厂</span><span class="sxs-lookup"><span data-stu-id="cbf8d-116">Secure Channel Factory</span></span>  
 <span data-ttu-id="cbf8d-117">安全通道工厂创建输出或双工通道，这些通道向消息标头添加精简签名。</span><span class="sxs-lookup"><span data-stu-id="cbf8d-117">The secure channel factory creates output or duplex channels that add a compact signature to message headers.</span></span> <span data-ttu-id="cbf8d-118">若要使消息尽可能地小，请使用精简签名格式。</span><span class="sxs-lookup"><span data-stu-id="cbf8d-118">To keep messages as small as possible the compact signature format is used.</span></span> <span data-ttu-id="cbf8d-119">精简签名的结构显示在下面的示例中。</span><span class="sxs-lookup"><span data-stu-id="cbf8d-119">The structure of a compact signature is shown in the following example.</span></span>  
  
```xml  
<d:Security ... >
  [<d:Sig Scheme="xs:anyURI"
         [KeyId="xs:base64Binary"]?  
          Refs="..."  
         [PrefixList]="xs:NMTOKENS"
          Sig="xs:base64Binary"
          ... />]?  
  ...
</d:Security>  
```  
  
> [!NOTE]
> <span data-ttu-id="cbf8d-120">`PrefixList` 已加入 2008 Discovery 版本协议。</span><span class="sxs-lookup"><span data-stu-id="cbf8d-120">The `PrefixList` was added in the 2008 Discovery version protocol.</span></span>  
  
 <span data-ttu-id="cbf8d-121">为计算签名，示例确定扩展的签名项。</span><span class="sxs-lookup"><span data-stu-id="cbf8d-121">To compute the signature, the sample determines the expanded signature items.</span></span> <span data-ttu-id="cbf8d-122">根据 WS-Discovery 规范的要求，使用 `SignedInfo` 命名空间前缀创建 XML 签名 (`ds`)。</span><span class="sxs-lookup"><span data-stu-id="cbf8d-122">An XML signature (`SignedInfo`) is created, using the `ds` namespace prefix, as required by the WS-Discovery specification.</span></span> <span data-ttu-id="cbf8d-123">发现和寻址命名空间中的正文和所有标头都在签名中进行引用，因此无法对这些内容进行篡改。</span><span class="sxs-lookup"><span data-stu-id="cbf8d-123">The body and all the headers in discovery and addressing namespaces are referenced in the signature, so they cannot be tampered with.</span></span> <span data-ttu-id="cbf8d-124">每个引用的元素都使用独占规范化 （）http://www.w3.org/2001/10/xml-exc-c14n#进行转换，然后计算 SHA-1 摘要值 （）。http://www.w3.org/2000/09/xmldsig#sha1</span><span class="sxs-lookup"><span data-stu-id="cbf8d-124">Each referenced element is transformed using the Exclusive Canonicalization (http://www.w3.org/2001/10/xml-exc-c14n# ), and then an SHA-1 digest value is computed (http://www.w3.org/2000/09/xmldsig#sha1 ).</span></span> <span data-ttu-id="cbf8d-125">基于所有引用的元素及其摘要值，使用 RSA 算法 （ 计算http://www.w3.org/2000/09/xmldsig#rsa-sha1签名值）。</span><span class="sxs-lookup"><span data-stu-id="cbf8d-125">Based on all referenced elements and their digest values, the signature value is computed using the RSA algorithm (http://www.w3.org/2000/09/xmldsig#rsa-sha1 ).</span></span>  
  
 <span data-ttu-id="cbf8d-126">消息使用特定于客户端的证书进行签名。</span><span class="sxs-lookup"><span data-stu-id="cbf8d-126">The messages are signed with a client-specified certificate.</span></span> <span data-ttu-id="cbf8d-127">创建绑定元素时必须指定存储位置、名称和证书主题名称。</span><span class="sxs-lookup"><span data-stu-id="cbf8d-127">The store location, name and the certificate subject name must be specified when the binding element is created.</span></span> <span data-ttu-id="cbf8d-128">精简签名中的 `KeyId` 表示签名令牌的密钥标识符，是签名令牌的主题密钥标识符 (SKI) 或者是（如果 SKI 不存在）签名令牌的公钥的 SHA-1 哈希值。</span><span class="sxs-lookup"><span data-stu-id="cbf8d-128">The `KeyId` in the compact signature represents the key identifier of the signing token and is the Subject Key Identifier (SKI) of the signing token or (if the SKI does not exist) a SHA-1 hash of the public key of the signing token.</span></span>  
  
## <a name="secure-channel-listener"></a><span data-ttu-id="cbf8d-129">安全通道侦听器</span><span class="sxs-lookup"><span data-stu-id="cbf8d-129">Secure Channel Listener</span></span>  
 <span data-ttu-id="cbf8d-130">安全通道侦听器创建输入或双工通道，这些通道验证接收的消息中的精简签名。</span><span class="sxs-lookup"><span data-stu-id="cbf8d-130">The secure channel listener creates input or duplex channels that verify the compact signature in received messages.</span></span> <span data-ttu-id="cbf8d-131">为验证签名，使用附加到消息的精简签名中指定的 `KeyId` 从指定存储区中选择证书。</span><span class="sxs-lookup"><span data-stu-id="cbf8d-131">To verify the signature, the `KeyId` specified in the compact signature attached to the message is used to select a certificate from the specified store.</span></span> <span data-ttu-id="cbf8d-132">如果消息没有签名或签名检查失败，则丢弃消息。</span><span class="sxs-lookup"><span data-stu-id="cbf8d-132">If the message does not have a signature or the signature check fails, the messages are dropped.</span></span> <span data-ttu-id="cbf8d-133">为使用安全绑定，本示例定义一个工厂，该工厂使用添加的发现安全绑定元素创建自定义 <xref:System.ServiceModel.Discovery.UdpDiscoveryEndpoint> 和 <xref:System.ServiceModel.Discovery.UdpAnnouncementEndpoint>。</span><span class="sxs-lookup"><span data-stu-id="cbf8d-133">To use the secure binding, the sample defines a factory that creates custom <xref:System.ServiceModel.Discovery.UdpDiscoveryEndpoint> and <xref:System.ServiceModel.Discovery.UdpAnnouncementEndpoint> with the added discovery secure binding element.</span></span> <span data-ttu-id="cbf8d-134">这些安全终结点可以用于发现公告侦听器和可发现服务。</span><span class="sxs-lookup"><span data-stu-id="cbf8d-134">These secure endpoints can be used in discovery announcement listeners and discoverable services.</span></span>  
  
## <a name="sample-details"></a><span data-ttu-id="cbf8d-135">示例详细信息</span><span class="sxs-lookup"><span data-stu-id="cbf8d-135">Sample Details</span></span>  
 <span data-ttu-id="cbf8d-136">本示例包含一个库和 4 个控制台应用程序：</span><span class="sxs-lookup"><span data-stu-id="cbf8d-136">The sample includes a library and 4 console applications:</span></span>  
  
- <span data-ttu-id="cbf8d-137">**发现安全通道**：公开安全绑定的库。</span><span class="sxs-lookup"><span data-stu-id="cbf8d-137">**DiscoverySecurityChannels**: A library that exposes the secure binding.</span></span> <span data-ttu-id="cbf8d-138">该库计算并验证传出/传入消息的精简签名。</span><span class="sxs-lookup"><span data-stu-id="cbf8d-138">The library computes and verifies the compact signature for outgoing/incoming messages.</span></span>  
  
- <span data-ttu-id="cbf8d-139">**服务**：公开 I计算器服务协定的服务，自托管。</span><span class="sxs-lookup"><span data-stu-id="cbf8d-139">**Service**: A service exposing ICalculatorService contract, self hosted.</span></span> <span data-ttu-id="cbf8d-140">该服务标记为可发现。</span><span class="sxs-lookup"><span data-stu-id="cbf8d-140">The service is marked as Discoverable.</span></span> <span data-ttu-id="cbf8d-141">用户通过指定证书的存储位置、名称和主题名称或其他唯一标识符来指定用于对消息签名的证书的详细信息，并指定客户端证书（用于检查传入消息的签名的证书）所处的存储区。</span><span class="sxs-lookup"><span data-stu-id="cbf8d-141">The user specifies the details of the certificate used to sign messages by specifying the store location and name and the subject name or other unique identifier for the certificate, and the store where the client certificates are located (the certificates used to check signature for incoming messages).</span></span> <span data-ttu-id="cbf8d-142">基于这些详细信息，生成并使用增加了安全性的 UdpDiscoveryEndpoint。</span><span class="sxs-lookup"><span data-stu-id="cbf8d-142">Based on these details, a UdpDiscoveryEndpoint with added security is built and used.</span></span>  
  
- <span data-ttu-id="cbf8d-143">**客户端**：此类尝试发现 I计算器服务并调用服务上的方法。</span><span class="sxs-lookup"><span data-stu-id="cbf8d-143">**Client**: This class tries to discover an ICalculatorService and to call methods on the service.</span></span> <span data-ttu-id="cbf8d-144">同样，生成增加了安全性的 <xref:System.ServiceModel.Discovery.UdpDiscoveryEndpoint>，并用于对消息进行签名和验证。</span><span class="sxs-lookup"><span data-stu-id="cbf8d-144">Again, a <xref:System.ServiceModel.Discovery.UdpDiscoveryEndpoint> with added security is built and used to sign and verify the messages.</span></span>  
  
- <span data-ttu-id="cbf8d-145">**公告侦听**器：一种自托管服务，用于侦听联机和脱机通知并使用安全公告终结点。</span><span class="sxs-lookup"><span data-stu-id="cbf8d-145">**AnnouncementListener**: A self-hosted service that listens for online and offline announcements and uses the secure announcement endpoint.</span></span>  
  
> [!NOTE]
> <span data-ttu-id="cbf8d-146">如果 Setup.bat 运行多次，则因为存在多个证书，所以证书管理器会提示您选择要添加的证书。</span><span class="sxs-lookup"><span data-stu-id="cbf8d-146">If Setup.bat is run multiple times, the certificate manager prompts you for choosing a certificate to add, as there are duplicate certificates.</span></span> <span data-ttu-id="cbf8d-147">在这种情况下，应中止 Setup.bat 并调用 Cleanup.bat，因为已创建了重复项。</span><span class="sxs-lookup"><span data-stu-id="cbf8d-147">In that case, Setup.bat should be aborted and Cleanup.bat should be called, because the duplicates have already been created.</span></span> <span data-ttu-id="cbf8d-148">Cleanup.bat 还会提示您选择要删除的证书。</span><span class="sxs-lookup"><span data-stu-id="cbf8d-148">Cleanup.bat also prompts you to choose a certificate to delete.</span></span> <span data-ttu-id="cbf8d-149">从列表中选择证书并继续执行 Cleanup.bat，直至没有证书剩余。</span><span class="sxs-lookup"><span data-stu-id="cbf8d-149">Select a certificate from the list and continue executing Cleanup.bat until no certificates are remaining.</span></span>  
  
#### <a name="to-use-this-sample"></a><span data-ttu-id="cbf8d-150">使用此示例</span><span class="sxs-lookup"><span data-stu-id="cbf8d-150">To use this sample</span></span>  
  
1. <span data-ttu-id="cbf8d-151">从可视化工作室的开发人员命令提示符执行安装程序.bat 脚本。</span><span class="sxs-lookup"><span data-stu-id="cbf8d-151">Execute the Setup.bat script from a Developer Command Prompt for Visual Studio.</span></span> <span data-ttu-id="cbf8d-152">本示例使用证书对消息进行签名和验证。</span><span class="sxs-lookup"><span data-stu-id="cbf8d-152">The sample uses certificates to sign and verify messages.</span></span> <span data-ttu-id="cbf8d-153">该脚本使用 Makecert.exe 创建证书，然后使用 Certmgr.exe 安装这些证书。</span><span class="sxs-lookup"><span data-stu-id="cbf8d-153">The script creates the certificates using Makecert.exe and then installs them using Certmgr.exe.</span></span> <span data-ttu-id="cbf8d-154">该脚本必须使用管理员特权运行。</span><span class="sxs-lookup"><span data-stu-id="cbf8d-154">The script must be run with administrator privileges.</span></span>  
  
2. <span data-ttu-id="cbf8d-155">要生成和运行示例，请打开 Visual Studio 中的 Security.sln 文件，然后选择 **"全部重建**"。</span><span class="sxs-lookup"><span data-stu-id="cbf8d-155">To build and run the sample, open the Security.sln file in Visual Studio and choose **Rebuild All**.</span></span> <span data-ttu-id="cbf8d-156">更新解决方案属性以启动多个项目：选择除发现安全通道以外的所有项目的 **"开始"。**</span><span class="sxs-lookup"><span data-stu-id="cbf8d-156">Update the solution properties to start multiple projects: select **Start** for all projects except DiscoverySecureChannels.</span></span> <span data-ttu-id="cbf8d-157">正常运行解决方案。</span><span class="sxs-lookup"><span data-stu-id="cbf8d-157">Run the solution normally.</span></span>  
  
3. <span data-ttu-id="cbf8d-158">完成示例后，执行 Cleanup.bat 脚本移除为此示例创建的证书。</span><span class="sxs-lookup"><span data-stu-id="cbf8d-158">After you are done with the sample, execute the Cleanup.bat script that removes the certificates created for this sample.</span></span>  
  
> [!IMPORTANT]
> <span data-ttu-id="cbf8d-159">您的计算机上可能已安装这些示例。</span><span class="sxs-lookup"><span data-stu-id="cbf8d-159">The samples may already be installed on your machine.</span></span> <span data-ttu-id="cbf8d-160">在继续操作之前，请先检查以下（默认）目录：</span><span class="sxs-lookup"><span data-stu-id="cbf8d-160">Check for the following (default) directory before continuing.</span></span>  
>
> `<InstallDrive>:\WF_WCF_Samples`  
>
> <span data-ttu-id="cbf8d-161">如果此目录不存在，请转到[Windows 通信基础 （WCF） 和 Windows 工作流基础 （WF） 示例 .NET 框架 4](https://www.microsoft.com/download/details.aspx?id=21459)以下载[!INCLUDE[wf1](../../../../includes/wf1-md.md)]所有 Windows 通信基础 （WCF） 和示例。</span><span class="sxs-lookup"><span data-stu-id="cbf8d-161">If this directory does not exist, go to [Windows Communication Foundation (WCF) and Windows Workflow Foundation (WF) Samples for .NET Framework 4](https://www.microsoft.com/download/details.aspx?id=21459) to download all Windows Communication Foundation (WCF) and [!INCLUDE[wf1](../../../../includes/wf1-md.md)] samples.</span></span> <span data-ttu-id="cbf8d-162">此示例位于以下目录：</span><span class="sxs-lookup"><span data-stu-id="cbf8d-162">This sample is located in the following directory.</span></span>  
>
> `<InstallDrive>:\WF_WCF_Samples\WCF\Scenario\DiscoveryScenario`  
