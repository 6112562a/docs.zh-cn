---
title: 工作流服务主机内部机制
ms.date: 03/30/2017
ms.assetid: af44596f-bf6a-4149-9f04-08d8e8f45250
ms.openlocfilehash: 0596e15e27460a08f859ec3398afbeae752c86fc
ms.sourcegitcommit: 9b552addadfb57fab0b9e7852ed4f1f1b8a42f8e
ms.translationtype: MT
ms.contentlocale: zh-CN
ms.lasthandoff: 04/23/2019
ms.locfileid: "61984191"
---
# <a name="workflow-service-host-internals"></a><span data-ttu-id="76328-102">工作流服务主机内部机制</span><span class="sxs-lookup"><span data-stu-id="76328-102">Workflow Service Host Internals</span></span>
<span data-ttu-id="76328-103"><xref:System.ServiceModel.WorkflowServiceHost> 为工作流服务提供主机。</span><span class="sxs-lookup"><span data-stu-id="76328-103"><xref:System.ServiceModel.WorkflowServiceHost> provides a host for workflow services.</span></span> <span data-ttu-id="76328-104">它负责侦听传入消息并将这些消息路由到相应的工作流服务实例，控制空闲工作流的卸载与持久保留，等等。</span><span class="sxs-lookup"><span data-stu-id="76328-104">It is responsible for listening for incoming messages and routing them to the appropriate workflow service instance, it controls unloading and persisting of idle workflows, and more.</span></span> <span data-ttu-id="76328-105">本主题说明 WorkflowServiceHost 如何处理传入消息。</span><span class="sxs-lookup"><span data-stu-id="76328-105">This topic describes how WorkflowServiceHost processes incoming messages.</span></span>  
  
## <a name="workflowservicehost-overview"></a><span data-ttu-id="76328-106">WorkflowServiceHost 概述</span><span class="sxs-lookup"><span data-stu-id="76328-106">WorkflowServiceHost Overview</span></span>  

<span data-ttu-id="76328-107"><xref:System.ServiceModel.WorkflowServiceHost> 类用于承载工作流服务。</span><span class="sxs-lookup"><span data-stu-id="76328-107">The <xref:System.ServiceModel.WorkflowServiceHost> class is used to host workflow services.</span></span> <span data-ttu-id="76328-108">它侦听传入消息并将这些消息路由到相应的服务实例，创建新实例，或者根据需要从持久存储区加载现有实例。</span><span class="sxs-lookup"><span data-stu-id="76328-108">It listens for incoming messages and routes them to the appropriate service instance, creating new instances or loading existing instances from durable storage as needed.</span></span> <span data-ttu-id="76328-109">下图说明了较高的级别如何<xref:System.ServiceModel.WorkflowServiceHost>工作原理：</span><span class="sxs-lookup"><span data-stu-id="76328-109">The following diagram illustrates on a high level how <xref:System.ServiceModel.WorkflowServiceHost> works:</span></span> 
  
 ![图，显示工作流服务主机的概述。](./media/workflow-service-host-internals/workflow-service-host-high-level-overview.gif)  
  
 <span data-ttu-id="76328-111">此图演示 <xref:System.ServiceModel.WorkflowServiceHost> 从 .xamlx 文件加载工作流服务定义，并从配置文件加载配置信息。</span><span class="sxs-lookup"><span data-stu-id="76328-111">This diagram shows that <xref:System.ServiceModel.WorkflowServiceHost> loads workflow service definitions from .xamlx files and loads configuration information from a configuration file.</span></span> <span data-ttu-id="76328-112">它还会从跟踪配置文件加载跟踪配置。</span><span class="sxs-lookup"><span data-stu-id="76328-112">It also loads tracking configuration from the tracking profile.</span></span> <span data-ttu-id="76328-113"><xref:System.ServiceModel.WorkflowServiceHost> 公开允许您将控制操作发送到工作流实例的工作流控制终结点。</span><span class="sxs-lookup"><span data-stu-id="76328-113"><xref:System.ServiceModel.WorkflowServiceHost> exposes a workflow control endpoint which allows you to send control operations to workflow instances.</span></span>  <span data-ttu-id="76328-114">有关详细信息请参阅[流控制终结点示例](../../../../docs/framework/wcf/feature-details/workflow-control-endpoint.md)。</span><span class="sxs-lookup"><span data-stu-id="76328-114">For more information see [Workflow Control Endpoint sample](../../../../docs/framework/wcf/feature-details/workflow-control-endpoint.md).</span></span>  
  
 <span data-ttu-id="76328-115"><xref:System.ServiceModel.WorkflowServiceHost> 还公开侦听传入应用程序消息的应用程序终结点。</span><span class="sxs-lookup"><span data-stu-id="76328-115"><xref:System.ServiceModel.WorkflowServiceHost> also exposes application endpoints that listen for incoming application messages.</span></span> <span data-ttu-id="76328-116">当一个传入消息到达时，它将被发送到相应的工作流服务实例（如果当前已加载该实例）。</span><span class="sxs-lookup"><span data-stu-id="76328-116">When an incoming message arrives it is sent to the appropriate workflow service instance (if it is currently loaded).</span></span> <span data-ttu-id="76328-117">如果需要，还将创建一个新的工作流实例。</span><span class="sxs-lookup"><span data-stu-id="76328-117">If needed a new workflow instance is created.</span></span> <span data-ttu-id="76328-118">或者，如果某个现有实例已持久保留，则将从持久存储区加载它。</span><span class="sxs-lookup"><span data-stu-id="76328-118">Or if an existing instance has been persisted it is loaded from the persistence store.</span></span>  
  
## <a name="workflowservicehost-details"></a><span data-ttu-id="76328-119">WorkflowServiceHost 详细信息</span><span class="sxs-lookup"><span data-stu-id="76328-119">WorkflowServiceHost Details</span></span>  
 <span data-ttu-id="76328-120">下图显示如何<xref:System.ServiceModel.WorkflowServiceHost>处理消息的更多详细信息：</span><span class="sxs-lookup"><span data-stu-id="76328-120">The following diagram shows how <xref:System.ServiceModel.WorkflowServiceHost> handles messages in a bit more detail:</span></span>  
  
 ![图，显示工作流服务主机消息流。](./media/workflow-service-host-internals/workflow-service-host-message-flow.gif)  
  
 <span data-ttu-id="76328-122">此图演示了三个不同的终结点：应用程序终结点、工作流控制终结点和工作流承载终结点。</span><span class="sxs-lookup"><span data-stu-id="76328-122">This diagram shows three different endpoints, an application endpoint, a workflow control endpoint, and a workflow hosting endpoint.</span></span> <span data-ttu-id="76328-123">应用程序终结点可接收针对特定工作流实例绑定的消息。</span><span class="sxs-lookup"><span data-stu-id="76328-123">The application endpoint receives messages that are bound for a specific workflow instance.</span></span> <span data-ttu-id="76328-124">工作流控制终结点可侦听控制操作。</span><span class="sxs-lookup"><span data-stu-id="76328-124">The workflow control endpoint listens for control operations.</span></span> <span data-ttu-id="76328-125">工作流承载终结点可侦听导致 <xref:System.ServiceModel.WorkflowServiceHost> 加载和执行非服务工作流的消息。</span><span class="sxs-lookup"><span data-stu-id="76328-125">The workflow hosting endpoint listens for messages that cause <xref:System.ServiceModel.WorkflowServiceHost> to load and execute non-service workflows.</span></span> <span data-ttu-id="76328-126">如图所示，通过 WCF 运行时处理所有消息。</span><span class="sxs-lookup"><span data-stu-id="76328-126">As shown in the diagram all messages are processed through the WCF runtime.</span></span>  <span data-ttu-id="76328-127">使用 <xref:System.ServiceModel.Description.ServiceThrottlingBehavior.MaxConcurrentInstances%2A> 属性实现工作流服务实例限制。</span><span class="sxs-lookup"><span data-stu-id="76328-127">Workflow service instance throttling is achieved by using the <xref:System.ServiceModel.Description.ServiceThrottlingBehavior.MaxConcurrentInstances%2A> property.</span></span> <span data-ttu-id="76328-128">此属性将限制并发工作流服务实例的数量。</span><span class="sxs-lookup"><span data-stu-id="76328-128">This property will limit the number of concurrent workflow service instances.</span></span> <span data-ttu-id="76328-129">超过此限制后，对新工作流服务实例的任何其他请求或激活持久性工作流实例的请求将进行排队。</span><span class="sxs-lookup"><span data-stu-id="76328-129">When this throttle is exceeded any additional requests for new workflow service instances or requests to activate persisted workflow instances will be queued.</span></span> <span data-ttu-id="76328-130">按 FIFO 顺序处理排队的请求，无论是对新实例的请求还是对正在运行的持久性实例的请求。</span><span class="sxs-lookup"><span data-stu-id="76328-130">The queued requests are processed in FIFO order regardless of whether they are requests for a new instance or a running, persisted instance.</span></span> <span data-ttu-id="76328-131">加载主机策略信息，用于确定如何处理未处理的异常以及如何卸载和持久保留空闲工作流服务。</span><span class="sxs-lookup"><span data-stu-id="76328-131">Host policy information is loaded that determines how unhandled exceptions are dealt with, and how idle workflow services are unloaded and persisted.</span></span> <span data-ttu-id="76328-132">有关这些主题的详细信息请参阅[如何：配置工作流未经处理的异常行为使用 WorkflowServiceHost](../../../../docs/framework/wcf/feature-details/config-workflow-unhandled-exception-workflowservicehost.md)和[如何：使用 WorkflowServiceHost 配置空闲行为](../../../../docs/framework/wcf/feature-details/how-to-configure-idle-behavior-with-workflowservicehost.md)。</span><span class="sxs-lookup"><span data-stu-id="76328-132">For more information about these topics see [How to: Configure Workflow Unhandled Exception Behavior with WorkflowServiceHost](../../../../docs/framework/wcf/feature-details/config-workflow-unhandled-exception-workflowservicehost.md) and [How to: Configure Idle Behavior with WorkflowServiceHost](../../../../docs/framework/wcf/feature-details/how-to-configure-idle-behavior-with-workflowservicehost.md).</span></span> <span data-ttu-id="76328-133">根据主机策略持久化工作流实例，并在需要时重新加载这些实例。</span><span class="sxs-lookup"><span data-stu-id="76328-133">Workflow instances are persisted according to host policies and are reloaded when needed.</span></span> <span data-ttu-id="76328-134">工作流暂留，请参阅有关的详细信息：[如何：使用 WorkflowServiceHost 配置永久性](../../../../docs/framework/wcf/feature-details/how-to-configure-persistence-with-workflowservicehost.md)，[创建一个长时间运行的工作流服务](../../../../docs/framework/wcf/feature-details/creating-a-long-running-workflow-service.md)，和[工作流持久性](../../../../docs/framework/windows-workflow-foundation/workflow-persistence.md)。</span><span class="sxs-lookup"><span data-stu-id="76328-134">For more information about workflow persistence see: [How to: Configure Persistence with WorkflowServiceHost](../../../../docs/framework/wcf/feature-details/how-to-configure-persistence-with-workflowservicehost.md), [Creating a Long-running Workflow Service](../../../../docs/framework/wcf/feature-details/creating-a-long-running-workflow-service.md), and [Workflow Persistence](../../../../docs/framework/windows-workflow-foundation/workflow-persistence.md).</span></span>  
  
 <span data-ttu-id="76328-135">下图显示该流调用 WorkflowServiceHost.Open 时：</span><span class="sxs-lookup"><span data-stu-id="76328-135">The following illustration shows the flow when WorkflowServiceHost.Open is called:</span></span>  
  
 ![调用 WorkflowServiceHost.Open 时显示的流的关系图。](./media/workflow-service-host-internals/workflow-service-host-open.gif)  
  
 <span data-ttu-id="76328-137">从 XAML 加载工作流并创建活动树。</span><span class="sxs-lookup"><span data-stu-id="76328-137">The workflow is loaded from XAML and the activity tree is created.</span></span> <span data-ttu-id="76328-138"><xref:System.ServiceModel.WorkflowServiceHost> 将沿着活动树并创建服务描述。</span><span class="sxs-lookup"><span data-stu-id="76328-138"><xref:System.ServiceModel.WorkflowServiceHost> walks the activity tree and creates the service description.</span></span> <span data-ttu-id="76328-139">将配置应用到主机。</span><span class="sxs-lookup"><span data-stu-id="76328-139">Configuration is applied to the host.</span></span> <span data-ttu-id="76328-140">最后，主机开始侦听传入消息。</span><span class="sxs-lookup"><span data-stu-id="76328-140">Finally the host begins to listen for incoming messages.</span></span>  
  
 <span data-ttu-id="76328-141">下图演示了<xref:System.ServiceModel.WorkflowServiceHost>接收消息 cancreateinstance 设置为的 Receive 活动绑定时，会执行`true`:</span><span class="sxs-lookup"><span data-stu-id="76328-141">The following illustration shows what the <xref:System.ServiceModel.WorkflowServiceHost> does when it receives a message bound for a Receive activity that has CanCreateInstance set to `true`:</span></span>  
  
 ![决策树由呑主机时收到的消息和 CanCreateInstance 为 true。](./media/workflow-service-host-internals/workflow-service-host-receive-message-cancreateinstance.gif)  
  
 <span data-ttu-id="76328-143">消息到达，并由 WCF 通道堆栈进行处理。</span><span class="sxs-lookup"><span data-stu-id="76328-143">The message arrives and is processed by the WCF channel stack.</span></span> <span data-ttu-id="76328-144">检查控制器并执行相关查询。</span><span class="sxs-lookup"><span data-stu-id="76328-144">Throttles are checked and correlation queries are executed.</span></span> <span data-ttu-id="76328-145">如果为现有实例绑定消息，则传递此消息。</span><span class="sxs-lookup"><span data-stu-id="76328-145">If the message is bound for an existing instance the message is delivered.</span></span> <span data-ttu-id="76328-146">如果需要创建新实例，则检查 Receive 活动的 CanCreateInstance 属性。</span><span class="sxs-lookup"><span data-stu-id="76328-146">If a new instance needs to be created, the Receive activity’s CanCreateInstance property is checked.</span></span> <span data-ttu-id="76328-147">如果此属性设置为 True，则将创建新实例并传递消息。</span><span class="sxs-lookup"><span data-stu-id="76328-147">If it is set to true, a new instance is created and the message is delivered.</span></span>  
  
 <span data-ttu-id="76328-148">下图演示了当 <xref:System.ServiceModel.WorkflowServiceHost> 接收到针对 CanCreateInstance 设置为 false 的 Receive 活动绑定的消息时，它所执行的操作。</span><span class="sxs-lookup"><span data-stu-id="76328-148">The following illustration shows what the <xref:System.ServiceModel.WorkflowServiceHost> does when it receives a message bound for a Receive activity that has CanCreateInstance set to false.</span></span>  
  
 ![决策树由呑主机时收到的消息和 CanCreateInstance 为 false。](./media/workflow-service-host-internals/workflow-service-host-receive-message.gif)  
  
 <span data-ttu-id="76328-150">消息到达，并由 WCF 通道堆栈进行处理。</span><span class="sxs-lookup"><span data-stu-id="76328-150">The message arrives and is processed by the WCF channel stack.</span></span> <span data-ttu-id="76328-151">检查控制器并执行相关查询。</span><span class="sxs-lookup"><span data-stu-id="76328-151">Throttles are checked and correlation queries are executed.</span></span> <span data-ttu-id="76328-152">为某个现有实例绑定消息（因为 CanCreateInstance 为 False），以便从持久存储区加载该实例，恢复书签并执行工作流。</span><span class="sxs-lookup"><span data-stu-id="76328-152">The message is bound for an existing instance (because CanCreateInstance is false) so the instance is loaded from persistence store, the bookmark is resumed and the workflow executes.</span></span>  
  
> [!WARNING]
> <span data-ttu-id="76328-153">如果 SQL Server 配置为仅侦听 NamedPipe 协议，则工作流服务主机将打开失败。</span><span class="sxs-lookup"><span data-stu-id="76328-153">Workflow Service Host will fail to open if SQL Server is configured to listen on NamedPipe protocol only.</span></span>  
  
## <a name="see-also"></a><span data-ttu-id="76328-154">请参阅</span><span class="sxs-lookup"><span data-stu-id="76328-154">See also</span></span>

- [<span data-ttu-id="76328-155">工作流服务</span><span class="sxs-lookup"><span data-stu-id="76328-155">Workflow Services</span></span>](../../../../docs/framework/wcf/feature-details/workflow-services.md)
- [<span data-ttu-id="76328-156">承载工作流服务</span><span class="sxs-lookup"><span data-stu-id="76328-156">Hosting Workflow Services</span></span>](../../../../docs/framework/wcf/feature-details/hosting-workflow-services.md)
- [<span data-ttu-id="76328-157">工作流控制终结点</span><span class="sxs-lookup"><span data-stu-id="76328-157">Workflow Control Endpoint</span></span>](../../../../docs/framework/wcf/feature-details/workflow-control-endpoint.md)
- [<span data-ttu-id="76328-158">如何：配置工作流未经处理的异常行为使用 WorkflowServiceHost</span><span class="sxs-lookup"><span data-stu-id="76328-158">How to: Configure Workflow Unhandled Exception Behavior with WorkflowServiceHost</span></span>](../../../../docs/framework/wcf/feature-details/config-workflow-unhandled-exception-workflowservicehost.md)
- [<span data-ttu-id="76328-159">创建长时间运行的工作流服务</span><span class="sxs-lookup"><span data-stu-id="76328-159">Creating a Long-running Workflow Service</span></span>](../../../../docs/framework/wcf/feature-details/creating-a-long-running-workflow-service.md)
- [<span data-ttu-id="76328-160">工作流暂留</span><span class="sxs-lookup"><span data-stu-id="76328-160">Workflow Persistence</span></span>](../../../../docs/framework/windows-workflow-foundation/workflow-persistence.md)
