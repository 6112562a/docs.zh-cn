---
title: WCF 的委派和模拟
ms.date: 03/30/2017
dev_langs:
- csharp
- vb
helpviewer_keywords:
- impersonation [WCF]
- delegation [WCF]
ms.assetid: 110e60f7-5b03-4b69-b667-31721b8e3152
ms.openlocfilehash: 6e79346a448012255020cc28b6534e734980b1db
ms.sourcegitcommit: 68653db98c5ea7744fd438710248935f70020dfb
ms.translationtype: MT
ms.contentlocale: zh-CN
ms.lasthandoff: 08/22/2019
ms.locfileid: "69968851"
---
# <a name="delegation-and-impersonation-with-wcf"></a><span data-ttu-id="72ceb-102">WCF 的委派和模拟</span><span class="sxs-lookup"><span data-stu-id="72ceb-102">Delegation and Impersonation with WCF</span></span>
<span data-ttu-id="72ceb-103">模拟 是一种常用技术，服务可使用该技术限制客户端对服务域资源的访问。</span><span class="sxs-lookup"><span data-stu-id="72ceb-103">*Impersonation* is a common technique that services use to restrict client access to a service domain's resources.</span></span> <span data-ttu-id="72ceb-104">服务域资源可以是计算机资源，如本地文件（模拟），也可以是其他计算机上的资源，如文件共享（委托）。</span><span class="sxs-lookup"><span data-stu-id="72ceb-104">Service domain resources can either be machine resources, such as local files (impersonation), or a resource on another machine, such as a file share (delegation).</span></span> <span data-ttu-id="72ceb-105">有关示例应用程序，请参见 [Impersonating the Client](../../../../docs/framework/wcf/samples/impersonating-the-client.md)。</span><span class="sxs-lookup"><span data-stu-id="72ceb-105">For a sample application, see [Impersonating the Client](../../../../docs/framework/wcf/samples/impersonating-the-client.md).</span></span> <span data-ttu-id="72ceb-106">有关如何使用模拟的示例, 请参阅[如何:模拟服务](../../../../docs/framework/wcf/how-to-impersonate-a-client-on-a-service.md)上的客户端。</span><span class="sxs-lookup"><span data-stu-id="72ceb-106">For an example of how to use impersonation, see [How to: Impersonate a Client on a Service](../../../../docs/framework/wcf/how-to-impersonate-a-client-on-a-service.md).</span></span>  
  
> [!IMPORTANT]
> <span data-ttu-id="72ceb-107">请注意，在对某一服务模拟客户端时，该服务会使用客户端的凭据运行，因此可能具有高于服务器进程的权限。</span><span class="sxs-lookup"><span data-stu-id="72ceb-107">Be aware that when impersonating a client on a service, the service runs with the client's credentials, which may have higher privileges than the server process.</span></span>  
  
## <a name="overview"></a><span data-ttu-id="72ceb-108">概述</span><span class="sxs-lookup"><span data-stu-id="72ceb-108">Overview</span></span>  
 <span data-ttu-id="72ceb-109">通常，客户端会调用某个服务，使该服务代表客户端执行某个操作。</span><span class="sxs-lookup"><span data-stu-id="72ceb-109">Typically, clients call a service to have the service perform some action on the client’s behalf.</span></span> <span data-ttu-id="72ceb-110">模拟使服务可在执行操作时充当客户端。</span><span class="sxs-lookup"><span data-stu-id="72ceb-110">Impersonation allows the service to act as the client while performing the action.</span></span> <span data-ttu-id="72ceb-111">委托使前端服务可采用某种方式将客户端的请求转发到后端服务，以使后端服务也能模拟客户端。</span><span class="sxs-lookup"><span data-stu-id="72ceb-111">Delegation allows a front-end service to forward the client’s request to a back-end service in such a way that the back-end service can also impersonate the client.</span></span> <span data-ttu-id="72ceb-112">模拟是检查客户端是否有权执行特定操作的最常用的方法，而委托是一种使模拟功能以及客户端的标识流向后端服务的方法。</span><span class="sxs-lookup"><span data-stu-id="72ceb-112">Impersonation is most commonly used as a way of checking whether a client is authorized to perform a particular action, while delegation is a way of flowing impersonation capabilities, along with the client’s identity, to a back-end service.</span></span> <span data-ttu-id="72ceb-113">委托是一种 Windows 域功能，可在执行基于 Kerberos 的身份验证时使用。</span><span class="sxs-lookup"><span data-stu-id="72ceb-113">Delegation is a Windows domain feature that can be used when Kerberos-based authentication is performed.</span></span> <span data-ttu-id="72ceb-114">委托不同于标识流，因为委托可传送无需拥有客户端密码即可模拟客户端的能力。与标识流相比，委托是一种权限更高的操作。</span><span class="sxs-lookup"><span data-stu-id="72ceb-114">Delegation is distinct from identity flow and, because delegation transfers the ability to impersonate the client without possession of the client’s password, it is a much higher privileged operation than identity flow.</span></span>  
  
 <span data-ttu-id="72ceb-115">模拟和委托都要求客户端具有 Windows 标识。</span><span class="sxs-lookup"><span data-stu-id="72ceb-115">Both impersonation and delegation require that the client have a Windows identity.</span></span> <span data-ttu-id="72ceb-116">如果客户端没有 Windows 标识，则唯一的选择就是使客户端的标识流向第二个服务。</span><span class="sxs-lookup"><span data-stu-id="72ceb-116">If a client does not possess a Windows identity, then the only option available is to flow the client’s identity to the second service.</span></span>  
  
## <a name="impersonation-basics"></a><span data-ttu-id="72ceb-117">模拟基础知识</span><span class="sxs-lookup"><span data-stu-id="72ceb-117">Impersonation Basics</span></span>  
 <span data-ttu-id="72ceb-118">Windows Communication Foundation (WCF) 支持模拟各种客户端凭据。</span><span class="sxs-lookup"><span data-stu-id="72ceb-118">Windows Communication Foundation (WCF) supports impersonation for a variety of client credentials.</span></span> <span data-ttu-id="72ceb-119">本主题说明在实现某一服务方法的过程中支持模拟调用方的服务模型。</span><span class="sxs-lookup"><span data-stu-id="72ceb-119">This topic describes service model support for impersonating the caller during the implementation of a service method.</span></span> <span data-ttu-id="72ceb-120">本文还讨论了涉及模拟和 SOAP 安全的常见部署方案以及这些方案中的 WCF 选项。</span><span class="sxs-lookup"><span data-stu-id="72ceb-120">Also discussed are common deployment scenarios involving impersonation and SOAP security and WCF options in these scenarios.</span></span>  
  
 <span data-ttu-id="72ceb-121">本主题重点介绍使用 SOAP 安全时 WCF 中的模拟和委托。</span><span class="sxs-lookup"><span data-stu-id="72ceb-121">This topic focuses on impersonation and delegation in WCF when using SOAP security.</span></span> <span data-ttu-id="72ceb-122">使用传输安全时, 还可以对 WCF 使用模拟和委托, 如在[传输安全中使用模拟](../../../../docs/framework/wcf/feature-details/using-impersonation-with-transport-security.md)中所述。</span><span class="sxs-lookup"><span data-stu-id="72ceb-122">You can also use impersonation and delegation with WCF when using transport security, as described in [Using Impersonation with Transport Security](../../../../docs/framework/wcf/feature-details/using-impersonation-with-transport-security.md).</span></span>  
  
## <a name="two-methods"></a><span data-ttu-id="72ceb-123">两种方法</span><span class="sxs-lookup"><span data-stu-id="72ceb-123">Two Methods</span></span>  
 <span data-ttu-id="72ceb-124">WCF SOAP 安全性有两种不同的方法来执行模拟。</span><span class="sxs-lookup"><span data-stu-id="72ceb-124">WCF SOAP security has two distinct methods for performing impersonation.</span></span> <span data-ttu-id="72ceb-125">所用的方法取决于绑定。</span><span class="sxs-lookup"><span data-stu-id="72ceb-125">The method used depends on the binding.</span></span> <span data-ttu-id="72ceb-126">一种方法是从 Windows 令牌模拟，此令牌从安全支持提供程序接口 (SSPI) 或 Kerberos 身份验证获取，然后在服务上缓存。</span><span class="sxs-lookup"><span data-stu-id="72ceb-126">One is impersonation from a Windows token obtained from the Security Support Provider Interface (SSPI) or Kerberos authentication, which is then cached on the service.</span></span> <span data-ttu-id="72ceb-127">另一种方法是从 Windows 令牌模拟，此令牌从 Kerberos 扩展获取，统称为“Service-for-User” (S4U)。</span><span class="sxs-lookup"><span data-stu-id="72ceb-127">The second is impersonation from a Windows token obtained from the Kerberos extensions, collectively called *Service-for-User* (S4U).</span></span>  
  
### <a name="cached-token-impersonation"></a><span data-ttu-id="72ceb-128">缓存的令牌模拟</span><span class="sxs-lookup"><span data-stu-id="72ceb-128">Cached Token Impersonation</span></span>  
 <span data-ttu-id="72ceb-129">您可以对以下各项执行缓存的令牌模拟：</span><span class="sxs-lookup"><span data-stu-id="72ceb-129">You can perform cached-token impersonation with the following:</span></span>  
  
- <span data-ttu-id="72ceb-130">使用 Windows 客户端凭据的<xref:System.ServiceModel.WSHttpBinding>, <xref:System.ServiceModel.WSDualHttpBinding>和 <xref:System.ServiceModel.NetTcpBinding> 。</span><span class="sxs-lookup"><span data-stu-id="72ceb-130"><xref:System.ServiceModel.WSHttpBinding>, <xref:System.ServiceModel.WSDualHttpBinding>, and <xref:System.ServiceModel.NetTcpBinding> with a Windows client credential.</span></span>  
  
- <span data-ttu-id="72ceb-131"><xref:System.ServiceModel.BasicHttpBinding> 设置为 <xref:System.ServiceModel.BasicHttpSecurityMode> 凭据的 <xref:System.ServiceModel.BasicHttpSecurityMode.TransportWithMessageCredential> ，或任何其他标准绑定，其中客户端提供用户名凭据（服务可以将该凭据映射到有效的 Windows 帐户）。</span><span class="sxs-lookup"><span data-stu-id="72ceb-131"><xref:System.ServiceModel.BasicHttpBinding> with a <xref:System.ServiceModel.BasicHttpSecurityMode> set to the <xref:System.ServiceModel.BasicHttpSecurityMode.TransportWithMessageCredential> credential, or any other standard binding where the client presents a user name credential that the service can map to a valid Windows account.</span></span>  
  
- <span data-ttu-id="72ceb-132">使用 Windows 凭据并且 <xref:System.ServiceModel.Channels.CustomBinding> 设置为 `requireCancellation` 的任何 `true`。</span><span class="sxs-lookup"><span data-stu-id="72ceb-132">Any <xref:System.ServiceModel.Channels.CustomBinding> that uses a Windows client credential with the `requireCancellation` set to `true`.</span></span> <span data-ttu-id="72ceb-133">（此属性在以下类中可用：<xref:System.ServiceModel.Security.Tokens.SecureConversationSecurityTokenParameters>、<xref:System.ServiceModel.Security.Tokens.SslSecurityTokenParameters> 和 <xref:System.ServiceModel.Security.Tokens.SspiSecurityTokenParameters>。）如果在绑定上使用安全对话，则安全对话还必须将 `requireCancellation` 属性设置为 `true`。</span><span class="sxs-lookup"><span data-stu-id="72ceb-133">(The property is available on the following classes: <xref:System.ServiceModel.Security.Tokens.SecureConversationSecurityTokenParameters>, <xref:System.ServiceModel.Security.Tokens.SslSecurityTokenParameters>, and <xref:System.ServiceModel.Security.Tokens.SspiSecurityTokenParameters>.) If a secure conversation is used on the binding, it must also have the `requireCancellation` property set to `true`.</span></span>  
  
- <span data-ttu-id="72ceb-134">任何 <xref:System.ServiceModel.Channels.CustomBinding> ，其中客户端提供用户名凭据。</span><span class="sxs-lookup"><span data-stu-id="72ceb-134">Any <xref:System.ServiceModel.Channels.CustomBinding> where the client presents a user name credential.</span></span> <span data-ttu-id="72ceb-135">如果在绑定中使用安全对话，则安全对话还必须将 `requireCancellation` 属性设置为 `true`。</span><span class="sxs-lookup"><span data-stu-id="72ceb-135">If secure conversation is used on the binding, it must also have the `requireCancellation` property set to `true`.</span></span>  
  
### <a name="s4u-based-impersonation"></a><span data-ttu-id="72ceb-136">基于 S4U 的模拟</span><span class="sxs-lookup"><span data-stu-id="72ceb-136">S4U-Based Impersonation</span></span>  
 <span data-ttu-id="72ceb-137">您可以对以下各项执行基于 S4U 的模拟：</span><span class="sxs-lookup"><span data-stu-id="72ceb-137">You can perform S4U-based impersonation with the following:</span></span>  
  
- <span data-ttu-id="72ceb-138">使用证书客户端凭据（服务可以将该凭据映射到有效的 Windows 帐户）的<xref:System.ServiceModel.WSHttpBinding>, <xref:System.ServiceModel.WSDualHttpBinding>和 <xref:System.ServiceModel.NetTcpBinding> 。</span><span class="sxs-lookup"><span data-stu-id="72ceb-138"><xref:System.ServiceModel.WSHttpBinding>, <xref:System.ServiceModel.WSDualHttpBinding>, and <xref:System.ServiceModel.NetTcpBinding> with a certificate client credential that the service can map to a valid Windows account.</span></span>  
  
- <span data-ttu-id="72ceb-139">使用 Windows 凭据并且 <xref:System.ServiceModel.Channels.CustomBinding> 属性设置为 `requireCancellation` 的任何 `false`。</span><span class="sxs-lookup"><span data-stu-id="72ceb-139">Any <xref:System.ServiceModel.Channels.CustomBinding> that uses a Windows client credential with the `requireCancellation` property set to `false`.</span></span>  
  
- <span data-ttu-id="72ceb-140">使用用户名或 Windows 客户端凭据和安全对话，并且 <xref:System.ServiceModel.Channels.CustomBinding> 属性设置为 `requireCancellation` 的任何 `false`。</span><span class="sxs-lookup"><span data-stu-id="72ceb-140">Any <xref:System.ServiceModel.Channels.CustomBinding> that uses a user name or Windows client credential and secure conversation with the `requireCancellation` property set to `false`.</span></span>  
  
 <span data-ttu-id="72ceb-141">服务可以模拟客户端的范围取决于服务帐户在尝试模拟时拥有的权限、使用的模拟类型和客户端可能允许的模拟范围。</span><span class="sxs-lookup"><span data-stu-id="72ceb-141">The extent to which the service can impersonate the client depends on the privileges the service account holds when it attempts impersonation, the type of impersonation used, and possibly the extent of impersonation the client permits.</span></span>  
  
> [!NOTE]
> <span data-ttu-id="72ceb-142">当客户端和服务在同一计算机上运行，并且客户端在系统帐户（例如 `Local System` 或 `Network Service`）下运行时，如果安全会话是使用有状态安全上下文令牌建立的，则不能模拟客户端。</span><span class="sxs-lookup"><span data-stu-id="72ceb-142">When the client and service are running on the same computer and the client is running under a system account (for example, `Local System` or `Network Service`), the client cannot be impersonated when a secure session is established with stateful Security Context tokens.</span></span> <span data-ttu-id="72ceb-143">Windows 窗体或控制台应用程序通常在当前登录的帐户下运行，因此默认情况下可以模拟该帐户。</span><span class="sxs-lookup"><span data-stu-id="72ceb-143">A Windows Form or console application typically runs under the currently logged-in account, so that account can be impersonated by default.</span></span> <span data-ttu-id="72ceb-144">但是, 当客户端为 ASP.NET 页, 并且该页承载在 iis 6.0 或 iis 7.0 中时, 默认情况下, 客户端将`Network Service`在帐户下运行。</span><span class="sxs-lookup"><span data-stu-id="72ceb-144">However, when the client is an ASP.NET page and that page is hosted in IIS 6.0 or IIS 7.0, then the client does run under the `Network Service` account by default.</span></span> <span data-ttu-id="72ceb-145">默认情况下，系统提供的所有支持安全会话的绑定都使用无状态安全上下文令牌 (SCT)。</span><span class="sxs-lookup"><span data-stu-id="72ceb-145">All of the system-provided bindings that support secure sessions use a stateless security context token (SCT) by default.</span></span> <span data-ttu-id="72ceb-146">但是, 如果客户端是 ASP.NET 页, 并且使用了具有有状态 Sct 的安全会话, 则不能模拟客户端。</span><span class="sxs-lookup"><span data-stu-id="72ceb-146">However, if the client is an ASP.NET page, and secure sessions with stateful SCTs are used, the client cannot be impersonated.</span></span> <span data-ttu-id="72ceb-147">有关在安全会话中使用有状态 sct 的详细信息, [请参阅如何:创建安全会话](../../../../docs/framework/wcf/feature-details/how-to-create-a-security-context-token-for-a-secure-session.md)的安全上下文令牌。</span><span class="sxs-lookup"><span data-stu-id="72ceb-147">For more information about using stateful SCTs in a secure session, see [How to: Create a Security Context Token for a Secure Session](../../../../docs/framework/wcf/feature-details/how-to-create-a-security-context-token-for-a-secure-session.md).</span></span>  
  
## <a name="impersonation-in-a-service-method-declarative-model"></a><span data-ttu-id="72ceb-148">服务方法中的模拟:声明性模型</span><span class="sxs-lookup"><span data-stu-id="72ceb-148">Impersonation in a Service Method: Declarative Model</span></span>  
 <span data-ttu-id="72ceb-149">大多数模拟方案都涉及在调用方上下文中执行服务方法。</span><span class="sxs-lookup"><span data-stu-id="72ceb-149">Most impersonation scenarios involve executing the service method in the caller context.</span></span> <span data-ttu-id="72ceb-150">WCF 提供了模拟功能, 使用户可以在<xref:System.ServiceModel.OperationBehaviorAttribute>属性中指定模拟要求, 从而轻松实现此目的。</span><span class="sxs-lookup"><span data-stu-id="72ceb-150">WCF provides an impersonation feature that makes this easy to do by allowing the user to specify the impersonation requirement in the <xref:System.ServiceModel.OperationBehaviorAttribute> attribute.</span></span> <span data-ttu-id="72ceb-151">例如, 在下面的代码中, WCF 基础结构在执行`Hello`方法之前模拟调用方。</span><span class="sxs-lookup"><span data-stu-id="72ceb-151">For example, in the following code, the WCF infrastructure impersonates the caller before executing the `Hello` method.</span></span> <span data-ttu-id="72ceb-152">只有当本机资源的访问控制列表 (ACL) 允许调用方访问权限时，在 `Hello` 方法内访问该本机资源的任何尝试才能成功。</span><span class="sxs-lookup"><span data-stu-id="72ceb-152">Any attempt to access native resources inside the `Hello` method succeed only if the access control list (ACL) of the resource allows the caller access privileges.</span></span> <span data-ttu-id="72ceb-153">若要启用模拟，请将 <xref:System.ServiceModel.OperationBehaviorAttribute.Impersonation%2A> 属性设置为 <xref:System.ServiceModel.ImpersonationOption> 枚举值之一（ <xref:System.ServiceModel.ImpersonationOption.Required?displayProperty=nameWithType> 或 <xref:System.ServiceModel.ImpersonationOption.Allowed?displayProperty=nameWithType>），如下面的示例所示。</span><span class="sxs-lookup"><span data-stu-id="72ceb-153">To enable impersonation, set the <xref:System.ServiceModel.OperationBehaviorAttribute.Impersonation%2A> property to one of the <xref:System.ServiceModel.ImpersonationOption> enumeration values, either <xref:System.ServiceModel.ImpersonationOption.Required?displayProperty=nameWithType> or <xref:System.ServiceModel.ImpersonationOption.Allowed?displayProperty=nameWithType>, as shown in the following example.</span></span>  
  
> [!NOTE]
> <span data-ttu-id="72ceb-154">当服务具有比远程客户端更高的凭据时，在 <xref:System.ServiceModel.OperationBehaviorAttribute.Impersonation%2A> 属性设置为 <xref:System.ServiceModel.ImpersonationOption.Allowed>的情况下将使用服务的凭据。</span><span class="sxs-lookup"><span data-stu-id="72ceb-154">When a service has higher credentials than the remote client, the credentials of the service are used if the <xref:System.ServiceModel.OperationBehaviorAttribute.Impersonation%2A> property is set to <xref:System.ServiceModel.ImpersonationOption.Allowed>.</span></span> <span data-ttu-id="72ceb-155">也就是说，如果低权限的用户提供其凭据，则较高权限的服务会使用服务的凭据执行该方法，并可以使用低权限的用户不能使用的资源。</span><span class="sxs-lookup"><span data-stu-id="72ceb-155">That is, if a low-privileged user provides its credentials, a higher-privileged service executes the method with the credentials of the service, and can use resources that the low-privileged user would otherwise not be able to use.</span></span>  
  
 [!code-csharp[c_ImpersonationAndDelegation#1](../../../../samples/snippets/csharp/VS_Snippets_CFX/c_impersonationanddelegation/cs/source.cs#1)]
 [!code-vb[c_ImpersonationAndDelegation#1](../../../../samples/snippets/visualbasic/VS_Snippets_CFX/c_impersonationanddelegation/vb/source.vb#1)]  
  
 <span data-ttu-id="72ceb-156">仅当调用方使用可以映射到 Windows 用户帐户的凭据进行身份验证时, WCF 基础结构才能模拟调用方。</span><span class="sxs-lookup"><span data-stu-id="72ceb-156">The WCF infrastructure can impersonate the caller only if the caller is authenticated with credentials that can be mapped to a Windows user account.</span></span> <span data-ttu-id="72ceb-157">如果将服务配置为使用无法映射到 Windows 用户帐户的凭据进行身份验证，则不会执行服务方法。</span><span class="sxs-lookup"><span data-stu-id="72ceb-157">If the service is configured to authenticate using a credential that cannot be mapped to a Windows account, the service method is not executed.</span></span>  
  
> [!NOTE]
> <span data-ttu-id="72ceb-158">在 [!INCLUDE[wxp](../../../../includes/wxp-md.md)]中，如果创建了有状态 SCT，则模拟会失败，导致 <xref:System.InvalidOperationException>。</span><span class="sxs-lookup"><span data-stu-id="72ceb-158">On [!INCLUDE[wxp](../../../../includes/wxp-md.md)], impersonation fails if a stateful SCT is created, resulting in an <xref:System.InvalidOperationException>.</span></span> <span data-ttu-id="72ceb-159">有关详细信息, 请参阅[不支持的方案](../../../../docs/framework/wcf/feature-details/unsupported-scenarios.md)。</span><span class="sxs-lookup"><span data-stu-id="72ceb-159">For more information, see [Unsupported Scenarios](../../../../docs/framework/wcf/feature-details/unsupported-scenarios.md).</span></span>  
  
## <a name="impersonation-in-a-service-method-imperative-model"></a><span data-ttu-id="72ceb-160">服务方法中的模拟:命令性模型</span><span class="sxs-lookup"><span data-stu-id="72ceb-160">Impersonation in a Service Method: Imperative Model</span></span>  
 <span data-ttu-id="72ceb-161">有时，调用方不需要模拟整个服务方法，只需模拟它的一部分就行。</span><span class="sxs-lookup"><span data-stu-id="72ceb-161">Sometimes a caller does not need to impersonate the entire service method to function, but for only a portion of it.</span></span> <span data-ttu-id="72ceb-162">在这种情况下，请获取服务方法中调用方的 Windows 标识并以强制方式执行模拟。</span><span class="sxs-lookup"><span data-stu-id="72ceb-162">In this case, obtain the Windows identity of the caller inside the service method and imperatively perform the impersonation.</span></span> <span data-ttu-id="72ceb-163">为此，请使用 <xref:System.ServiceModel.ServiceSecurityContext.WindowsIdentity%2A> 的 <xref:System.ServiceModel.ServiceSecurityContext> 属性返回 <xref:System.Security.Principal.WindowsIdentity> 类的实例并在使用该实例前调用 <xref:System.Security.Principal.WindowsIdentity.Impersonate%2A> 方法。</span><span class="sxs-lookup"><span data-stu-id="72ceb-163">Do this by using the <xref:System.ServiceModel.ServiceSecurityContext.WindowsIdentity%2A> property of the <xref:System.ServiceModel.ServiceSecurityContext> to return an instance of the <xref:System.Security.Principal.WindowsIdentity> class and calling the <xref:System.Security.Principal.WindowsIdentity.Impersonate%2A> method before using the instance.</span></span>  
  
> [!NOTE]
> <span data-ttu-id="72ceb-164">请确保使用 Visual Basic`Using`语句C# `using`或语句以自动还原模拟操作。</span><span class="sxs-lookup"><span data-stu-id="72ceb-164">Be sure to use the Visual Basic`Using` statement or the C# `using` statement to automatically revert the impersonation action.</span></span> <span data-ttu-id="72ceb-165">如果不使用语句, 或者使用 Visual Basic 或C#以外的编程语言, 请确保还原模拟级别。</span><span class="sxs-lookup"><span data-stu-id="72ceb-165">If you do not use the statement, or if you use a programming language other than Visual Basic or C#, be sure to revert the impersonation level.</span></span> <span data-ttu-id="72ceb-166">否则可导致拒绝服务和特权升级攻击。</span><span class="sxs-lookup"><span data-stu-id="72ceb-166">Failure to do this can form the basis for denial of service and elevation of privilege attacks.</span></span>  
  
 [!code-csharp[c_ImpersonationAndDelegation#2](../../../../samples/snippets/csharp/VS_Snippets_CFX/c_impersonationanddelegation/cs/source.cs#2)]
 [!code-vb[c_ImpersonationAndDelegation#2](../../../../samples/snippets/visualbasic/VS_Snippets_CFX/c_impersonationanddelegation/vb/source.vb#2)]  
  
## <a name="impersonation-for-all-service-methods"></a><span data-ttu-id="72ceb-167">所有服务方法的模拟</span><span class="sxs-lookup"><span data-stu-id="72ceb-167">Impersonation for All Service Methods</span></span>  
 <span data-ttu-id="72ceb-168">在某些情况下，您必须在调用方上下文中执行服务的所有方法。</span><span class="sxs-lookup"><span data-stu-id="72ceb-168">In some cases, you must perform all the methods of a service in the caller’s context.</span></span> <span data-ttu-id="72ceb-169">如果不想逐个方法地显式启用此功能，可以使用 <xref:System.ServiceModel.Description.ServiceAuthorizationBehavior>。</span><span class="sxs-lookup"><span data-stu-id="72ceb-169">Instead of explicitly enabling this feature on a per-method basis, use the <xref:System.ServiceModel.Description.ServiceAuthorizationBehavior>.</span></span> <span data-ttu-id="72ceb-170">如下面的代码所示，将 <xref:System.ServiceModel.Description.ServiceAuthorizationBehavior.ImpersonateCallerForAllOperations%2A> 属性设置为 `true`。</span><span class="sxs-lookup"><span data-stu-id="72ceb-170">As shown in the following code, set the <xref:System.ServiceModel.Description.ServiceAuthorizationBehavior.ImpersonateCallerForAllOperations%2A> property to `true`.</span></span> <span data-ttu-id="72ceb-171">即会从 <xref:System.ServiceModel.Description.ServiceAuthorizationBehavior> 类的行为集合中检索 <xref:System.ServiceModel.ServiceHost> 。</span><span class="sxs-lookup"><span data-stu-id="72ceb-171">The <xref:System.ServiceModel.Description.ServiceAuthorizationBehavior> is retrieved from the collections of behaviors of the <xref:System.ServiceModel.ServiceHost> class.</span></span> <span data-ttu-id="72ceb-172">另外请注意，应用于每个方法的 `Impersonation` 的 <xref:System.ServiceModel.OperationBehaviorAttribute> 属性也必须设置为 <xref:System.ServiceModel.ImpersonationOption.Allowed> 或 <xref:System.ServiceModel.ImpersonationOption.Required>。</span><span class="sxs-lookup"><span data-stu-id="72ceb-172">Also note that the `Impersonation` property of the <xref:System.ServiceModel.OperationBehaviorAttribute> applied to each method must also be set to either <xref:System.ServiceModel.ImpersonationOption.Allowed> or <xref:System.ServiceModel.ImpersonationOption.Required>.</span></span>  
  
 [!code-csharp[c_ImpersonationAndDelegation#3](../../../../samples/snippets/csharp/VS_Snippets_CFX/c_impersonationanddelegation/cs/source.cs#3)]
 [!code-vb[c_ImpersonationAndDelegation#3](../../../../samples/snippets/visualbasic/VS_Snippets_CFX/c_impersonationanddelegation/vb/source.vb#3)]  
  
 <span data-ttu-id="72ceb-173">下表描述了和`ImpersonationOption` `ImpersonateCallerForAllServiceOperations`的所有可能组合的 WCF 行为。</span><span class="sxs-lookup"><span data-stu-id="72ceb-173">The following table describes WCF behavior for all possible combinations of `ImpersonationOption` and `ImpersonateCallerForAllServiceOperations`.</span></span>  
  
|`ImpersonationOption`|`ImpersonateCallerForAllServiceOperations`|<span data-ttu-id="72ceb-174">行为</span><span class="sxs-lookup"><span data-stu-id="72ceb-174">Behavior</span></span>|  
|---------------------------|------------------------------------------------|--------------|  
|<span data-ttu-id="72ceb-175">必需</span><span class="sxs-lookup"><span data-stu-id="72ceb-175">Required</span></span>|<span data-ttu-id="72ceb-176">n/a</span><span class="sxs-lookup"><span data-stu-id="72ceb-176">n/a</span></span>|<span data-ttu-id="72ceb-177">WCF 模拟调用方</span><span class="sxs-lookup"><span data-stu-id="72ceb-177">WCF impersonates the caller</span></span>|  
|<span data-ttu-id="72ceb-178">Allowed</span><span class="sxs-lookup"><span data-stu-id="72ceb-178">Allowed</span></span>|<span data-ttu-id="72ceb-179">假</span><span class="sxs-lookup"><span data-stu-id="72ceb-179">false</span></span>|<span data-ttu-id="72ceb-180">WCF 不模拟调用方</span><span class="sxs-lookup"><span data-stu-id="72ceb-180">WCF does not impersonate the caller</span></span>|  
|<span data-ttu-id="72ceb-181">Allowed</span><span class="sxs-lookup"><span data-stu-id="72ceb-181">Allowed</span></span>|<span data-ttu-id="72ceb-182">真</span><span class="sxs-lookup"><span data-stu-id="72ceb-182">true</span></span>|<span data-ttu-id="72ceb-183">WCF 模拟调用方</span><span class="sxs-lookup"><span data-stu-id="72ceb-183">WCF impersonates the caller</span></span>|  
|<span data-ttu-id="72ceb-184">NotAllowed</span><span class="sxs-lookup"><span data-stu-id="72ceb-184">NotAllowed</span></span>|<span data-ttu-id="72ceb-185">假</span><span class="sxs-lookup"><span data-stu-id="72ceb-185">false</span></span>|<span data-ttu-id="72ceb-186">WCF 不模拟调用方</span><span class="sxs-lookup"><span data-stu-id="72ceb-186">WCF does not impersonate the caller</span></span>|  
|<span data-ttu-id="72ceb-187">NotAllowed</span><span class="sxs-lookup"><span data-stu-id="72ceb-187">NotAllowed</span></span>|<span data-ttu-id="72ceb-188">真</span><span class="sxs-lookup"><span data-stu-id="72ceb-188">true</span></span>|<span data-ttu-id="72ceb-189">不允许。</span><span class="sxs-lookup"><span data-stu-id="72ceb-189">Disallowed.</span></span> <span data-ttu-id="72ceb-190">（引发 <xref:System.InvalidOperationException> 。）</span><span class="sxs-lookup"><span data-stu-id="72ceb-190">(An <xref:System.InvalidOperationException> is thrown.)</span></span>|  
  
## <a name="impersonation-level-obtained-from-windows-credentials-and-cached-token-impersonation"></a><span data-ttu-id="72ceb-191">从 Windows 凭据和缓存的令牌模拟获取的模拟级别</span><span class="sxs-lookup"><span data-stu-id="72ceb-191">Impersonation Level Obtained from Windows Credentials and Cached Token Impersonation</span></span>  
 <span data-ttu-id="72ceb-192">在某些情况下，当使用 Windows 凭据时，客户端能够部分控制服务执行的模拟级别。</span><span class="sxs-lookup"><span data-stu-id="72ceb-192">In some scenarios the client has partial control over the level of impersonation the service performs when a Windows client credential is used.</span></span> <span data-ttu-id="72ceb-193">情况之一是客户端指定 Anonymous 模拟级别。</span><span class="sxs-lookup"><span data-stu-id="72ceb-193">One scenario occurs when the client specifies an Anonymous impersonation level.</span></span> <span data-ttu-id="72ceb-194">另一种情况是执行缓存的令牌模拟。</span><span class="sxs-lookup"><span data-stu-id="72ceb-194">The other occurs when performing impersonation with a cached token.</span></span> <span data-ttu-id="72ceb-195">这是通过设置 <xref:System.ServiceModel.Security.WindowsClientCredential.AllowedImpersonationLevel%2A> 类的 <xref:System.ServiceModel.Security.WindowsClientCredential> 属性来完成的，此类可作为通用 <xref:System.ServiceModel.ChannelFactory%601> 类的属性进行访问。</span><span class="sxs-lookup"><span data-stu-id="72ceb-195">This is done by setting the <xref:System.ServiceModel.Security.WindowsClientCredential.AllowedImpersonationLevel%2A> property of the <xref:System.ServiceModel.Security.WindowsClientCredential> class, which is accessed as a property of the generic <xref:System.ServiceModel.ChannelFactory%601> class.</span></span>  
  
> [!NOTE]
> <span data-ttu-id="72ceb-196">指定 Anonymous 模拟级别可导致客户端匿名登录到服务。</span><span class="sxs-lookup"><span data-stu-id="72ceb-196">Specifying an impersonation level of Anonymous causes the client to log on to the service anonymously.</span></span> <span data-ttu-id="72ceb-197">因此，无论是否执行模拟，服务都必须允许匿名登录。</span><span class="sxs-lookup"><span data-stu-id="72ceb-197">The service must therefore allow anonymous logons, regardless of whether impersonation is performed.</span></span>  
  
 <span data-ttu-id="72ceb-198">客户端可以将模拟级别指定为 <xref:System.Security.Principal.TokenImpersonationLevel.Anonymous>、 <xref:System.Security.Principal.TokenImpersonationLevel.Identification>、 <xref:System.Security.Principal.TokenImpersonationLevel.Impersonation>或 <xref:System.Security.Principal.TokenImpersonationLevel.Delegation>。</span><span class="sxs-lookup"><span data-stu-id="72ceb-198">The client can specify the impersonation level as <xref:System.Security.Principal.TokenImpersonationLevel.Anonymous>, <xref:System.Security.Principal.TokenImpersonationLevel.Identification>, <xref:System.Security.Principal.TokenImpersonationLevel.Impersonation>, or <xref:System.Security.Principal.TokenImpersonationLevel.Delegation>.</span></span> <span data-ttu-id="72ceb-199">只在指定的级别产生令牌，如下面的代码所示。</span><span class="sxs-lookup"><span data-stu-id="72ceb-199">Only a token at the specified level is produced, as shown in the following code.</span></span>  
  
 [!code-csharp[c_ImpersonationAndDelegation#4](../../../../samples/snippets/csharp/VS_Snippets_CFX/c_impersonationanddelegation/cs/source.cs#4)]
 [!code-vb[c_ImpersonationAndDelegation#4](../../../../samples/snippets/visualbasic/VS_Snippets_CFX/c_impersonationanddelegation/vb/source.vb#4)]  
  
 <span data-ttu-id="72ceb-200">下表指定从缓存的令牌模拟时服务获取的模拟级别。</span><span class="sxs-lookup"><span data-stu-id="72ceb-200">The following table specifies the impersonation level the service obtains when impersonating from a cached token.</span></span>  
  
|<span data-ttu-id="72ceb-201">`AllowedImpersonationLevel` 值</span><span class="sxs-lookup"><span data-stu-id="72ceb-201">`AllowedImpersonationLevel` value</span></span>|<span data-ttu-id="72ceb-202">服务具有 `SeImpersonatePrivilege`</span><span class="sxs-lookup"><span data-stu-id="72ceb-202">Service has `SeImpersonatePrivilege`</span></span>|<span data-ttu-id="72ceb-203">服务和客户端能够委托</span><span class="sxs-lookup"><span data-stu-id="72ceb-203">Service and client are capable of delegation</span></span>|<span data-ttu-id="72ceb-204">缓存的令牌 `ImpersonationLevel`</span><span class="sxs-lookup"><span data-stu-id="72ceb-204">Cached token `ImpersonationLevel`</span></span>|  
|---------------------------------------|------------------------------------------|--------------------------------------------------|---------------------------------------|  
|<span data-ttu-id="72ceb-205">匿名</span><span class="sxs-lookup"><span data-stu-id="72ceb-205">Anonymous</span></span>|<span data-ttu-id="72ceb-206">是</span><span class="sxs-lookup"><span data-stu-id="72ceb-206">Yes</span></span>|<span data-ttu-id="72ceb-207">n/a</span><span class="sxs-lookup"><span data-stu-id="72ceb-207">n/a</span></span>|<span data-ttu-id="72ceb-208">Impersonation</span><span class="sxs-lookup"><span data-stu-id="72ceb-208">Impersonation</span></span>|  
|<span data-ttu-id="72ceb-209">匿名</span><span class="sxs-lookup"><span data-stu-id="72ceb-209">Anonymous</span></span>|<span data-ttu-id="72ceb-210">No</span><span class="sxs-lookup"><span data-stu-id="72ceb-210">No</span></span>|<span data-ttu-id="72ceb-211">n/a</span><span class="sxs-lookup"><span data-stu-id="72ceb-211">n/a</span></span>|<span data-ttu-id="72ceb-212">标识</span><span class="sxs-lookup"><span data-stu-id="72ceb-212">Identification</span></span>|  
|<span data-ttu-id="72ceb-213">标识</span><span class="sxs-lookup"><span data-stu-id="72ceb-213">Identification</span></span>|<span data-ttu-id="72ceb-214">n/a</span><span class="sxs-lookup"><span data-stu-id="72ceb-214">n/a</span></span>|<span data-ttu-id="72ceb-215">n/a</span><span class="sxs-lookup"><span data-stu-id="72ceb-215">n/a</span></span>|<span data-ttu-id="72ceb-216">标识</span><span class="sxs-lookup"><span data-stu-id="72ceb-216">Identification</span></span>|  
|<span data-ttu-id="72ceb-217">Impersonation</span><span class="sxs-lookup"><span data-stu-id="72ceb-217">Impersonation</span></span>|<span data-ttu-id="72ceb-218">是</span><span class="sxs-lookup"><span data-stu-id="72ceb-218">Yes</span></span>|<span data-ttu-id="72ceb-219">n/a</span><span class="sxs-lookup"><span data-stu-id="72ceb-219">n/a</span></span>|<span data-ttu-id="72ceb-220">Impersonation</span><span class="sxs-lookup"><span data-stu-id="72ceb-220">Impersonation</span></span>|  
|<span data-ttu-id="72ceb-221">Impersonation</span><span class="sxs-lookup"><span data-stu-id="72ceb-221">Impersonation</span></span>|<span data-ttu-id="72ceb-222">No</span><span class="sxs-lookup"><span data-stu-id="72ceb-222">No</span></span>|<span data-ttu-id="72ceb-223">n/a</span><span class="sxs-lookup"><span data-stu-id="72ceb-223">n/a</span></span>|<span data-ttu-id="72ceb-224">标识</span><span class="sxs-lookup"><span data-stu-id="72ceb-224">Identification</span></span>|  
|<span data-ttu-id="72ceb-225">委托</span><span class="sxs-lookup"><span data-stu-id="72ceb-225">Delegation</span></span>|<span data-ttu-id="72ceb-226">是</span><span class="sxs-lookup"><span data-stu-id="72ceb-226">Yes</span></span>|<span data-ttu-id="72ceb-227">是</span><span class="sxs-lookup"><span data-stu-id="72ceb-227">Yes</span></span>|<span data-ttu-id="72ceb-228">委托</span><span class="sxs-lookup"><span data-stu-id="72ceb-228">Delegation</span></span>|  
|<span data-ttu-id="72ceb-229">委托</span><span class="sxs-lookup"><span data-stu-id="72ceb-229">Delegation</span></span>|<span data-ttu-id="72ceb-230">是</span><span class="sxs-lookup"><span data-stu-id="72ceb-230">Yes</span></span>|<span data-ttu-id="72ceb-231">No</span><span class="sxs-lookup"><span data-stu-id="72ceb-231">No</span></span>|<span data-ttu-id="72ceb-232">Impersonation</span><span class="sxs-lookup"><span data-stu-id="72ceb-232">Impersonation</span></span>|  
|<span data-ttu-id="72ceb-233">委托</span><span class="sxs-lookup"><span data-stu-id="72ceb-233">Delegation</span></span>|<span data-ttu-id="72ceb-234">No</span><span class="sxs-lookup"><span data-stu-id="72ceb-234">No</span></span>|<span data-ttu-id="72ceb-235">n/a</span><span class="sxs-lookup"><span data-stu-id="72ceb-235">n/a</span></span>|<span data-ttu-id="72ceb-236">标识</span><span class="sxs-lookup"><span data-stu-id="72ceb-236">Identification</span></span>|  
  
## <a name="impersonation-level-obtained-from-user-name-credentials-and-cached-token-impersonation"></a><span data-ttu-id="72ceb-237">从用户名凭据和缓存的令牌模拟获取的模拟级别</span><span class="sxs-lookup"><span data-stu-id="72ceb-237">Impersonation Level Obtained from User Name Credentials and Cached Token Impersonation</span></span>  
 <span data-ttu-id="72ceb-238">通过向服务传递其用户名和密码, 客户端可以使 WCF 以该用户身份登录, 这等效于将`AllowedImpersonationLevel`属性设置为。 <xref:System.Security.Principal.TokenImpersonationLevel.Delegation></span><span class="sxs-lookup"><span data-stu-id="72ceb-238">By passing the service its user name and password, a client enables WCF to log on as that user, which is equivalent to setting the `AllowedImpersonationLevel` property to <xref:System.Security.Principal.TokenImpersonationLevel.Delegation>.</span></span> <span data-ttu-id="72ceb-239">（`AllowedImpersonationLevel` 在 <xref:System.ServiceModel.Security.WindowsClientCredential> 和 <xref:System.ServiceModel.Security.HttpDigestClientCredential> 类中可用。）下表提供了当服务接收用户名凭据时获取的模拟级别。</span><span class="sxs-lookup"><span data-stu-id="72ceb-239">(The `AllowedImpersonationLevel` is available on the <xref:System.ServiceModel.Security.WindowsClientCredential> and <xref:System.ServiceModel.Security.HttpDigestClientCredential> classes.) The following table provides the impersonation level obtained when the service receives user name credentials.</span></span>  
  
|`AllowedImpersonationLevel`|<span data-ttu-id="72ceb-240">服务具有 `SeImpersonatePrivilege`</span><span class="sxs-lookup"><span data-stu-id="72ceb-240">Service has `SeImpersonatePrivilege`</span></span>|<span data-ttu-id="72ceb-241">服务和客户端能够委托</span><span class="sxs-lookup"><span data-stu-id="72ceb-241">Service and client are capable of delegation</span></span>|<span data-ttu-id="72ceb-242">缓存的令牌 `ImpersonationLevel`</span><span class="sxs-lookup"><span data-stu-id="72ceb-242">Cached token `ImpersonationLevel`</span></span>|  
|---------------------------------|------------------------------------------|--------------------------------------------------|---------------------------------------|  
|<span data-ttu-id="72ceb-243">n/a</span><span class="sxs-lookup"><span data-stu-id="72ceb-243">n/a</span></span>|<span data-ttu-id="72ceb-244">是</span><span class="sxs-lookup"><span data-stu-id="72ceb-244">Yes</span></span>|<span data-ttu-id="72ceb-245">是</span><span class="sxs-lookup"><span data-stu-id="72ceb-245">Yes</span></span>|<span data-ttu-id="72ceb-246">委托</span><span class="sxs-lookup"><span data-stu-id="72ceb-246">Delegation</span></span>|  
|<span data-ttu-id="72ceb-247">n/a</span><span class="sxs-lookup"><span data-stu-id="72ceb-247">n/a</span></span>|<span data-ttu-id="72ceb-248">是</span><span class="sxs-lookup"><span data-stu-id="72ceb-248">Yes</span></span>|<span data-ttu-id="72ceb-249">No</span><span class="sxs-lookup"><span data-stu-id="72ceb-249">No</span></span>|<span data-ttu-id="72ceb-250">Impersonation</span><span class="sxs-lookup"><span data-stu-id="72ceb-250">Impersonation</span></span>|  
|<span data-ttu-id="72ceb-251">无</span><span class="sxs-lookup"><span data-stu-id="72ceb-251">n/a</span></span>|<span data-ttu-id="72ceb-252">No</span><span class="sxs-lookup"><span data-stu-id="72ceb-252">No</span></span>|<span data-ttu-id="72ceb-253">n/a</span><span class="sxs-lookup"><span data-stu-id="72ceb-253">n/a</span></span>|<span data-ttu-id="72ceb-254">标识</span><span class="sxs-lookup"><span data-stu-id="72ceb-254">Identification</span></span>|  
  
## <a name="impersonation-level-obtained-from-s4u-based-impersonation"></a><span data-ttu-id="72ceb-255">从基于 S4U 的模拟获取的模拟级别</span><span class="sxs-lookup"><span data-stu-id="72ceb-255">Impersonation Level Obtained from S4U-Based Impersonation</span></span>  
  
|<span data-ttu-id="72ceb-256">服务具有 `SeTcbPrivilege`</span><span class="sxs-lookup"><span data-stu-id="72ceb-256">Service has `SeTcbPrivilege`</span></span>|<span data-ttu-id="72ceb-257">服务具有 `SeImpersonatePrivilege`</span><span class="sxs-lookup"><span data-stu-id="72ceb-257">Service has `SeImpersonatePrivilege`</span></span>|<span data-ttu-id="72ceb-258">服务和客户端能够委托</span><span class="sxs-lookup"><span data-stu-id="72ceb-258">Service and client are capable of delegation</span></span>|<span data-ttu-id="72ceb-259">缓存的令牌 `ImpersonationLevel`</span><span class="sxs-lookup"><span data-stu-id="72ceb-259">Cached token `ImpersonationLevel`</span></span>|  
|----------------------------------|------------------------------------------|--------------------------------------------------|---------------------------------------|  
|<span data-ttu-id="72ceb-260">是</span><span class="sxs-lookup"><span data-stu-id="72ceb-260">Yes</span></span>|<span data-ttu-id="72ceb-261">是</span><span class="sxs-lookup"><span data-stu-id="72ceb-261">Yes</span></span>|<span data-ttu-id="72ceb-262">n/a</span><span class="sxs-lookup"><span data-stu-id="72ceb-262">n/a</span></span>|<span data-ttu-id="72ceb-263">Impersonation</span><span class="sxs-lookup"><span data-stu-id="72ceb-263">Impersonation</span></span>|  
|<span data-ttu-id="72ceb-264">是</span><span class="sxs-lookup"><span data-stu-id="72ceb-264">Yes</span></span>|<span data-ttu-id="72ceb-265">No</span><span class="sxs-lookup"><span data-stu-id="72ceb-265">No</span></span>|<span data-ttu-id="72ceb-266">n/a</span><span class="sxs-lookup"><span data-stu-id="72ceb-266">n/a</span></span>|<span data-ttu-id="72ceb-267">标识</span><span class="sxs-lookup"><span data-stu-id="72ceb-267">Identification</span></span>|  
|<span data-ttu-id="72ceb-268">No</span><span class="sxs-lookup"><span data-stu-id="72ceb-268">No</span></span>|<span data-ttu-id="72ceb-269">n/a</span><span class="sxs-lookup"><span data-stu-id="72ceb-269">n/a</span></span>|<span data-ttu-id="72ceb-270">n/a</span><span class="sxs-lookup"><span data-stu-id="72ceb-270">n/a</span></span>|<span data-ttu-id="72ceb-271">标识</span><span class="sxs-lookup"><span data-stu-id="72ceb-271">Identification</span></span>|  
  
## <a name="mapping-a-client-certificate-to-a-windows-account"></a><span data-ttu-id="72ceb-272">将客户端证书映射到 Windows 帐户</span><span class="sxs-lookup"><span data-stu-id="72ceb-272">Mapping a Client Certificate to a Windows Account</span></span>  
 <span data-ttu-id="72ceb-273">客户端有可能使用证书向服务验证自己的身份，并让服务通过 Active Directory 将客户端映射到现有帐户。</span><span class="sxs-lookup"><span data-stu-id="72ceb-273">It is possible for a client to authenticate itself to a service using a certificate, and to have the service map the client to an existing account through Active Directory.</span></span> <span data-ttu-id="72ceb-274">下面的 XML 演示如何将服务配置为使用映射证书。</span><span class="sxs-lookup"><span data-stu-id="72ceb-274">The following XML shows how to configure the service to map the certificate.</span></span>  
  
```xml  
<behaviors>  
  <serviceBehaviors>  
    <behavior name="MapToWindowsAccount">  
      <serviceCredentials>  
        <clientCertificate>  
          <authentication mapClientCertificateToWindowsAccount="true" />  
        </clientCertificate>  
      </serviceCredentials>  
    </behavior>  
  </serviceBehaviors>  
</behaviors>  
```  
  
 <span data-ttu-id="72ceb-275">下面的代码演示如何配置服务。</span><span class="sxs-lookup"><span data-stu-id="72ceb-275">The following code shows how to configure the service.</span></span>  
  
```  
// Create a binding that sets a certificate as the client credential type.  
WSHttpBinding b = new WSHttpBinding();  
b.Security.Message.ClientCredentialType = MessageCredentialType.Certificate;  
  
// Create a service host that maps the certificate to a Windows account.  
Uri httpUri = new Uri("http://localhost/Calculator");  
ServiceHost sh = new ServiceHost(typeof(HelloService), httpUri);  
sh.Credentials.ClientCertificate.Authentication.MapClientCertificateToWindowsAccount = true;  
```  
  
## <a name="delegation"></a><span data-ttu-id="72ceb-276">委托</span><span class="sxs-lookup"><span data-stu-id="72ceb-276">Delegation</span></span>  
 <span data-ttu-id="72ceb-277">若要委托给后端服务，服务必须使用客户端的 Windows 标识对后端服务执行 Kerberos 多段（不带 NTLM 回退的 SSPI）身份验证或 Kerberos 直接身份验证。</span><span class="sxs-lookup"><span data-stu-id="72ceb-277">To delegate to a back-end service, a service must perform Kerberos multi-leg (SSPI without NTLM fallback) or Kerberos direct authentication to the back-end service using the client’s Windows identity.</span></span> <span data-ttu-id="72ceb-278">若要委托给后端服务，可以创建 <xref:System.ServiceModel.ChannelFactory%601> 和通道，然后在模拟客户端时通过该通道进行通信。</span><span class="sxs-lookup"><span data-stu-id="72ceb-278">To delegate to a back-end service, create a <xref:System.ServiceModel.ChannelFactory%601> and a channel, and then communicate through the channel while impersonating the client.</span></span> <span data-ttu-id="72ceb-279">采用这种形式的委托时，后端服务与前端服务之间可以保持的距离取决于前端服务实现的模拟级别。</span><span class="sxs-lookup"><span data-stu-id="72ceb-279">With this form of delegation, the distance at which the back-end service can be located from the front-end service depends on the impersonation level achieved by the front-end service.</span></span> <span data-ttu-id="72ceb-280">如果模拟级别为 <xref:System.Security.Principal.TokenImpersonationLevel.Impersonation>，则前端服务和后端服务必须在同一台计算机上运行。</span><span class="sxs-lookup"><span data-stu-id="72ceb-280">When the impersonation level is <xref:System.Security.Principal.TokenImpersonationLevel.Impersonation>, the front-end and back-end services must be running on the same machine.</span></span> <span data-ttu-id="72ceb-281">如果模拟级别为 <xref:System.Security.Principal.TokenImpersonationLevel.Delegation>，则前端服务和后端服务既可以在不同的计算机上运行，也可以在同一台计算机上运行。</span><span class="sxs-lookup"><span data-stu-id="72ceb-281">When the impersonation level is <xref:System.Security.Principal.TokenImpersonationLevel.Delegation>, the front-end and back-end services can be on separate machines or on the same machine.</span></span> <span data-ttu-id="72ceb-282">启用委托级别的模拟需要将 Windows 域策略配置为允许委托。</span><span class="sxs-lookup"><span data-stu-id="72ceb-282">Enabling delegation-level impersonation requires that Windows domain policy be configured to permit delegation.</span></span> <span data-ttu-id="72ceb-283">有关配置 Active Directory 以提供委托支持的详细信息，请参阅 [Enabling Delegated Authentication](https://go.microsoft.com/fwlink/?LinkId=99690)（启用委托的身份验证）。</span><span class="sxs-lookup"><span data-stu-id="72ceb-283">For more information about configuring Active Directory for delegation support, see [Enabling Delegated Authentication](https://go.microsoft.com/fwlink/?LinkId=99690).</span></span>  
  
> [!NOTE]
> <span data-ttu-id="72ceb-284">如果客户端使用与后端服务上的 Windows 帐户相对应的用户名和密码向前端服务进行身份验证，则前端服务可通过重用客户端的用户名和密码，向后端服务进行身份验证。</span><span class="sxs-lookup"><span data-stu-id="72ceb-284">When a client authenticates to the front-end service using a user name and password that correspond to a Windows account on the back-end service, the front-end service can authenticate to the back-end service by reusing the client’s user name and password.</span></span> <span data-ttu-id="72ceb-285">这是一种功能特别强大的标识流形式，因为将用户名和密码传递到后端服务会使后端服务可以执行模拟，但它不会形成委托，因为未使用 Kerberos。</span><span class="sxs-lookup"><span data-stu-id="72ceb-285">This is a particularly powerful form of identity flow, because passing user name and password to the back-end service enables the back-end service to perform impersonation, but it does not constitute delegation because Kerberos is not used.</span></span> <span data-ttu-id="72ceb-286">Active Directory 对委托的控制不适用于用户名和密码的身份验证。</span><span class="sxs-lookup"><span data-stu-id="72ceb-286">Active Directory controls on delegation do not apply to user name and password authentication.</span></span>  
  
### <a name="delegation-ability-as-a-function-of-impersonation-level"></a><span data-ttu-id="72ceb-287">作为模拟级别功能的委托功能</span><span class="sxs-lookup"><span data-stu-id="72ceb-287">Delegation Ability as a Function of Impersonation Level</span></span>  
  
|<span data-ttu-id="72ceb-288">模拟级别</span><span class="sxs-lookup"><span data-stu-id="72ceb-288">Impersonation level</span></span>|<span data-ttu-id="72ceb-289">服务可以执行跨进程的委托</span><span class="sxs-lookup"><span data-stu-id="72ceb-289">Service can perform cross-process delegation</span></span>|<span data-ttu-id="72ceb-290">服务可以执行跨计算机的委托</span><span class="sxs-lookup"><span data-stu-id="72ceb-290">Service can perform cross-machine delegation</span></span>|  
|-------------------------|---------------------------------------------------|---------------------------------------------------|  
|<xref:System.Security.Principal.TokenImpersonationLevel.Identification>|<span data-ttu-id="72ceb-291">No</span><span class="sxs-lookup"><span data-stu-id="72ceb-291">No</span></span>|<span data-ttu-id="72ceb-292">No</span><span class="sxs-lookup"><span data-stu-id="72ceb-292">No</span></span>|  
|<xref:System.Security.Principal.TokenImpersonationLevel.Impersonation>|<span data-ttu-id="72ceb-293">是</span><span class="sxs-lookup"><span data-stu-id="72ceb-293">Yes</span></span>|<span data-ttu-id="72ceb-294">No</span><span class="sxs-lookup"><span data-stu-id="72ceb-294">No</span></span>|  
|<xref:System.Security.Principal.TokenImpersonationLevel.Delegation>|<span data-ttu-id="72ceb-295">是</span><span class="sxs-lookup"><span data-stu-id="72ceb-295">Yes</span></span>|<span data-ttu-id="72ceb-296">是</span><span class="sxs-lookup"><span data-stu-id="72ceb-296">Yes</span></span>|  
  
 <span data-ttu-id="72ceb-297">下面的代码示例演示如何使用委托。</span><span class="sxs-lookup"><span data-stu-id="72ceb-297">The following code example demonstrates how to use delegation.</span></span>  
  
 [!code-csharp[c_delegation#1](../../../../samples/snippets/csharp/VS_Snippets_CFX/c_delegation/cs/source.cs#1)]
 [!code-vb[c_delegation#1](../../../../samples/snippets/visualbasic/VS_Snippets_CFX/c_delegation/vb/source.vb#1)]  
  
### <a name="how-to-configure-an-application-to-use-constrained-delegation"></a><span data-ttu-id="72ceb-298">如何将应用程序配置为使用受约束的委托</span><span class="sxs-lookup"><span data-stu-id="72ceb-298">How to Configure an Application to Use Constrained Delegation</span></span>  
 <span data-ttu-id="72ceb-299">在使用受约束的委托之前，必须将发送方、接收方和域控制器配置为使用受约束的委托。</span><span class="sxs-lookup"><span data-stu-id="72ceb-299">Before you can use constrained delegation, the sender, receiver, and the domain controller must be configured to do so.</span></span> <span data-ttu-id="72ceb-300">下面的过程列出启用受约束的委托的步骤。</span><span class="sxs-lookup"><span data-stu-id="72ceb-300">The following procedure lists the steps that enable constrained delegation.</span></span> <span data-ttu-id="72ceb-301">有关委托和受约束委托之间的区别的详细信息，请参阅 [Windows Server 2003 Kerberos Extensions](https://go.microsoft.com/fwlink/?LinkId=100194) （Windows Server 2003 Kerberos 扩展）中讨论受约束委托的部分。</span><span class="sxs-lookup"><span data-stu-id="72ceb-301">For details about the differences between delegation and constrained delegation, see the portion of [Windows Server 2003 Kerberos Extensions](https://go.microsoft.com/fwlink/?LinkId=100194) that discusses constrained discussion.</span></span>  
  
1. <span data-ttu-id="72ceb-302">在域控制器上，为用于运行客户端应用程序的帐户清除 **“敏感帐户，不能被委派”** 复选框。</span><span class="sxs-lookup"><span data-stu-id="72ceb-302">On the domain controller, clear the **Account is sensitive and cannot be delegated** check box for the account under which the client application is running.</span></span>  
  
2. <span data-ttu-id="72ceb-303">在域控制器上，为用于运行客户端应用程序的帐户选中 **“帐户可以委派其他帐户”** 复选框。</span><span class="sxs-lookup"><span data-stu-id="72ceb-303">On the domain controller, select the **Account is trusted for delegation** check box for the account under which the client application is running.</span></span>  
  
3. <span data-ttu-id="72ceb-304">在域控制器上，通过单击 **“信任计算机作为委派”** 选项，对中间层计算机进行配置，以便信任该计算机进行委托。</span><span class="sxs-lookup"><span data-stu-id="72ceb-304">On the domain controller, configure the middle tier computer so that it is trusted for delegation, by clicking the **Trust computer for delegation** option.</span></span>  
  
4. <span data-ttu-id="72ceb-305">在域控制器上，通过单击 **“仅信任此计算机来委派指定的服务”** 选项，将中间层计算机配置为使用受约束的委托。</span><span class="sxs-lookup"><span data-stu-id="72ceb-305">On the domain controller, configure the middle tier computer to use constrained delegation, by clicking the **Trust this computer for delegation to specified services only** option.</span></span>  
  
 <span data-ttu-id="72ceb-306">有关配置受约束委托的更多详细说明，请参见 MSDN 上的以下主题：</span><span class="sxs-lookup"><span data-stu-id="72ceb-306">For more detailed instructions about configuring constrained delegation, see the following topics on MSDN:</span></span>  
  
- [<span data-ttu-id="72ceb-307">Troubleshooting Kerberos Delegation（Kerberos 委托疑难解答）</span><span class="sxs-lookup"><span data-stu-id="72ceb-307">Troubleshooting Kerberos Delegation</span></span>](https://go.microsoft.com/fwlink/?LinkId=36724)  
  
- [<span data-ttu-id="72ceb-308">Kerberos Protocol Transition and Constrained Delegation（Kerberos 协议传输和受约束的委托）</span><span class="sxs-lookup"><span data-stu-id="72ceb-308">Kerberos Protocol Transition and Constrained Delegation</span></span>](https://go.microsoft.com/fwlink/?LinkId=36725)  
  
## <a name="see-also"></a><span data-ttu-id="72ceb-309">请参阅</span><span class="sxs-lookup"><span data-stu-id="72ceb-309">See also</span></span>

- <xref:System.ServiceModel.OperationBehaviorAttribute>
- <xref:System.ServiceModel.OperationBehaviorAttribute.Impersonation%2A>
- <xref:System.ServiceModel.ImpersonationOption>
- <xref:System.ServiceModel.ServiceSecurityContext.WindowsIdentity%2A>
- <xref:System.ServiceModel.ServiceSecurityContext>
- <xref:System.Security.Principal.WindowsIdentity>
- <xref:System.ServiceModel.Description.ServiceAuthorizationBehavior>
- <xref:System.ServiceModel.Description.ServiceAuthorizationBehavior.ImpersonateCallerForAllOperations%2A>
- <xref:System.ServiceModel.ServiceHost>
- <xref:System.ServiceModel.Security.WindowsClientCredential.AllowedImpersonationLevel%2A>
- <xref:System.ServiceModel.Security.WindowsClientCredential>
- <xref:System.ServiceModel.ChannelFactory%601>
- <xref:System.Security.Principal.TokenImpersonationLevel.Identification>
- [<span data-ttu-id="72ceb-310">将模拟用于传输安全性</span><span class="sxs-lookup"><span data-stu-id="72ceb-310">Using Impersonation with Transport Security</span></span>](../../../../docs/framework/wcf/feature-details/using-impersonation-with-transport-security.md)
- [<span data-ttu-id="72ceb-311">模拟客户端</span><span class="sxs-lookup"><span data-stu-id="72ceb-311">Impersonating the Client</span></span>](../../../../docs/framework/wcf/samples/impersonating-the-client.md)
- [<span data-ttu-id="72ceb-312">如何：模拟服务上的客户端</span><span class="sxs-lookup"><span data-stu-id="72ceb-312">How to: Impersonate a Client on a Service</span></span>](../../../../docs/framework/wcf/how-to-impersonate-a-client-on-a-service.md)
- [<span data-ttu-id="72ceb-313">ServiceModel 元数据实用工具 (Svcutil.exe)</span><span class="sxs-lookup"><span data-stu-id="72ceb-313">ServiceModel Metadata Utility Tool (Svcutil.exe)</span></span>](../../../../docs/framework/wcf/servicemodel-metadata-utility-tool-svcutil-exe.md)
