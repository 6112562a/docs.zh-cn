---
title: 在 DataGridView 控件中实现实时数据加载的虚拟模式
ms.date: 03/30/2017
dev_langs:
- csharp
- vb
helpviewer_keywords:
- examples [Windows Forms], just-in-time data loading
- data [Windows Forms], managing large data sets
- DataGridView control [Windows Forms], virtual mode
- just-in-time data loading
- DataGridView control [Windows Forms], large data sets
- virtual mode [Windows Forms], just-in-time data loading
ms.assetid: c2a052b9-423c-4ff7-91dc-d8c7c79345f6
ms.openlocfilehash: 85c6877a9fc6a92752eb039da9d36e34811f8b77
ms.sourcegitcommit: de17a7a0a37042f0d4406f5ae5393531caeb25ba
ms.translationtype: MT
ms.contentlocale: zh-CN
ms.lasthandoff: 01/24/2020
ms.locfileid: "76745069"
---
# <a name="implementing-virtual-mode-with-just-in-time-data-loading-in-the-windows-forms-datagridview-control"></a><span data-ttu-id="a5ed3-102">Windows Forms DataGridView 컨트롤에서 Just-In-Time 데이터 로드를 사용하여 가상 모드 구현</span><span class="sxs-lookup"><span data-stu-id="a5ed3-102">Implementing Virtual Mode with Just-In-Time Data Loading in the Windows Forms DataGridView Control</span></span>
<span data-ttu-id="a5ed3-103">在 <xref:System.Windows.Forms.DataGridView> 控件中实现虚拟模式的一个原因是只在需要时才检索数据。</span><span class="sxs-lookup"><span data-stu-id="a5ed3-103">One reason to implement virtual mode in the <xref:System.Windows.Forms.DataGridView> control is to retrieve data only as it is needed.</span></span> <span data-ttu-id="a5ed3-104">这称为 *"实时数据加载"* 。</span><span class="sxs-lookup"><span data-stu-id="a5ed3-104">This is called *just-in-time data loading*.</span></span>  
  
 <span data-ttu-id="a5ed3-105">例如，如果您在远程数据库中使用非常大的表，则您可能希望仅在用户将新行滚动到视图中时，只检索显示和检索其他数据所需的数据，从而避免启动延迟。</span><span class="sxs-lookup"><span data-stu-id="a5ed3-105">If you are working with a very large table in a remote database, for example, you might want to avoid startup delays by retrieving only the data that is necessary for display and retrieving additional data only when the user scrolls new rows into view.</span></span> <span data-ttu-id="a5ed3-106">如果运行应用程序的客户端计算机有有限数量的内存可用于存储数据，则在从数据库检索新值时，您可能还需要丢弃未使用的数据。</span><span class="sxs-lookup"><span data-stu-id="a5ed3-106">If the client computers running your application have a limited amount of memory available for storing data, you might also want to discard unused data when retrieving new values from the database.</span></span>  
  
 <span data-ttu-id="a5ed3-107">以下部分介绍如何将 <xref:System.Windows.Forms.DataGridView> 控件与实时缓存结合使用。</span><span class="sxs-lookup"><span data-stu-id="a5ed3-107">The following sections describe how to use a <xref:System.Windows.Forms.DataGridView> control with a just-in-time cache.</span></span>  
  
 <span data-ttu-id="a5ed3-108">若要将本主题中的代码复制为单个列表，请参阅[如何：在 Windows 窗体 DataGridView 控件中使用实时数据加载实现虚拟模式](virtual-mode-with-just-in-time-data-loading-in-the-datagrid.md)。</span><span class="sxs-lookup"><span data-stu-id="a5ed3-108">To copy the code in this topic as a single listing, see [How to: Implement Virtual Mode with Just-In-Time Data Loading in the Windows Forms DataGridView Control](virtual-mode-with-just-in-time-data-loading-in-the-datagrid.md).</span></span>  
  
## <a name="the-form"></a><span data-ttu-id="a5ed3-109">窗体</span><span class="sxs-lookup"><span data-stu-id="a5ed3-109">The Form</span></span>  
 <span data-ttu-id="a5ed3-110">下面的代码示例定义一个窗体，该窗体包含一个只读的 <xref:System.Windows.Forms.DataGridView> 控件，该控件通过 <xref:System.Windows.Forms.DataGridView.CellValueNeeded> 事件处理程序与 `Cache` 对象进行交互。</span><span class="sxs-lookup"><span data-stu-id="a5ed3-110">The following code example defines a form containing a read-only <xref:System.Windows.Forms.DataGridView> control that interacts with a `Cache` object through a <xref:System.Windows.Forms.DataGridView.CellValueNeeded> event handler.</span></span> <span data-ttu-id="a5ed3-111">`Cache` 对象管理本地存储的值，并使用 `DataRetriever` 对象从示例 Northwind 数据库的 Orders 表中检索值。</span><span class="sxs-lookup"><span data-stu-id="a5ed3-111">The `Cache` object manages the locally stored values and uses a `DataRetriever` object to retrieve values from the Orders table of the sample Northwind database.</span></span> <span data-ttu-id="a5ed3-112">用于实现 `Cache` 类所需的 `IDataPageRetriever` 接口的 `DataRetriever` 对象还用于初始化 <xref:System.Windows.Forms.DataGridView> 控制行和列。</span><span class="sxs-lookup"><span data-stu-id="a5ed3-112">The `DataRetriever` object, which implements the `IDataPageRetriever` interface required by the `Cache` class, is also used to initialize the <xref:System.Windows.Forms.DataGridView> control rows and columns.</span></span>  
  
 <span data-ttu-id="a5ed3-113">本主题后面将介绍 `IDataPageRetriever`、`DataRetriever`和 `Cache` 类型。</span><span class="sxs-lookup"><span data-stu-id="a5ed3-113">The `IDataPageRetriever`, `DataRetriever`, and `Cache` types are described later in this topic.</span></span>  
  
> [!NOTE]
> <span data-ttu-id="a5ed3-114">암호와 같은 중요한 정보를 연결 문자열 내에 저장하면 애플리케이션 보안 문제가 발생할 수 있습니다.</span><span class="sxs-lookup"><span data-stu-id="a5ed3-114">Storing sensitive information, such as a password, within the connection string can affect the security of your application.</span></span> <span data-ttu-id="a5ed3-115">데이터베이스 액세스를 제어할 경우에는 통합 보안이라고도 하는 Windows 인증을 사용하는 방법이 더 안전합니다.</span><span class="sxs-lookup"><span data-stu-id="a5ed3-115">Using Windows Authentication (also known as integrated security) is a more secure way to control access to a database.</span></span> <span data-ttu-id="a5ed3-116">자세한 내용은 [연결 정보 보호](../../data/adonet/protecting-connection-information.md)를 참조하세요.</span><span class="sxs-lookup"><span data-stu-id="a5ed3-116">For more information, see [Protecting Connection Information](../../data/adonet/protecting-connection-information.md).</span></span>  
  
 [!code-csharp[System.Windows.Forms.DataGridView.Virtual_lazyloading#100](~/samples/snippets/csharp/VS_Snippets_Winforms/System.Windows.Forms.DataGridView.Virtual_lazyloading/CS/lazyloading.cs#100)]
 [!code-vb[System.Windows.Forms.DataGridView.Virtual_lazyloading#100](~/samples/snippets/visualbasic/VS_Snippets_Winforms/System.Windows.Forms.DataGridView.Virtual_lazyloading/VB/lazyloading.vb#100)]  
  
## <a name="the-idatapageretriever-interface"></a><span data-ttu-id="a5ed3-117">IDataPageRetriever 接口</span><span class="sxs-lookup"><span data-stu-id="a5ed3-117">The IDataPageRetriever Interface</span></span>  
 <span data-ttu-id="a5ed3-118">下面的代码示例定义 `IDataPageRetriever` 接口，该接口由 `DataRetriever` 类实现。</span><span class="sxs-lookup"><span data-stu-id="a5ed3-118">The following code example defines the `IDataPageRetriever` interface, which is implemented by the `DataRetriever` class.</span></span> <span data-ttu-id="a5ed3-119">此接口中声明的唯一方法是 `SupplyPageOfData` 方法，该方法需要一个初始行索引和一个数据页中的行数计数。</span><span class="sxs-lookup"><span data-stu-id="a5ed3-119">The only method declared in this interface is the `SupplyPageOfData` method, which requires an initial row index and a count of the number of rows in a single page of data.</span></span> <span data-ttu-id="a5ed3-120">实施者使用这些值来检索数据源中的数据子集。</span><span class="sxs-lookup"><span data-stu-id="a5ed3-120">These values are used by the implementer to retrieve a subset of data from a data source.</span></span>  
  
 <span data-ttu-id="a5ed3-121">`Cache` 对象在构造过程中使用此接口的实现来加载两个初始页面的数据。</span><span class="sxs-lookup"><span data-stu-id="a5ed3-121">A `Cache` object uses an implementation of this interface during construction to load two initial pages of data.</span></span> <span data-ttu-id="a5ed3-122">只要需要非缓存值，缓存就会丢弃其中的一个页面，并请求包含来自 `IDataPageRetriever`的值的新页面。</span><span class="sxs-lookup"><span data-stu-id="a5ed3-122">Whenever an uncached value is needed, the cache discards one of these pages and requests a new page containing the value from the `IDataPageRetriever`.</span></span>  
  
 [!code-csharp[System.Windows.Forms.DataGridView.Virtual_lazyloading#201](~/samples/snippets/csharp/VS_Snippets_Winforms/System.Windows.Forms.DataGridView.Virtual_lazyloading/CS/lazyloading.cs#201)]
 [!code-vb[System.Windows.Forms.DataGridView.Virtual_lazyloading#201](~/samples/snippets/visualbasic/VS_Snippets_Winforms/System.Windows.Forms.DataGridView.Virtual_lazyloading/VB/lazyloading.vb#201)]  
  
## <a name="the-dataretriever-class"></a><span data-ttu-id="a5ed3-123">DataRetriever 类</span><span class="sxs-lookup"><span data-stu-id="a5ed3-123">The DataRetriever Class</span></span>  
 <span data-ttu-id="a5ed3-124">下面的代码示例定义 `DataRetriever` 类，该类实现 `IDataPageRetriever` 接口以检索服务器中的数据页。</span><span class="sxs-lookup"><span data-stu-id="a5ed3-124">The following code example defines the `DataRetriever` class, which implements the `IDataPageRetriever` interface to retrieve pages of data from a server.</span></span> <span data-ttu-id="a5ed3-125">`DataRetriever` 类还提供 `Columns` 和 `RowCount` 属性，<xref:System.Windows.Forms.DataGridView> 控件使用该属性来创建所需的列并向 <xref:System.Windows.Forms.DataGridView.Rows%2A> 集合添加适当数量的空行。</span><span class="sxs-lookup"><span data-stu-id="a5ed3-125">The `DataRetriever` class also provides `Columns` and `RowCount` properties, which the <xref:System.Windows.Forms.DataGridView> control uses to create the necessary columns and to add the appropriate number of empty rows to the <xref:System.Windows.Forms.DataGridView.Rows%2A> collection.</span></span> <span data-ttu-id="a5ed3-126">需要添加空行，以使控件的行为如同包含表中的所有数据一样。</span><span class="sxs-lookup"><span data-stu-id="a5ed3-126">Adding the empty rows is necessary so that the control will behave as though it contains all the data in the table.</span></span> <span data-ttu-id="a5ed3-127">这意味着滚动条中的滚动框将具有适当的大小，并且用户将可以访问表中的任何行。</span><span class="sxs-lookup"><span data-stu-id="a5ed3-127">This means that the scroll box in the scroll bar will have the appropriate size, and the user will be able to access any row in the table.</span></span> <span data-ttu-id="a5ed3-128">仅当行滚动到视图中时，才会使用 <xref:System.Windows.Forms.DataGridView.CellValueNeeded> 事件处理程序来填充这些行。</span><span class="sxs-lookup"><span data-stu-id="a5ed3-128">The rows are filled by the <xref:System.Windows.Forms.DataGridView.CellValueNeeded> event handler only when they are scrolled into view.</span></span>  
  
 [!code-csharp[System.Windows.Forms.DataGridView.Virtual_lazyloading#200](~/samples/snippets/csharp/VS_Snippets_Winforms/System.Windows.Forms.DataGridView.Virtual_lazyloading/CS/lazyloading.cs#200)]
 [!code-vb[System.Windows.Forms.DataGridView.Virtual_lazyloading#200](~/samples/snippets/visualbasic/VS_Snippets_Winforms/System.Windows.Forms.DataGridView.Virtual_lazyloading/VB/lazyloading.vb#200)]  
  
## <a name="the-cache-class"></a><span data-ttu-id="a5ed3-129">缓存类</span><span class="sxs-lookup"><span data-stu-id="a5ed3-129">The Cache Class</span></span>  
 <span data-ttu-id="a5ed3-130">下面的代码示例定义了 `Cache` 类，该类管理通过 `IDataPageRetriever` 实现填充的两个页数据。</span><span class="sxs-lookup"><span data-stu-id="a5ed3-130">The following code example defines the `Cache` class, which manages two pages of data populated through an `IDataPageRetriever` implementation.</span></span> <span data-ttu-id="a5ed3-131">`Cache` 类定义了一个内部 `DataPage` 结构，该结构包含一个用于将值存储在单个缓存页中的 <xref:System.Data.DataTable>，它计算表示页面的上边界和下边界的行索引。</span><span class="sxs-lookup"><span data-stu-id="a5ed3-131">The `Cache` class defines an inner `DataPage` structure, which contains a <xref:System.Data.DataTable> to store the values in a single cache page and which calculates the row indexes that represent the upper and lower boundaries of the page.</span></span>  
  
 <span data-ttu-id="a5ed3-132">`Cache` 类在构造时加载两个数据页。</span><span class="sxs-lookup"><span data-stu-id="a5ed3-132">The `Cache` class loads two pages of data at construction time.</span></span> <span data-ttu-id="a5ed3-133">每当 <xref:System.Windows.Forms.DataGridView.CellValueNeeded> 事件请求一个值时，`Cache` 对象将确定该值是否在其两个页中的一个页中可用，如果是，则返回该值。</span><span class="sxs-lookup"><span data-stu-id="a5ed3-133">Whenever the <xref:System.Windows.Forms.DataGridView.CellValueNeeded> event requests a value, the `Cache` object determines if the value is available in one of its two pages and, if so, returns it.</span></span> <span data-ttu-id="a5ed3-134">如果值在本地不可用，则 `Cache` 对象将确定其两个页面中的哪一页离当前显示的行最远，并使用包含请求值的新页面替换页面，然后返回。</span><span class="sxs-lookup"><span data-stu-id="a5ed3-134">If the value is not available locally, the `Cache` object determines which of its two pages is farthest from the currently displayed rows and replaces the page with a new one containing the requested value, which it then returns.</span></span>  
  
 <span data-ttu-id="a5ed3-135">假设数据页中的行数与可以在屏幕上同时显示的行数相同，则此模型允许用户分页查看表，以便有效地返回到最近查看的页。</span><span class="sxs-lookup"><span data-stu-id="a5ed3-135">Assuming that the number of rows in a data page is the same as the number of rows that can be displayed on screen at once, this model allows users paging through the table to efficiently return to the most recently viewed page.</span></span>  
  
 [!code-csharp[System.Windows.Forms.DataGridView.Virtual_lazyloading#300](~/samples/snippets/csharp/VS_Snippets_Winforms/System.Windows.Forms.DataGridView.Virtual_lazyloading/CS/lazyloading.cs#300)]
 [!code-vb[System.Windows.Forms.DataGridView.Virtual_lazyloading#300](~/samples/snippets/visualbasic/VS_Snippets_Winforms/System.Windows.Forms.DataGridView.Virtual_lazyloading/VB/lazyloading.vb#300)]  
  
## <a name="additional-considerations"></a><span data-ttu-id="a5ed3-136">추가 고려 사항</span><span class="sxs-lookup"><span data-stu-id="a5ed3-136">Additional Considerations</span></span>  
 <span data-ttu-id="a5ed3-137">前面的代码示例作为实时数据加载的演示提供。</span><span class="sxs-lookup"><span data-stu-id="a5ed3-137">The previous code examples are provided as a demonstration of just-in-time data loading.</span></span> <span data-ttu-id="a5ed3-138">你需要根据自己的需要修改代码以获得最大效率。</span><span class="sxs-lookup"><span data-stu-id="a5ed3-138">You will need to modify the code for your own needs to achieve maximum efficiency.</span></span> <span data-ttu-id="a5ed3-139">至少需要为缓存中每页数据的行数选择适当的值。</span><span class="sxs-lookup"><span data-stu-id="a5ed3-139">At minimum, you will need to choose an appropriate value for the number of rows per page of data in the cache.</span></span> <span data-ttu-id="a5ed3-140">此值将传递到 `Cache` 构造函数。</span><span class="sxs-lookup"><span data-stu-id="a5ed3-140">This value is passed into the `Cache` constructor.</span></span> <span data-ttu-id="a5ed3-141">每页的行数应小于 <xref:System.Windows.Forms.DataGridView> 控件中可同时显示的行数。</span><span class="sxs-lookup"><span data-stu-id="a5ed3-141">The number of rows per page should be no less than the number of rows that can be displayed simultaneously in your <xref:System.Windows.Forms.DataGridView> control.</span></span>  
  
 <span data-ttu-id="a5ed3-142">为了获得最佳结果，你将需要执行性能测试和可用性测试，以确定你的系统和用户的要求。</span><span class="sxs-lookup"><span data-stu-id="a5ed3-142">For best results, you will need to conduct performance testing and usability testing to determine the requirements of your system and your users.</span></span> <span data-ttu-id="a5ed3-143">需要考虑的几个因素包括运行应用程序的客户端计算机上的内存量、所用网络连接的可用带宽，以及所使用服务器的延迟时间。</span><span class="sxs-lookup"><span data-stu-id="a5ed3-143">Several factors that you will need to take into consideration include the amount of memory in the client machines running your application, the available bandwidth of the network connection used, and the latency of the server used.</span></span> <span data-ttu-id="a5ed3-144">带宽和延迟应在高峰使用时间进行确定。</span><span class="sxs-lookup"><span data-stu-id="a5ed3-144">The bandwidth and latency should be determined at times of peak usage.</span></span>  
  
 <span data-ttu-id="a5ed3-145">若要提高应用程序的滚动性能，可以增加本地存储的数据量。</span><span class="sxs-lookup"><span data-stu-id="a5ed3-145">To improve the scrolling performance of your application, you can increase the amount of data stored locally.</span></span> <span data-ttu-id="a5ed3-146">然而，若要改善启动时间，必须避免最初加载过多数据。</span><span class="sxs-lookup"><span data-stu-id="a5ed3-146">To improve startup time, however, you must avoid loading too much data initially.</span></span> <span data-ttu-id="a5ed3-147">你可能想要修改 `Cache` 类以增加它可以存储的数据页的数目。</span><span class="sxs-lookup"><span data-stu-id="a5ed3-147">You may want to modify the `Cache` class to increase the number of data pages it can store.</span></span> <span data-ttu-id="a5ed3-148">使用更多数据页可以提高滚动效率，但需要确定数据页中的理想行数，具体取决于可用带宽和服务器延迟。</span><span class="sxs-lookup"><span data-stu-id="a5ed3-148">Using more data pages can improve scrolling efficiency, but you will need to determine the ideal number of rows in a data page, depending on the available bandwidth and the server latency.</span></span> <span data-ttu-id="a5ed3-149">使用较小的页，将会更频繁地访问服务器，但需要更少的时间来返回所请求的数据。</span><span class="sxs-lookup"><span data-stu-id="a5ed3-149">With smaller pages, the server will be accessed more frequently, but will take less time to return the requested data.</span></span> <span data-ttu-id="a5ed3-150">如果延迟是比带宽更多的问题，则可能需要使用较大的数据页。</span><span class="sxs-lookup"><span data-stu-id="a5ed3-150">If latency is more of an issue than bandwidth, you may want to use larger data pages.</span></span>  
  
## <a name="see-also"></a><span data-ttu-id="a5ed3-151">另请参阅</span><span class="sxs-lookup"><span data-stu-id="a5ed3-151">See also</span></span>

- <xref:System.Windows.Forms.DataGridView>
- <xref:System.Windows.Forms.DataGridView.VirtualMode%2A>
- [<span data-ttu-id="a5ed3-152">Windows Forms DataGridView 컨트롤의 성능 조정</span><span class="sxs-lookup"><span data-stu-id="a5ed3-152">Performance Tuning in the Windows Forms DataGridView Control</span></span>](performance-tuning-in-the-windows-forms-datagridview-control.md)
- [<span data-ttu-id="a5ed3-153">Windows Forms DataGridView 컨트롤의 크기를 조정하는 최선의 방법</span><span class="sxs-lookup"><span data-stu-id="a5ed3-153">Best Practices for Scaling the Windows Forms DataGridView Control</span></span>](best-practices-for-scaling-the-windows-forms-datagridview-control.md)
- [<span data-ttu-id="a5ed3-154">Windows Forms DataGridView 컨트롤의 가상 모드</span><span class="sxs-lookup"><span data-stu-id="a5ed3-154">Virtual Mode in the Windows Forms DataGridView Control</span></span>](virtual-mode-in-the-windows-forms-datagridview-control.md)
- [<span data-ttu-id="a5ed3-155">연습: Windows Forms DataGridView 컨트롤에서 가상 모드 구현</span><span class="sxs-lookup"><span data-stu-id="a5ed3-155">Walkthrough: Implementing Virtual Mode in the Windows Forms DataGridView Control</span></span>](implementing-virtual-mode-wf-datagridview-control.md)
- [<span data-ttu-id="a5ed3-156">방법: Windows Forms DataGridView 컨트롤에서 Just-In-Time 데이터 로드를 사용하여 가상 모드 구현</span><span class="sxs-lookup"><span data-stu-id="a5ed3-156">How to: Implement Virtual Mode with Just-In-Time Data Loading in the Windows Forms DataGridView Control</span></span>](virtual-mode-with-just-in-time-data-loading-in-the-datagrid.md)
