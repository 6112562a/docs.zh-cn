---
title: 在 Windows 窗体 DataGridView 控件中实现实时数据加载的虚拟模式
ms.date: 03/30/2017
dev_langs:
- csharp
- vb
helpviewer_keywords:
- examples [Windows Forms], just-in-time data loading
- data [Windows Forms], managing large data sets
- DataGridView control [Windows Forms], virtual mode
- just-in-time data loading
- DataGridView control [Windows Forms], large data sets
- virtual mode [Windows Forms], just-in-time data loading
ms.assetid: c2a052b9-423c-4ff7-91dc-d8c7c79345f6
ms.openlocfilehash: 641db19cc6493a20c9f9a34622f466e3623c32ad
ms.sourcegitcommit: 0be8a279af6d8a43e03141e349d3efd5d35f8767
ms.translationtype: MT
ms.contentlocale: zh-CN
ms.lasthandoff: 04/18/2019
ms.locfileid: "59088647"
---
# <a name="implementing-virtual-mode-with-just-in-time-data-loading-in-the-windows-forms-datagridview-control"></a><span data-ttu-id="c45c0-102">在 Windows 窗体 DataGridView 控件中实现实时数据加载的虚拟模式</span><span class="sxs-lookup"><span data-stu-id="c45c0-102">Implementing Virtual Mode with Just-In-Time Data Loading in the Windows Forms DataGridView Control</span></span>
<span data-ttu-id="c45c0-103">实现中的虚拟模式的一个原因<xref:System.Windows.Forms.DataGridView>控件是仅在需要时检索数据。</span><span class="sxs-lookup"><span data-stu-id="c45c0-103">One reason to implement virtual mode in the <xref:System.Windows.Forms.DataGridView> control is to retrieve data only as it is needed.</span></span> <span data-ttu-id="c45c0-104">这称为*中实时数据加载*。</span><span class="sxs-lookup"><span data-stu-id="c45c0-104">This is called *just-in-time data loading*.</span></span>  
  
 <span data-ttu-id="c45c0-105">如果您正在使用远程数据库中的大型表，例如，您可能希望避免通过检索数据所需的显示和检索其他数据，仅当用户滚动到视图中新行时启动延迟。</span><span class="sxs-lookup"><span data-stu-id="c45c0-105">If you are working with a very large table in a remote database, for example, you might want to avoid startup delays by retrieving only the data that is necessary for display and retrieving additional data only when the user scrolls new rows into view.</span></span> <span data-ttu-id="c45c0-106">如果运行你的应用程序的客户端计算机具有有限的数量的内存可用于存储数据，可能想要从数据库检索新值时放弃未使用的数据。</span><span class="sxs-lookup"><span data-stu-id="c45c0-106">If the client computers running your application have a limited amount of memory available for storing data, you might also want to discard unused data when retrieving new values from the database.</span></span>  
  
 <span data-ttu-id="c45c0-107">以下部分介绍如何使用<xref:System.Windows.Forms.DataGridView>中实时缓存使用的控件。</span><span class="sxs-lookup"><span data-stu-id="c45c0-107">The following sections describe how to use a <xref:System.Windows.Forms.DataGridView> control with a just-in-time cache.</span></span>  
  
 <span data-ttu-id="c45c0-108">要将本主题中的代码作为单个列表进行复制，请参阅[如何：实现虚拟模式在 Windows 中实时数据加载窗体 DataGridView 控件](virtual-mode-with-just-in-time-data-loading-in-the-datagrid.md)。</span><span class="sxs-lookup"><span data-stu-id="c45c0-108">To copy the code in this topic as a single listing, see [How to: Implement Virtual Mode with Just-In-Time Data Loading in the Windows Forms DataGridView Control](virtual-mode-with-just-in-time-data-loading-in-the-datagrid.md).</span></span>  
  
## <a name="the-form"></a><span data-ttu-id="c45c0-109">在窗体</span><span class="sxs-lookup"><span data-stu-id="c45c0-109">The Form</span></span>  
 <span data-ttu-id="c45c0-110">下面的代码示例定义一个包含一个只读的窗体<xref:System.Windows.Forms.DataGridView>与交互的控件`Cache`对象，通过<xref:System.Windows.Forms.DataGridView.CellValueNeeded>事件处理程序。</span><span class="sxs-lookup"><span data-stu-id="c45c0-110">The following code example defines a form containing a read-only <xref:System.Windows.Forms.DataGridView> control that interacts with a `Cache` object through a <xref:System.Windows.Forms.DataGridView.CellValueNeeded> event handler.</span></span> <span data-ttu-id="c45c0-111">`Cache`对象管理的本地存储的值，并使用`DataRetriever`要从 Northwind 示例数据库的订单表中检索值对象。</span><span class="sxs-lookup"><span data-stu-id="c45c0-111">The `Cache` object manages the locally stored values and uses a `DataRetriever` object to retrieve values from the Orders table of the sample Northwind database.</span></span> <span data-ttu-id="c45c0-112">`DataRetriever`对象，用于实现`IDataPageRetriever`所需的接口`Cache`类中，还用来初始化<xref:System.Windows.Forms.DataGridView>控制行和列。</span><span class="sxs-lookup"><span data-stu-id="c45c0-112">The `DataRetriever` object, which implements the `IDataPageRetriever` interface required by the `Cache` class, is also used to initialize the <xref:System.Windows.Forms.DataGridView> control rows and columns.</span></span>  
  
 <span data-ttu-id="c45c0-113">`IDataPageRetriever`， `DataRetriever`，和`Cache`更高版本中本主题介绍了类型。</span><span class="sxs-lookup"><span data-stu-id="c45c0-113">The `IDataPageRetriever`, `DataRetriever`, and `Cache` types are described later in this topic.</span></span>  
  
> [!NOTE]
>  <span data-ttu-id="c45c0-114">将敏感信息（如密码）存储在连接字符串中可能会影响应用程序的安全性。</span><span class="sxs-lookup"><span data-stu-id="c45c0-114">Storing sensitive information, such as a password, within the connection string can affect the security of your application.</span></span> <span data-ttu-id="c45c0-115">若要控制对数据库的访问，一种较为安全的方法是使用 Windows 身份验证（也称为集成安全性）。</span><span class="sxs-lookup"><span data-stu-id="c45c0-115">Using Windows Authentication (also known as integrated security) is a more secure way to control access to a database.</span></span> <span data-ttu-id="c45c0-116">有关详细信息，请参阅[保护连接信息](../../data/adonet/protecting-connection-information.md)。</span><span class="sxs-lookup"><span data-stu-id="c45c0-116">For more information, see [Protecting Connection Information](../../data/adonet/protecting-connection-information.md).</span></span>  
  
 [!code-csharp[System.Windows.Forms.DataGridView.Virtual_lazyloading#100](~/samples/snippets/csharp/VS_Snippets_Winforms/System.Windows.Forms.DataGridView.Virtual_lazyloading/CS/lazyloading.cs#100)]
 [!code-vb[System.Windows.Forms.DataGridView.Virtual_lazyloading#100](~/samples/snippets/visualbasic/VS_Snippets_Winforms/System.Windows.Forms.DataGridView.Virtual_lazyloading/VB/lazyloading.vb#100)]  
  
## <a name="the-idatapageretriever-interface"></a><span data-ttu-id="c45c0-117">IDataPageRetriever 接口</span><span class="sxs-lookup"><span data-stu-id="c45c0-117">The IDataPageRetriever Interface</span></span>  
 <span data-ttu-id="c45c0-118">下面的代码示例定义`IDataPageRetriever`接口，由实现`DataRetriever`类。</span><span class="sxs-lookup"><span data-stu-id="c45c0-118">The following code example defines the `IDataPageRetriever` interface, which is implemented by the `DataRetriever` class.</span></span> <span data-ttu-id="c45c0-119">在此接口中声明的唯一方法是`SupplyPageOfData`方法，它需要的初始行索引和数据的一页中的行数的计数。</span><span class="sxs-lookup"><span data-stu-id="c45c0-119">The only method declared in this interface is the `SupplyPageOfData` method, which requires an initial row index and a count of the number of rows in a single page of data.</span></span> <span data-ttu-id="c45c0-120">实施者使用这些值来从数据源检索数据的子集。</span><span class="sxs-lookup"><span data-stu-id="c45c0-120">These values are used by the implementer to retrieve a subset of data from a data source.</span></span>  
  
 <span data-ttu-id="c45c0-121">一个`Cache`对象使用在构造期间，此接口的实现来加载数据的两个初始页。</span><span class="sxs-lookup"><span data-stu-id="c45c0-121">A `Cache` object uses an implementation of this interface during construction to load two initial pages of data.</span></span> <span data-ttu-id="c45c0-122">无论何时需要未缓存的值，缓存将丢弃这些页之一并请求一个包含中的值的新页面`IDataPageRetriever`。</span><span class="sxs-lookup"><span data-stu-id="c45c0-122">Whenever an uncached value is needed, the cache discards one of these pages and requests a new page containing the value from the `IDataPageRetriever`.</span></span>  
  
 [!code-csharp[System.Windows.Forms.DataGridView.Virtual_lazyloading#201](~/samples/snippets/csharp/VS_Snippets_Winforms/System.Windows.Forms.DataGridView.Virtual_lazyloading/CS/lazyloading.cs#201)]
 [!code-vb[System.Windows.Forms.DataGridView.Virtual_lazyloading#201](~/samples/snippets/visualbasic/VS_Snippets_Winforms/System.Windows.Forms.DataGridView.Virtual_lazyloading/VB/lazyloading.vb#201)]  
  
## <a name="the-dataretriever-class"></a><span data-ttu-id="c45c0-123">DataRetriever 类</span><span class="sxs-lookup"><span data-stu-id="c45c0-123">The DataRetriever Class</span></span>  
 <span data-ttu-id="c45c0-124">下面的代码示例定义`DataRetriever`类，该类实现`IDataPageRetriever`接口以从服务器中检索的数据页。</span><span class="sxs-lookup"><span data-stu-id="c45c0-124">The following code example defines the `DataRetriever` class, which implements the `IDataPageRetriever` interface to retrieve pages of data from a server.</span></span> <span data-ttu-id="c45c0-125">`DataRetriever`类还提供了`Columns`并`RowCount`属性，其中<xref:System.Windows.Forms.DataGridView>控件使用以创建必要的列，并添加适当数量的空的行<xref:System.Windows.Forms.DataGridView.Rows%2A>集合。</span><span class="sxs-lookup"><span data-stu-id="c45c0-125">The `DataRetriever` class also provides `Columns` and `RowCount` properties, which the <xref:System.Windows.Forms.DataGridView> control uses to create the necessary columns and to add the appropriate number of empty rows to the <xref:System.Windows.Forms.DataGridView.Rows%2A> collection.</span></span> <span data-ttu-id="c45c0-126">添加空的行是必需的因此，控件的行为就好像它包含在表中的所有数据。</span><span class="sxs-lookup"><span data-stu-id="c45c0-126">Adding the empty rows is necessary so that the control will behave as though it contains all the data in the table.</span></span> <span data-ttu-id="c45c0-127">这意味着，滚动条中的滚动框将具有适当的大小，并且用户将能够访问表中的任何行。</span><span class="sxs-lookup"><span data-stu-id="c45c0-127">This means that the scroll box in the scroll bar will have the appropriate size, and the user will be able to access any row in the table.</span></span> <span data-ttu-id="c45c0-128">行填充<xref:System.Windows.Forms.DataGridView.CellValueNeeded>事件处理程序仅当它们滚动到视图时。</span><span class="sxs-lookup"><span data-stu-id="c45c0-128">The rows are filled by the <xref:System.Windows.Forms.DataGridView.CellValueNeeded> event handler only when they are scrolled into view.</span></span>  
  
 [!code-csharp[System.Windows.Forms.DataGridView.Virtual_lazyloading#200](~/samples/snippets/csharp/VS_Snippets_Winforms/System.Windows.Forms.DataGridView.Virtual_lazyloading/CS/lazyloading.cs#200)]
 [!code-vb[System.Windows.Forms.DataGridView.Virtual_lazyloading#200](~/samples/snippets/visualbasic/VS_Snippets_Winforms/System.Windows.Forms.DataGridView.Virtual_lazyloading/VB/lazyloading.vb#200)]  
  
## <a name="the-cache-class"></a><span data-ttu-id="c45c0-129">缓存类</span><span class="sxs-lookup"><span data-stu-id="c45c0-129">The Cache Class</span></span>  
 <span data-ttu-id="c45c0-130">下面的代码示例定义`Cache`类，该类管理两个通过填充的数据页`IDataPageRetriever`实现。</span><span class="sxs-lookup"><span data-stu-id="c45c0-130">The following code example defines the `Cache` class, which manages two pages of data populated through an `IDataPageRetriever` implementation.</span></span> <span data-ttu-id="c45c0-131">`Cache`类定义一个内部`DataPage`结构，其中包含<xref:System.Data.DataTable>若要将值存储在单个缓存页，并且计算的行索引表示页的上限和下限边界。</span><span class="sxs-lookup"><span data-stu-id="c45c0-131">The `Cache` class defines an inner `DataPage` structure, which contains a <xref:System.Data.DataTable> to store the values in a single cache page and which calculates the row indexes that represent the upper and lower boundaries of the page.</span></span>  
  
 <span data-ttu-id="c45c0-132">`Cache`类在构造时加载两个数据页。</span><span class="sxs-lookup"><span data-stu-id="c45c0-132">The `Cache` class loads two pages of data at construction time.</span></span> <span data-ttu-id="c45c0-133">每当<xref:System.Windows.Forms.DataGridView.CellValueNeeded>事件请求一个值，`Cache`对象确定值现已推出一个其两个页面，如果是这样，将其返回。</span><span class="sxs-lookup"><span data-stu-id="c45c0-133">Whenever the <xref:System.Windows.Forms.DataGridView.CellValueNeeded> event requests a value, the `Cache` object determines if the value is available in one of its two pages and, if so, returns it.</span></span> <span data-ttu-id="c45c0-134">如果值不在本地可用时，`Cache`对象确定这两个页面最当前显示的行和页替换新建一个包含请求的值，然后将其返回。</span><span class="sxs-lookup"><span data-stu-id="c45c0-134">If the value is not available locally, the `Cache` object determines which of its two pages is farthest from the currently displayed rows and replaces the page with a new one containing the requested value, which it then returns.</span></span>  
  
 <span data-ttu-id="c45c0-135">假定数据页中的行数是可以同时在屏幕显示的行数相同，此模型允许用户通过表分页若要有效地返回到最近查看的页。</span><span class="sxs-lookup"><span data-stu-id="c45c0-135">Assuming that the number of rows in a data page is the same as the number of rows that can be displayed on screen at once, this model allows users paging through the table to efficiently return to the most recently viewed page.</span></span>  
  
 [!code-csharp[System.Windows.Forms.DataGridView.Virtual_lazyloading#300](~/samples/snippets/csharp/VS_Snippets_Winforms/System.Windows.Forms.DataGridView.Virtual_lazyloading/CS/lazyloading.cs#300)]
 [!code-vb[System.Windows.Forms.DataGridView.Virtual_lazyloading#300](~/samples/snippets/visualbasic/VS_Snippets_Winforms/System.Windows.Forms.DataGridView.Virtual_lazyloading/VB/lazyloading.vb#300)]  
  
## <a name="additional-considerations"></a><span data-ttu-id="c45c0-136">其他注意事项</span><span class="sxs-lookup"><span data-stu-id="c45c0-136">Additional Considerations</span></span>  
 <span data-ttu-id="c45c0-137">前面的代码示例演示在实时数据加载提供。</span><span class="sxs-lookup"><span data-stu-id="c45c0-137">The previous code examples are provided as a demonstration of just-in-time data loading.</span></span> <span data-ttu-id="c45c0-138">你将需要修改自己的需要来达到最高效率的代码。</span><span class="sxs-lookup"><span data-stu-id="c45c0-138">You will need to modify the code for your own needs to achieve maximum efficiency.</span></span> <span data-ttu-id="c45c0-139">最小值，需要在缓存中选择适当的值的数据的每页行数。</span><span class="sxs-lookup"><span data-stu-id="c45c0-139">At minimum, you will need to choose an appropriate value for the number of rows per page of data in the cache.</span></span> <span data-ttu-id="c45c0-140">此值传递到`Cache`构造函数。</span><span class="sxs-lookup"><span data-stu-id="c45c0-140">This value is passed into the `Cache` constructor.</span></span> <span data-ttu-id="c45c0-141">每页行数应为不低于可以同时在显示的行数在<xref:System.Windows.Forms.DataGridView>控件。</span><span class="sxs-lookup"><span data-stu-id="c45c0-141">The number of rows per page should be no less than the number of rows that can be displayed simultaneously in your <xref:System.Windows.Forms.DataGridView> control.</span></span>  
  
 <span data-ttu-id="c45c0-142">为获得最佳结果，需要进行性能测试和可用性测试，以确定您的系统和用户的要求。</span><span class="sxs-lookup"><span data-stu-id="c45c0-142">For best results, you will need to conduct performance testing and usability testing to determine the requirements of your system and your users.</span></span> <span data-ttu-id="c45c0-143">将需要考虑的几个因素包括客户端计算机运行你的应用程序、 可用带宽的使用的网络连接和使用的服务器的滞后时间中的内存量。</span><span class="sxs-lookup"><span data-stu-id="c45c0-143">Several factors that you will need to take into consideration include the amount of memory in the client machines running your application, the available bandwidth of the network connection used, and the latency of the server used.</span></span> <span data-ttu-id="c45c0-144">带宽和延迟应确定有时的高峰使用期。</span><span class="sxs-lookup"><span data-stu-id="c45c0-144">The bandwidth and latency should be determined at times of peak usage.</span></span>  
  
 <span data-ttu-id="c45c0-145">若要提高你的应用程序的滚动性能，可以增加本地存储的数据量。</span><span class="sxs-lookup"><span data-stu-id="c45c0-145">To improve the scrolling performance of your application, you can increase the amount of data stored locally.</span></span> <span data-ttu-id="c45c0-146">若要提高启动时间，但是，必须避免最初加载过多的数据。</span><span class="sxs-lookup"><span data-stu-id="c45c0-146">To improve startup time, however, you must avoid loading too much data initially.</span></span> <span data-ttu-id="c45c0-147">你可能想要修改`Cache`类，以增加可以存储的数据页的数目。</span><span class="sxs-lookup"><span data-stu-id="c45c0-147">You may want to modify the `Cache` class to increase the number of data pages it can store.</span></span> <span data-ttu-id="c45c0-148">使用多个数据页可提高滚动效率，但将需要确定的理想数据页中，具体取决于可用带宽和服务器延迟中的行数。</span><span class="sxs-lookup"><span data-stu-id="c45c0-148">Using more data pages can improve scrolling efficiency, but you will need to determine the ideal number of rows in a data page, depending on the available bandwidth and the server latency.</span></span> <span data-ttu-id="c45c0-149">使用较小的页，服务器将更频繁地访问，但需要更少的时间才能返回所请求的数据。</span><span class="sxs-lookup"><span data-stu-id="c45c0-149">With smaller pages, the server will be accessed more frequently, but will take less time to return the requested data.</span></span> <span data-ttu-id="c45c0-150">如果延迟的带宽比问题的详细信息，你可能想要使用较大的数据页。</span><span class="sxs-lookup"><span data-stu-id="c45c0-150">If latency is more of an issue than bandwidth, you may want to use larger data pages.</span></span>  
  
## <a name="see-also"></a><span data-ttu-id="c45c0-151">请参阅</span><span class="sxs-lookup"><span data-stu-id="c45c0-151">See also</span></span>

- <xref:System.Windows.Forms.DataGridView>
- <xref:System.Windows.Forms.DataGridView.VirtualMode%2A>
- [<span data-ttu-id="c45c0-152">Windows 窗体 DataGridView 控件中的性能调整</span><span class="sxs-lookup"><span data-stu-id="c45c0-152">Performance Tuning in the Windows Forms DataGridView Control</span></span>](performance-tuning-in-the-windows-forms-datagridview-control.md)
- [<span data-ttu-id="c45c0-153">有关缩放 Windows 窗体 DataGridView 控件的最佳做法</span><span class="sxs-lookup"><span data-stu-id="c45c0-153">Best Practices for Scaling the Windows Forms DataGridView Control</span></span>](best-practices-for-scaling-the-windows-forms-datagridview-control.md)
- [<span data-ttu-id="c45c0-154">Windows 窗体 DataGridView 控件中的虚拟模式</span><span class="sxs-lookup"><span data-stu-id="c45c0-154">Virtual Mode in the Windows Forms DataGridView Control</span></span>](virtual-mode-in-the-windows-forms-datagridview-control.md)
- [<span data-ttu-id="c45c0-155">演练：在 Windows 窗体 DataGridView 控件中实现虚拟模式</span><span class="sxs-lookup"><span data-stu-id="c45c0-155">Walkthrough: Implementing Virtual Mode in the Windows Forms DataGridView Control</span></span>](implementing-virtual-mode-wf-datagridview-control.md)
- [<span data-ttu-id="c45c0-156">如何：在 Windows 窗体 DataGridView 控件中实现虚拟模式下在实时数据加载</span><span class="sxs-lookup"><span data-stu-id="c45c0-156">How to: Implement Virtual Mode with Just-In-Time Data Loading in the Windows Forms DataGridView Control</span></span>](virtual-mode-with-just-in-time-data-loading-in-the-datagrid.md)
