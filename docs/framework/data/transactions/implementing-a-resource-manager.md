---
title: 实现资源管理器
ms.date: 03/30/2017
ms.assetid: d5c153f6-4419-49e3-a5f1-a50ae4c81bf3
ms.openlocfilehash: f3e29dae095fbe56181cf7b67787c1044efa07ae
ms.sourcegitcommit: 9b552addadfb57fab0b9e7852ed4f1f1b8a42f8e
ms.translationtype: MT
ms.contentlocale: zh-CN
ms.lasthandoff: 04/23/2019
ms.locfileid: "61793700"
---
# <a name="implementing-a-resource-manager"></a><span data-ttu-id="ed565-102">实现资源管理器</span><span class="sxs-lookup"><span data-stu-id="ed565-102">Implementing a Resource Manager</span></span>
<span data-ttu-id="ed565-103">事务中使用的每个资源都由资源管理器进行管理，而后者的操作则由事务管理器进行协调。</span><span class="sxs-lookup"><span data-stu-id="ed565-103">Each resource used in a transaction is managed by a resource manager, whose actions are coordinated by a transaction manager.</span></span> <span data-ttu-id="ed565-104">资源管理器与事务管理器协调工作，为应用程序提供了原子性和隔离性的保证。</span><span class="sxs-lookup"><span data-stu-id="ed565-104">Resource managers work in cooperation with the transaction manager to provide the application with a guarantee of atomicity and isolation.</span></span> <span data-ttu-id="ed565-105">例如，Microsoft SQL Server、持久消息队列、内存中的哈希表都是资源管理器。</span><span class="sxs-lookup"><span data-stu-id="ed565-105">Microsoft SQL Server, durable message queues, in-memory hash tables are all examples of resource managers.</span></span>  
  
 <span data-ttu-id="ed565-106">资源管理器可管理持久或可变数据。</span><span class="sxs-lookup"><span data-stu-id="ed565-106">A resource manager manages either durable or volatile data.</span></span> <span data-ttu-id="ed565-107">资源管理器的持久性（反之为可变性）是指资源管理器是否支持故障恢复。</span><span class="sxs-lookup"><span data-stu-id="ed565-107">The durability (or conversely the volatility) of a resource manager refers to whether the resource manager supports failure recovery.</span></span> <span data-ttu-id="ed565-108">如果资源管理器支持故障恢复，则它会在第 1 阶段（准备阶段）将数据保存到持久存储区中；这样，一旦资源管理器出现故障，它就可在恢复时在事务中重新登记，并根据从 TM 接收到的通知执行适当的操作。</span><span class="sxs-lookup"><span data-stu-id="ed565-108">If a resource manager supports failure recovery, it persists data to durable storage during Phase1 (prepare) such that if the resource manager goes down, it can re-enlist in the transaction upon recovery and perform the proper actions based on the notifications received from the transaction manager.</span></span> <span data-ttu-id="ed565-109">通常，可变资源管理器管理如内存中的数据结构之类的可变资源（如内存中的事务处理哈希表），而持久资源管理器则管理具有更持久的后备存储区的资源（例如，其后备存储区为磁盘的数据库）。</span><span class="sxs-lookup"><span data-stu-id="ed565-109">In general, volatile resource managers manage volatile resources such as an in-memory data structure (for example, an in-memory transacted-hashtable), and durable resource managers manage resources that have a more persistent backing store (for example, a database whose backing store is disk).</span></span>  
  
 <span data-ttu-id="ed565-110">资源若要参与事务，它必须在事务中进行登记。</span><span class="sxs-lookup"><span data-stu-id="ed565-110">In order for a resource to participate in a transaction, it must enlist in the transaction.</span></span> <span data-ttu-id="ed565-111"><xref:System.Transactions.Transaction>类定义一组方法名称开头**登记**提供此功能。</span><span class="sxs-lookup"><span data-stu-id="ed565-111">The <xref:System.Transactions.Transaction> class defines a set of methods whose names begin with **Enlist** that provide this functionality.</span></span> <span data-ttu-id="ed565-112">不同**登记**方法对应于不同类型的资源管理器可能具有的登记。</span><span class="sxs-lookup"><span data-stu-id="ed565-112">The different **Enlist** methods correspond to the different types of enlistment that a resource manager may have.</span></span> <span data-ttu-id="ed565-113">具体来说，<xref:System.Transactions.Transaction.EnlistVolatile%2A> 方法用于登记可变资源，而 <xref:System.Transactions.Transaction.EnlistDurable%2A> 方法则用于登记持久资源。</span><span class="sxs-lookup"><span data-stu-id="ed565-113">Specifically, you use the <xref:System.Transactions.Transaction.EnlistVolatile%2A> methods for volatile resources, and the <xref:System.Transactions.Transaction.EnlistDurable%2A> method for durable resources.</span></span> <span data-ttu-id="ed565-114">为了简单起见，在根据资源的持久性支持决定是使用 <xref:System.Transactions.Transaction.EnlistDurable%2A> 还是 <xref:System.Transactions.Transaction.EnlistVolatile%2A> 方法后，应为资源管理器实现 <xref:System.Transactions.IEnlistmentNotification> 接口，从而将资源登记为参与两阶段提交 (2PC)。</span><span class="sxs-lookup"><span data-stu-id="ed565-114">For simplicity, after deciding whether to use the <xref:System.Transactions.Transaction.EnlistDurable%2A> or <xref:System.Transactions.Transaction.EnlistVolatile%2A> method based on your resource's durability support, you should enlist your resource to participate in Two Phase Commit (2PC) by implementing the <xref:System.Transactions.IEnlistmentNotification> interface for your resource manager.</span></span> <span data-ttu-id="ed565-115">有关 2PC 的更多信息，请参阅[单阶段和多阶段中提交事务](../../../../docs/framework/data/transactions/committing-a-transaction-in-single-phase-and-multi-phase.md)。</span><span class="sxs-lookup"><span data-stu-id="ed565-115">For more information on 2PC, see [Committing a Transaction in Single-Phase and Multi-Phase](../../../../docs/framework/data/transactions/committing-a-transaction-in-single-phase-and-multi-phase.md).</span></span>  
  
 <span data-ttu-id="ed565-116">通过登记，资源管理器可确保在事务提交或中止时能够从事务管理器获取回调。</span><span class="sxs-lookup"><span data-stu-id="ed565-116">By enlisting, the resource manager ensures that it gets callbacks from the transaction manager when the transaction commits or aborts.</span></span> <span data-ttu-id="ed565-117">每个登记都有一个 <xref:System.Transactions.IEnlistmentNotification> 实例。</span><span class="sxs-lookup"><span data-stu-id="ed565-117">There is one instance of <xref:System.Transactions.IEnlistmentNotification> per enlistment.</span></span> <span data-ttu-id="ed565-118">通常情况下，在每个事务中只执行一次登记，但资源管理器可选择在同一事务中执行多次登记。</span><span class="sxs-lookup"><span data-stu-id="ed565-118">Typically, there is one enlistment per transaction, but a resource manager can choose to enlist multiple times in the same transaction.</span></span>  
  
 <span data-ttu-id="ed565-119">登记后，资源管理器会对事务的请求做出响应。</span><span class="sxs-lookup"><span data-stu-id="ed565-119">After enlistment, the resource manager responds to the transaction's requests.</span></span> <span data-ttu-id="ed565-120">持久资源管理器存储了足够的信息，可允许在它所管理的资源上撤消或重做事务的工作。</span><span class="sxs-lookup"><span data-stu-id="ed565-120">A durable resource manager stores enough information to allow it to either undo or redo the transaction's work on resources it manages.</span></span> <span data-ttu-id="ed565-121">可以使用许多方法来实现此目的；最常采用的两种方法是保存数据版本和保存更改日志。</span><span class="sxs-lookup"><span data-stu-id="ed565-121">There are many ways to do this; keeping versions of data or keeping a log of the changes are two common techniques.</span></span>  
  
 <span data-ttu-id="ed565-122">当应用程序提交事务时，事务管理器会启动两阶段提交协议。</span><span class="sxs-lookup"><span data-stu-id="ed565-122">When the application commits the transaction, the transaction manager initiates the two-phase commit protocol.</span></span> <span data-ttu-id="ed565-123">事务管理器先向每个已登记的资源管理器询问它是否已准备好提交事务。</span><span class="sxs-lookup"><span data-stu-id="ed565-123">The transaction manager first asks each enlisted resource manager if it is prepared to commit the transaction.</span></span> <span data-ttu-id="ed565-124">资源管理器必须准备好提交，即它自身准备好提交或中止事务。</span><span class="sxs-lookup"><span data-stu-id="ed565-124">The resource manager must prepare to commit—it readies itself to either commit or abort the transaction.</span></span>  
  
 <span data-ttu-id="ed565-125">在准备阶段，持久资源管理器会将旧数据和新数据记录到固定存储区中，以便即使系统出现故障，资源管理器也可恢复数据。</span><span class="sxs-lookup"><span data-stu-id="ed565-125">During the prepare phase, the durable resource manager records the old and new data in stable storage so that the resource manager can recover it even if the system fails.</span></span> <span data-ttu-id="ed565-126">如果资源管理器准备就绪，就会向事务管理器通知有关它是提交还是中止事务的投票。</span><span class="sxs-lookup"><span data-stu-id="ed565-126">If the resource manager can prepare, it informs the transaction manager its vote on whether to commit or abort the transaction.</span></span> <span data-ttu-id="ed565-127">如果有任何资源管理器报告准备失败，则事务管理器会将回滚命令发送给每个资源管理器，并向应用程序指出提交失败。</span><span class="sxs-lookup"><span data-stu-id="ed565-127">If any resource manager reports a failure to prepare, the transaction manager sends a rollback command to each resource manager and indicates the failure of the commit to the application.</span></span>  
  
 <span data-ttu-id="ed565-128">在准备就绪后，资源管理器必须等待，直到它在第 2 阶段中从事务管理器获取提交或中止回调为止。</span><span class="sxs-lookup"><span data-stu-id="ed565-128">Once prepared, a resource manager must wait until it gets a commit or abort callback from the transaction manager in phase 2.</span></span> <span data-ttu-id="ed565-129">通常，整个准备和提交协议不到一秒即可完成。</span><span class="sxs-lookup"><span data-stu-id="ed565-129">Typically, the entire prepare and commit protocol completes in a fraction of a second.</span></span> <span data-ttu-id="ed565-130">如果发生系统或通信故障，则提交或中止通知可能无法在几分钟或几小时内送达。</span><span class="sxs-lookup"><span data-stu-id="ed565-130">If there are system or communication failures, the commit or abort notification may not arrive for minutes or hours.</span></span> <span data-ttu-id="ed565-131">在此期间，资源管理器将无法确定事务的结果，</span><span class="sxs-lookup"><span data-stu-id="ed565-131">During this period, the resource manager is in doubt about the outcome of the transaction.</span></span> <span data-ttu-id="ed565-132">即不知道事务是已提交还是已中止。</span><span class="sxs-lookup"><span data-stu-id="ed565-132">It does not know whether the transaction committed or aborted.</span></span> <span data-ttu-id="ed565-133">当资源管理器不确定事务状态时，它会通过使事务处于锁定状态来保留已修改的数据，从而将这些更改与任何其他事务隔离开。</span><span class="sxs-lookup"><span data-stu-id="ed565-133">While the resource manager is in doubt about a transaction, it keeps the data modified by keeping the transaction locked, thereby isolating these changes from any other transactions.</span></span>  
  
 <span data-ttu-id="ed565-134">如果资源管理器发生故障，则除了在发生故障之前已准备或提交的事务之外，其余所有已登记事务都将中止。</span><span class="sxs-lookup"><span data-stu-id="ed565-134">When a resource manager fails, all of its enlisted transactions are aborted except for those that are prepared or committed prior to the failure.</span></span> <span data-ttu-id="ed565-135">当持久资源管理器重新启动时，它会通过检索在准备阶段编写的准备信息重新构建资源的已提交状态，并相应地提交或中止这些事务。</span><span class="sxs-lookup"><span data-stu-id="ed565-135">When a durable resource manager restarts, it reconstructs the committed state of the resources it manages by retrieving the prepare information written in the prepare phase, and commits or aborts these transactions accordingly.</span></span>  
  
 <span data-ttu-id="ed565-136">总之，两阶段提交协议和资源管理器共同使事务具有了原子性和持久性。</span><span class="sxs-lookup"><span data-stu-id="ed565-136">In summary, the two-phase commit protocol and the resource managers combine to make transactions atomic and durable.</span></span>  
  
 <span data-ttu-id="ed565-137"><xref:System.Transactions.Transaction> 类还提供了 <xref:System.Transactions.Transaction.EnlistPromotableSinglePhase%2A> 方法来登记可提升的单阶段登记 (PSPE)。</span><span class="sxs-lookup"><span data-stu-id="ed565-137">The <xref:System.Transactions.Transaction> class also provides the <xref:System.Transactions.Transaction.EnlistPromotableSinglePhase%2A> method to enlist a Promotable Single Phase Enlistment (PSPE).</span></span> <span data-ttu-id="ed565-138">这使持久资源管理器 (RM) 可承载和“拥有”以后可在需要时升级为由 MSDTC 进行管理的事务。</span><span class="sxs-lookup"><span data-stu-id="ed565-138">This allows a durable resource manager (RM) to host and "own" a transaction that can later be escalated to be managed by the MSDTC if necessary.</span></span> <span data-ttu-id="ed565-139">有关这方面的详细信息，请参阅[优化使用 Single Phase Commit and Promotable Single Phase Notification](../../../../docs/framework/data/transactions/optimization-spc-and-promotable-spn.md)。</span><span class="sxs-lookup"><span data-stu-id="ed565-139">For more information on this, see [Optimization using Single Phase Commit and Promotable Single Phase Notification](../../../../docs/framework/data/transactions/optimization-spc-and-promotable-spn.md).</span></span>  
  
## <a name="in-this-section"></a><span data-ttu-id="ed565-140">本节内容</span><span class="sxs-lookup"><span data-stu-id="ed565-140">In This Section</span></span>  
 <span data-ttu-id="ed565-141">下列主题概括了资源管理器通常所遵循的步骤。</span><span class="sxs-lookup"><span data-stu-id="ed565-141">The steps generally followed by a resource manager are outlined in the following topics.</span></span>  
  
 [<span data-ttu-id="ed565-142">在事务中将资源登记为参与者</span><span class="sxs-lookup"><span data-stu-id="ed565-142">Enlisting Resources as Participants in a Transaction</span></span>](../../../../docs/framework/data/transactions/enlisting-resources-as-participants-in-a-transaction.md)  
  
 <span data-ttu-id="ed565-143">描述如何在事务中登记持久或可变资源。</span><span class="sxs-lookup"><span data-stu-id="ed565-143">Describes how a durable or volatile resource can enlist in a transaction.</span></span>  
  
 [<span data-ttu-id="ed565-144">单阶段和多阶段确认事务</span><span class="sxs-lookup"><span data-stu-id="ed565-144">Committing a Transaction in Single-Phase and Multi-Phase</span></span>](../../../../docs/framework/data/transactions/committing-a-transaction-in-single-phase-and-multi-phase.md)  
  
 <span data-ttu-id="ed565-145">描述资源管理器如何响应提交通知并准备提交。</span><span class="sxs-lookup"><span data-stu-id="ed565-145">Describes how a resource manager responds to commit notification and prepare the commit.</span></span>  
  
 [<span data-ttu-id="ed565-146">执行恢复</span><span class="sxs-lookup"><span data-stu-id="ed565-146">Performing Recovery</span></span>](../../../../docs/framework/data/transactions/performing-recovery.md)  
  
 <span data-ttu-id="ed565-147">描述如何从故障中恢复持久资源管理器。</span><span class="sxs-lookup"><span data-stu-id="ed565-147">Describes how a durable resource manager recovers from failure.</span></span>  
  
 [<span data-ttu-id="ed565-148">访问资源中的安全信任级别</span><span class="sxs-lookup"><span data-stu-id="ed565-148">Security Trust Levels in Accessing Resources</span></span>](../../../../docs/framework/data/transactions/security-trust-levels-in-accessing-resources.md)  
  
 <span data-ttu-id="ed565-149">描述 System.Transactions 的三种信任级别如何限制对 <xref:System.Transactions> 所公开的资源类型的访问。</span><span class="sxs-lookup"><span data-stu-id="ed565-149">Describes how the three levels of trust for System.Transactions restrict access on the types of resources that <xref:System.Transactions> exposes.</span></span>  
  
 [<span data-ttu-id="ed565-150">使用单阶段提交和可提升的单阶段通知进行优化</span><span class="sxs-lookup"><span data-stu-id="ed565-150">Optimization using Single Phase Commit and Promotable Single Phase Notification</span></span>](../../../../docs/framework/data/transactions/optimization-spc-and-promotable-spn.md)  
  
 <span data-ttu-id="ed565-151">描述可用于实现资源管理器的最佳做法。</span><span class="sxs-lookup"><span data-stu-id="ed565-151">Describes optimization practices available to implementations of resource managers.</span></span>
