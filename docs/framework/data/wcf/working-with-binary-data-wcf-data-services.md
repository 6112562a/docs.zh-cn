---
title: 处理二进制数据（WCF 数据服务）
ms.date: 03/30/2017
dev_langs:
- csharp
- vb
helpviewer_keywords:
- WCF Data Services, binary data
- WCF Data Services, streams
ms.assetid: aeccc45c-d5c5-4671-ad63-a492ac8043ac
ms.openlocfilehash: 21501ec9d0af4c785dd86946fa34c1041bb34b9d
ms.sourcegitcommit: 581ab03291e91983459e56e40ea8d97b5189227e
ms.translationtype: MT
ms.contentlocale: zh-CN
ms.lasthandoff: 08/27/2019
ms.locfileid: "70043901"
---
# <a name="working-with-binary-data-wcf-data-services"></a><span data-ttu-id="d096f-102">处理二进制数据（WCF 数据服务）</span><span class="sxs-lookup"><span data-stu-id="d096f-102">Working with Binary Data (WCF Data Services)</span></span>

<span data-ttu-id="d096f-103">使用[!INCLUDE[ssAstoria](../../../../includes/ssastoria-md.md)]客户端库, 可以[!INCLUDE[ssODataFull](../../../../includes/ssodatafull-md.md)]通过以下方式之一从源检索和更新二进制数据:</span><span class="sxs-lookup"><span data-stu-id="d096f-103">The [!INCLUDE[ssAstoria](../../../../includes/ssastoria-md.md)] client library enables you to retrieve and update binary data from an [!INCLUDE[ssODataFull](../../../../includes/ssodatafull-md.md)] feed in one of the following ways:</span></span>

- <span data-ttu-id="d096f-104">作为实体的基元类型属性。</span><span class="sxs-lookup"><span data-stu-id="d096f-104">As a primitive type property of an entity.</span></span> <span data-ttu-id="d096f-105">当使用可轻松加载到内存中的小型二进制数据对象时，建议使用此方法。</span><span class="sxs-lookup"><span data-stu-id="d096f-105">This is the recommended method for working with small binary data objects that can be easily loaded into memory.</span></span> <span data-ttu-id="d096f-106">在这种情况下，二进制属性是数据模型公开的实体属性，而数据服务会在响应消息中将二进制数据序列化为 base-64 二进制编码的 XML。</span><span class="sxs-lookup"><span data-stu-id="d096f-106">In this case, the binary property is an entity property exposed by the data model, and the data service serializes the binary data as base-64 binary encoded XML in the response message.</span></span>

- <span data-ttu-id="d096f-107">作为单独的二进制资源流。</span><span class="sxs-lookup"><span data-stu-id="d096f-107">As a separate binary resource stream.</span></span> <span data-ttu-id="d096f-108">当访问和更改可能表示照片、视频或其他任何类型的二进制编码数据的二进制大型对象 (BLOB) 数据时，建议使用此方法。</span><span class="sxs-lookup"><span data-stu-id="d096f-108">This is the recommended method for accessing and changing binary large object (BLOB) data that may represent a photo, video, or any other type of binary encoded data.</span></span>

[!INCLUDE[ssAstoria](../../../../includes/ssastoria-md.md)]<span data-ttu-id="d096f-109">使用中[!INCLUDE[ssODataShort](../../../../includes/ssodatashort-md.md)]定义的 HTTP 实现二进制数据的流式处理。</span><span class="sxs-lookup"><span data-stu-id="d096f-109">implements the streaming of binary data by using HTTP as defined in the [!INCLUDE[ssODataShort](../../../../includes/ssodatashort-md.md)].</span></span> <span data-ttu-id="d096f-110">在此机制中, 二进制数据被视为独立于实体 (称为媒体链接项) 的媒体资源。</span><span class="sxs-lookup"><span data-stu-id="d096f-110">In this mechanism, binary data is treated as a media resource that is separate from but related to an entity, which is called a media link entry.</span></span> <span data-ttu-id="d096f-111">有关详细信息, 请参阅[流式处理提供程序](../../../../docs/framework/data/wcf/streaming-provider-wcf-data-services.md)。</span><span class="sxs-lookup"><span data-stu-id="d096f-111">For more information, see [Streaming Provider](../../../../docs/framework/data/wcf/streaming-provider-wcf-data-services.md).</span></span>

> [!TIP]
> <span data-ttu-id="d096f-112">有关如何创建 Windows Presentation Foundation (WPF) 客户端应用程序 (该应用程序从[!INCLUDE[ssODataShort](../../../../includes/ssodatashort-md.md)]存储照片的服务下载二进制图像文件) 的分步示例, 请参阅文章[数据服务流提供程序系列-部分2:10从客户端](https://go.microsoft.com/fwlink/?LinkId=201637)访问媒体资源流。</span><span class="sxs-lookup"><span data-stu-id="d096f-112">For a step-by-step example of how to create a Windows Presentation Foundation (WPF) client application that downloads binary image files from an [!INCLUDE[ssODataShort](../../../../includes/ssodatashort-md.md)] service that stores photos, see the post [Data Services Streaming Provider Series-Part 2: Accessing a Media Resource Stream from the Client](https://go.microsoft.com/fwlink/?LinkId=201637).</span></span> <span data-ttu-id="d096f-113">若要下载博客文章中所述的 stream photo data service 的示例代码, 请参阅 MSDN 代码库中的[流式处理照片数据服务示例](https://go.microsoft.com/fwlink/?LinkId=198988)。</span><span class="sxs-lookup"><span data-stu-id="d096f-113">To download the sample code for the stream photo data service featured in the blog post, see the [Streaming Photo Data Service Sample](https://go.microsoft.com/fwlink/?LinkId=198988) in MSDN Code Gallery.</span></span>

## <a name="entity-metadata"></a><span data-ttu-id="d096f-114">实体元数据</span><span class="sxs-lookup"><span data-stu-id="d096f-114">Entity Metadata</span></span>

<span data-ttu-id="d096f-115">具有相关媒体资源流的实体由应用于实体类型（媒体链接入口）的 `HasStream` 属性在数据服务元数据中表示。</span><span class="sxs-lookup"><span data-stu-id="d096f-115">An entity that has a related media resource stream is indicated in the data service metadata by the `HasStream` attribute applied to an entity type that is the media link entry.</span></span> <span data-ttu-id="d096f-116">在下面的示例中, `PhotoInfo`实体是具有相关媒体资源的媒体链接项, `HasStream`由特性指示。</span><span class="sxs-lookup"><span data-stu-id="d096f-116">In the following example, the `PhotoInfo` entity is a media link entry that has a related media resource, indicated by the `HasStream` attribute.</span></span>

[!code-xml[Astoria Photo Streaming Service#HasStream](../../../../samples/snippets/xml/VS_Snippets_Misc/astoria_photo_streaming_service/xml/photodata.edmx#hasstream)]

<span data-ttu-id="d096f-117">本主题中的其余示例揭示了如何访问和更改媒体资源流。</span><span class="sxs-lookup"><span data-stu-id="d096f-117">The remaining examples in this topic show how to access and change the media resource stream.</span></span> <span data-ttu-id="d096f-118">有关如何使用[!INCLUDE[ssAstoria](../../../../includes/ssastoria-md.md)]客户端库在 .NET Framework 客户端应用程序中使用媒体资源流的完整示例, 请参阅[从客户端访问媒体资源流](https://go.microsoft.com/fwlink/?LinkID=201637)一文。</span><span class="sxs-lookup"><span data-stu-id="d096f-118">For a complete example of how to consume a media resource stream in a .NET Framework client application by using the [!INCLUDE[ssAstoria](../../../../includes/ssastoria-md.md)] client library, see the post [Accessing a Media Resource Stream from the Client](https://go.microsoft.com/fwlink/?LinkID=201637).</span></span>

## <a name="accessing-the-binary-resource-stream"></a><span data-ttu-id="d096f-119">访问二进制资源流</span><span class="sxs-lookup"><span data-stu-id="d096f-119">Accessing the Binary Resource Stream</span></span>

<span data-ttu-id="d096f-120">[!INCLUDE[ssAstoria](../../../../includes/ssastoria-md.md)]客户端库提供了从基于 [!INCLUDE[ssODataShort](../../../../includes/ssodatashort-md.md)] 的数据服务访问二进制资源流的方法。</span><span class="sxs-lookup"><span data-stu-id="d096f-120">The [!INCLUDE[ssAstoria](../../../../includes/ssastoria-md.md)] client library provides methods for accessing binary resource streams from an [!INCLUDE[ssODataShort](../../../../includes/ssodatashort-md.md)]-based data service.</span></span> <span data-ttu-id="d096f-121">下载媒体资源时，可以使用媒体资源的 URI，也可以获取一个包含媒体资源数据本身的二进制流。</span><span class="sxs-lookup"><span data-stu-id="d096f-121">When downloading a media resource, you can either use the URI of the media resource or you can get a binary stream that contains the media resource data itself.</span></span> <span data-ttu-id="d096f-122">还可以上载媒体资源数据作为一个二进制流。</span><span class="sxs-lookup"><span data-stu-id="d096f-122">You can also upload media resource data as a binary stream.</span></span>

> [!TIP]
> <span data-ttu-id="d096f-123">有关如何创建 Windows Presentation Foundation (WPF) 客户端应用程序 (该应用程序从[!INCLUDE[ssODataShort](../../../../includes/ssodatashort-md.md)]存储照片的服务下载二进制图像文件) 的分步示例, 请参阅文章[数据服务流提供程序系列-部分2:10从客户端](https://go.microsoft.com/fwlink/?LinkId=201637)访问媒体资源流。</span><span class="sxs-lookup"><span data-stu-id="d096f-123">For a step-by-step example of how to create a Windows Presentation Foundation (WPF) client application that downloads binary image files from an [!INCLUDE[ssODataShort](../../../../includes/ssodatashort-md.md)] service that stores photos, see the post [Data Services Streaming Provider Series-Part 2: Accessing a Media Resource Stream from the Client](https://go.microsoft.com/fwlink/?LinkId=201637).</span></span> <span data-ttu-id="d096f-124">若要下载博客文章中所述的 stream photo data service 的示例代码, 请参阅 MSDN 代码库中的[流式处理照片数据服务示例](https://go.microsoft.com/fwlink/?LinkId=198988)。</span><span class="sxs-lookup"><span data-stu-id="d096f-124">To download the sample code for the stream photo data service featured in the blog post, see the [Streaming Photo Data Service Sample](https://go.microsoft.com/fwlink/?LinkId=198988) in MSDN Code Gallery.</span></span>

### <a name="getting-the-uri-of-the-binary-stream"></a><span data-ttu-id="d096f-125">获取二进制流的 URI</span><span class="sxs-lookup"><span data-stu-id="d096f-125">Getting the URI of the Binary Stream</span></span>

<span data-ttu-id="d096f-126">检索某些类型的媒体资源（如图像和其他媒体文件）时，在应用程序中使用媒体资源的 URI 通常比处理二进制数据流本身更容易。</span><span class="sxs-lookup"><span data-stu-id="d096f-126">When retrieving certain types of media resources, such as images and other media files, it is often easier to use the URI of the media resource in your application than handling the binary data stream itself.</span></span> <span data-ttu-id="d096f-127">要获取与给定媒体链接入口相关联的资源流的 URI，必须对跟踪实体的 <xref:System.Data.Services.Client.DataServiceContext.GetReadStreamUri%2A> 实例调用 <xref:System.Data.Services.Client.DataServiceContext> 方法。</span><span class="sxs-lookup"><span data-stu-id="d096f-127">To get the URI of a resource stream associated with a give media link entry, you must call the <xref:System.Data.Services.Client.DataServiceContext.GetReadStreamUri%2A> method on the <xref:System.Data.Services.Client.DataServiceContext> instance that is tracking the entity.</span></span> <span data-ttu-id="d096f-128">下面的示例揭示了如何调用 <xref:System.Data.Services.Client.DataServiceContext.GetReadStreamUri%2A> 方法以获取用于在客户端上创建新图像的媒体资源流的 URI：</span><span class="sxs-lookup"><span data-stu-id="d096f-128">The following example shows how to call the <xref:System.Data.Services.Client.DataServiceContext.GetReadStreamUri%2A> method to get the URI of a media resource stream that is used to create a new image on the client:</span></span>

[!code-csharp[Astoria Photo Streaming Client#GetReadStreamUri](../../../../samples/snippets/csharp/VS_Snippets_Misc/astoria_photo_streaming_client/cs/photowindow.xaml.cs#getreadstreamuri)]
[!code-vb[Astoria Photo Streaming Client#GetReadStreamUri](../../../../samples/snippets/visualbasic/VS_Snippets_Misc/astoria_photo_streaming_client/vb/photowindow.xaml.vb#getreadstreamuri)]

### <a name="downloading-the-binary-resource-stream"></a><span data-ttu-id="d096f-129">下载二进制资源流</span><span class="sxs-lookup"><span data-stu-id="d096f-129">Downloading the Binary Resource Stream</span></span>

<span data-ttu-id="d096f-130">检索二进制资源流时，必须对跟踪媒体链接入口的 <xref:System.Data.Services.Client.DataServiceContext.GetReadStream%2A> 实例调用 <xref:System.Data.Services.Client.DataServiceContext> 方法。</span><span class="sxs-lookup"><span data-stu-id="d096f-130">When retrieving a binary resource stream, you must call the <xref:System.Data.Services.Client.DataServiceContext.GetReadStream%2A> method on the <xref:System.Data.Services.Client.DataServiceContext> instance that is tracking the media link entry.</span></span> <span data-ttu-id="d096f-131">该方法向数据服务发送一个返回 <xref:System.Data.Services.Client.DataServiceStreamResponse> 对象的请求，该对象具有对包含资源的流的引用。</span><span class="sxs-lookup"><span data-stu-id="d096f-131">This method sends a request to the data service that returns a <xref:System.Data.Services.Client.DataServiceStreamResponse> object, which has a reference to the stream that contains the resource.</span></span> <span data-ttu-id="d096f-132">当应用程序要求将二进制资源作为 <xref:System.IO.Stream> 时可使用该方法。</span><span class="sxs-lookup"><span data-stu-id="d096f-132">Use this method when your application requires the binary resource as a <xref:System.IO.Stream>.</span></span> <span data-ttu-id="d096f-133">下面的示例揭示了如何调用 <xref:System.Data.Services.Client.DataServiceContext.GetReadStream%2A> 方法以检索用于在客户端上创建新图像的流：</span><span class="sxs-lookup"><span data-stu-id="d096f-133">The following example shows how to call the <xref:System.Data.Services.Client.DataServiceContext.GetReadStream%2A> method to retrieve a stream that is used to create a new image on the client:</span></span>

[!code-csharp[Astoria Streaming Client#GetReadStreamClient](../../../../samples/snippets/csharp/VS_Snippets_Misc/astoria_streaming_client/cs/customerphotowindow.xaml.cs#getreadstreamclient)]
[!code-vb[Astoria Streaming Client#GetReadStreamClient](../../../../samples/snippets/visualbasic/VS_Snippets_Misc/astoria_streaming_client/vb/customerphotowindow.xaml.vb#getreadstreamclient)]

> [!NOTE]
> <span data-ttu-id="d096f-134">数据服务不会设置包含二进制数据流的响应消息中的 Content-Length 标头。</span><span class="sxs-lookup"><span data-stu-id="d096f-134">The Content-Length header in the response message that contains the binary steam is not set by the data service.</span></span> <span data-ttu-id="d096f-135">此值可能不反映二进制数据流的实际长度。</span><span class="sxs-lookup"><span data-stu-id="d096f-135">This value may not reflect the actual length of the binary data stream.</span></span>

### <a name="uploading-a-media-resource-as-a-stream"></a><span data-ttu-id="d096f-136">将媒体资源作为流上载</span><span class="sxs-lookup"><span data-stu-id="d096f-136">Uploading a Media Resource as a Stream</span></span>

<span data-ttu-id="d096f-137">若要插入或更新媒体资源，请对正在跟踪实体的 <xref:System.Data.Services.Client.DataServiceContext.SetSaveStream%2A> 实例调用 <xref:System.Data.Services.Client.DataServiceContext> 方法。</span><span class="sxs-lookup"><span data-stu-id="d096f-137">To insert or update a media resource, call the <xref:System.Data.Services.Client.DataServiceContext.SetSaveStream%2A> method on the <xref:System.Data.Services.Client.DataServiceContext> instance that is tracking the entity.</span></span> <span data-ttu-id="d096f-138">此方法向包含从所提供的流中读取的媒体资源的数据服务发送请求。</span><span class="sxs-lookup"><span data-stu-id="d096f-138">This method sends a request to the data service that contains the media resource read from the supplied stream.</span></span> <span data-ttu-id="d096f-139">下面的示例揭示了如何调用 <xref:System.Data.Services.Client.DataServiceContext.SetSaveStream%2A> 方法以向数据服务发送图像：</span><span class="sxs-lookup"><span data-stu-id="d096f-139">The following example shows how to call the <xref:System.Data.Services.Client.DataServiceContext.SetSaveStream%2A> method to send an image to the data service:</span></span>

[!code-csharp[Astoria Photo Streaming Client#SetSaveStream](../../../../samples/snippets/csharp/VS_Snippets_Misc/astoria_photo_streaming_client/cs/photodetailswindow.xaml.cs#setsavestream)]
[!code-vb[Astoria Photo Streaming Client#SetSaveStream](../../../../samples/snippets/visualbasic/VS_Snippets_Misc/astoria_photo_streaming_client/vb/photodetailswindow.xaml.vb#setsavestream)]

<span data-ttu-id="d096f-140">在此示例中，通过为 <xref:System.Data.Services.Client.DataServiceContext.SetSaveStream%2A> 参数提供 `true` 值，调用 `closeStream` 方法。</span><span class="sxs-lookup"><span data-stu-id="d096f-140">In this example, the <xref:System.Data.Services.Client.DataServiceContext.SetSaveStream%2A> method is called by supplying a value of `true` for the `closeStream` parameter.</span></span> <span data-ttu-id="d096f-141">这样可保证在将二进制数据上载到数据服务之后，<xref:System.Data.Services.Client.DataServiceContext> 将会关闭流。</span><span class="sxs-lookup"><span data-stu-id="d096f-141">This guarantees that the <xref:System.Data.Services.Client.DataServiceContext> closes the stream after the binary data is uploaded to the data service.</span></span>

> [!NOTE]
> <span data-ttu-id="d096f-142">调用 <xref:System.Data.Services.Client.DataServiceContext.SetSaveStream%2A> 时，只有在调用 <xref:System.Data.Services.Client.DataServiceContext.SaveChanges%2A> 之后，才会将流发送到数据服务。</span><span class="sxs-lookup"><span data-stu-id="d096f-142">When you call <xref:System.Data.Services.Client.DataServiceContext.SetSaveStream%2A>, the stream is not sent to the data service until <xref:System.Data.Services.Client.DataServiceContext.SaveChanges%2A> is called.</span></span>

## <a name="see-also"></a><span data-ttu-id="d096f-143">请参阅</span><span class="sxs-lookup"><span data-stu-id="d096f-143">See also</span></span>

- [<span data-ttu-id="d096f-144">WCF Data Services 客户端库</span><span class="sxs-lookup"><span data-stu-id="d096f-144">WCF Data Services Client Library</span></span>](../../../../docs/framework/data/wcf/wcf-data-services-client-library.md)
- [<span data-ttu-id="d096f-145">将数据绑定到控件</span><span class="sxs-lookup"><span data-stu-id="d096f-145">Binding Data to Controls</span></span>](../../../../docs/framework/data/wcf/binding-data-to-controls-wcf-data-services.md)
