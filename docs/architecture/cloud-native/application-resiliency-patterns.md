---
title: 应用程序复原能力模式
description: 构建适用于 Azure 的云本机 .NET 应用 |应用程序复原模式
ms.date: 06/30/2019
ms.openlocfilehash: 13811efaa88e0bd2824add1c8712b78b18d46375
ms.sourcegitcommit: 559fcfbe4871636494870a8b716bf7325df34ac5
ms.translationtype: MT
ms.contentlocale: zh-CN
ms.lasthandoff: 10/30/2019
ms.locfileid: "73841887"
---
# <a name="application-resiliency-patterns"></a><span data-ttu-id="c5d78-103">应用程序复原能力模式</span><span class="sxs-lookup"><span data-stu-id="c5d78-103">Application resiliency patterns</span></span>

[!INCLUDE [book-preview](../../../includes/book-preview.md)]

<span data-ttu-id="c5d78-104">第一道防线是支持软件的应用程序复原能力。</span><span class="sxs-lookup"><span data-stu-id="c5d78-104">The first line of defense is software-enabled application resiliency.</span></span>

<span data-ttu-id="c5d78-105">虽然您可以投入大量时间来编写自己的复原框架，此类产品已经存在。</span><span class="sxs-lookup"><span data-stu-id="c5d78-105">While you could invest considerable time writing your own resiliency framework, such products already exist.</span></span> <span data-ttu-id="c5d78-106">例如， [Polly](http://www.thepollyproject.org/)是一个全面的 .net 复原和暂时性故障处理库，使开发人员能够以流畅且线程安全的方式表达复原策略。</span><span class="sxs-lookup"><span data-stu-id="c5d78-106">For example, [Polly](http://www.thepollyproject.org/) is a comprehensive .NET resilience and transient-fault-handling library that allows developers to express resiliency policies in a fluent and thread-safe manner.</span></span> <span data-ttu-id="c5d78-107">Polly 面向用完整 .NET Framework 或 .NET Core 构建的应用程序。</span><span class="sxs-lookup"><span data-stu-id="c5d78-107">Polly targets applications built with either the full .NET Framework or .NET Core.</span></span> <span data-ttu-id="c5d78-108">图6-2 显示了可从 Polly 库获取的复原策略（即功能）。</span><span class="sxs-lookup"><span data-stu-id="c5d78-108">Figure 6-2 shows the resiliency policies (that is, functionality) available from the Polly Library.</span></span> <span data-ttu-id="c5d78-109">这些策略可单独应用或组合在一起应用。</span><span class="sxs-lookup"><span data-stu-id="c5d78-109">These policies can be applied individually or combined together.</span></span>

![Polly 框架](./media/polly-resiliency-framework.png)

<span data-ttu-id="c5d78-111">**图 6-2**.</span><span class="sxs-lookup"><span data-stu-id="c5d78-111">**Figure 6-2**.</span></span> <span data-ttu-id="c5d78-112">Polly 复原框架功能</span><span class="sxs-lookup"><span data-stu-id="c5d78-112">Polly resiliency framework features</span></span>

<span data-ttu-id="c5d78-113">请注意上图中的如何将复原策略应用于请求消息，不管是来自外部客户端还是来自其他后端服务。</span><span class="sxs-lookup"><span data-stu-id="c5d78-113">Note how in the previous figure the resiliency policies apply to request messages, whether coming from an external client or another back-end service.</span></span> <span data-ttu-id="c5d78-114">目标是对可能暂时不可用的服务的请求进行补偿。</span><span class="sxs-lookup"><span data-stu-id="c5d78-114">The goal is to compensate the request for a service that might be momentarily unavailable.</span></span> <span data-ttu-id="c5d78-115">通常，这些短暂的中断会表现在图6-3 中所示的 HTTP 状态代码。</span><span class="sxs-lookup"><span data-stu-id="c5d78-115">These short interruptions typically manifest themselves with the HTTP status codes shown in Figure 6-3.</span></span>

![要重试的 HTTP 状态代码](./media/http-status-codes.png)

<span data-ttu-id="c5d78-117">**图 6-3**。</span><span class="sxs-lookup"><span data-stu-id="c5d78-117">**Figure 6-3**.</span></span> <span data-ttu-id="c5d78-118">要重试的 HTTP 状态代码</span><span class="sxs-lookup"><span data-stu-id="c5d78-118">HTTP status codes to retry</span></span>

<span data-ttu-id="c5d78-119">问：是否要重试 HTTP 状态代码 403-禁止访问？</span><span class="sxs-lookup"><span data-stu-id="c5d78-119">Question: Would you retry an HTTP Status Code of 403 - Forbidden?</span></span> <span data-ttu-id="c5d78-120">No。</span><span class="sxs-lookup"><span data-stu-id="c5d78-120">No.</span></span> <span data-ttu-id="c5d78-121">此时，系统将正常运行，但通知调用方他们无权执行所请求的操作。</span><span class="sxs-lookup"><span data-stu-id="c5d78-121">Here, the system is functioning properly, but informing the caller that they aren't authorized to perform the requested operation.</span></span> <span data-ttu-id="c5d78-122">必须注意仅重试由失败导致的操作。</span><span class="sxs-lookup"><span data-stu-id="c5d78-122">Care must be taken to retry only those operations caused by failures.</span></span>

<span data-ttu-id="c5d78-123">如第1章所述，构建云本机应用程序的 Microsoft 开发人员应面向 .NET Core。</span><span class="sxs-lookup"><span data-stu-id="c5d78-123">As recommended in Chapter 1, Microsoft developers constructing cloud-native applications should target .NET Core.</span></span> <span data-ttu-id="c5d78-124">版本2.1 引入了[HTTPClientFactory](https://www.stevejgordon.co.uk/introduction-to-httpclientfactory-aspnetcore)库，用于创建用于与基于 URL 的资源交互的 HTTP 客户端实例。</span><span class="sxs-lookup"><span data-stu-id="c5d78-124">Version 2.1 introduced the [HTTPClientFactory](https://www.stevejgordon.co.uk/introduction-to-httpclientfactory-aspnetcore) library for creating HTTP Client instances for interacting with URL-based resources.</span></span> <span data-ttu-id="c5d78-125">工厂类取代了原始 HTTPClient 类，它支持许多增强功能，其中一个功能与 Polly 复原库[紧密集成](../microservices/implement-resilient-applications/implement-http-call-retries-exponential-backoff-polly.md)。</span><span class="sxs-lookup"><span data-stu-id="c5d78-125">Superseding the original HTTPClient class, the factory class supports many enhanced features, one of which is [tight integration](../microservices/implement-resilient-applications/implement-http-call-retries-exponential-backoff-polly.md) with the Polly resiliency library.</span></span> <span data-ttu-id="c5d78-126">利用它，你可以轻松地在应用程序启动类中定义复原策略来处理部分故障和连接问题。</span><span class="sxs-lookup"><span data-stu-id="c5d78-126">With it, you can easily define resiliency policies in the application Startup class to handle partial failures and connectivity issues.</span></span>

<span data-ttu-id="c5d78-127">接下来，让我们展开重试和断路器模式。</span><span class="sxs-lookup"><span data-stu-id="c5d78-127">Next, let's expand on retry and circuit breaker patterns.</span></span>

### <a name="retry-pattern"></a><span data-ttu-id="c5d78-128">重试模式</span><span class="sxs-lookup"><span data-stu-id="c5d78-128">Retry pattern</span></span>

<span data-ttu-id="c5d78-129">在分布式云本机环境中，对服务和云资源的调用可能会失败，因为暂时（短暂）故障，这通常会在短时间内自行更正。</span><span class="sxs-lookup"><span data-stu-id="c5d78-129">In a distributed cloud-native environment, calls to services and cloud resources can fail because of transient (short-lived) failures, which typically correct themselves after a brief period of time.</span></span> <span data-ttu-id="c5d78-130">实现重试策略可帮助云本机服务处理这些方案。</span><span class="sxs-lookup"><span data-stu-id="c5d78-130">Implementing a retry strategy helps a cloud-native service handle these scenarios.</span></span>

<span data-ttu-id="c5d78-131">[重试模式](https://docs.microsoft.com/azure/architecture/patterns/retry)使服务能够用呈指数增加的等待时间重试失败的请求操作（可配置）。</span><span class="sxs-lookup"><span data-stu-id="c5d78-131">The [Retry pattern](https://docs.microsoft.com/azure/architecture/patterns/retry) enables a service to retry a failed request operation a (configurable) number of times with an exponentially increasing wait time.</span></span> <span data-ttu-id="c5d78-132">图6-4 显示了一个重试操作。</span><span class="sxs-lookup"><span data-stu-id="c5d78-132">Figure 6-4 shows a retry in action.</span></span>

![操作中的重试模式](./media/retry-pattern.png)

<span data-ttu-id="c5d78-134">图 6-4。</span><span class="sxs-lookup"><span data-stu-id="c5d78-134">**Figure 6-4**.</span></span> <span data-ttu-id="c5d78-135">操作中的重试模式</span><span class="sxs-lookup"><span data-stu-id="c5d78-135">Retry pattern in action</span></span>

<span data-ttu-id="c5d78-136">在上图中，已为请求操作实现重试模式。</span><span class="sxs-lookup"><span data-stu-id="c5d78-136">In the previous figure, a retry pattern has been implemented for a request operation.</span></span> <span data-ttu-id="c5d78-137">它已配置为允许最多四次重试，而不能从两秒开始的回退时间间隔（等待时间）开始，每次后续尝试都呈指数级增长。</span><span class="sxs-lookup"><span data-stu-id="c5d78-137">It's configured to allow up to four retries before failing with a backoff interval (wait time) starting at two seconds, which exponentially doubles for each subsequent attempt.</span></span>

- <span data-ttu-id="c5d78-138">第一次调用失败并返回 HTTP 状态代码500。</span><span class="sxs-lookup"><span data-stu-id="c5d78-138">The first invocation fails and returns an HTTP status code of 500.</span></span> <span data-ttu-id="c5d78-139">应用程序等待两秒钟，然后重试呼叫。</span><span class="sxs-lookup"><span data-stu-id="c5d78-139">The application waits for two seconds and retries the call.</span></span>
- <span data-ttu-id="c5d78-140">第二次调用也失败，并返回 HTTP 状态代码500。</span><span class="sxs-lookup"><span data-stu-id="c5d78-140">The second invocation also fails and returns an HTTP status code of 500.</span></span> <span data-ttu-id="c5d78-141">现在，应用程序将回退间隔加倍到4秒，然后重试该调用。</span><span class="sxs-lookup"><span data-stu-id="c5d78-141">The application now doubles the backoff interval to four seconds and retries the call.</span></span>
- <span data-ttu-id="c5d78-142">最后，第三次调用成功。</span><span class="sxs-lookup"><span data-stu-id="c5d78-142">Finally, the third call succeeds.</span></span>
- <span data-ttu-id="c5d78-143">在此方案中，重试操作最多尝试四次重试，同时在调用失败之前将回退持续时间加倍。</span><span class="sxs-lookup"><span data-stu-id="c5d78-143">In this scenario, the retry operation would have attempted up to four retries while doubling the backoff duration before failing the call.</span></span>

<span data-ttu-id="c5d78-144">在重试调用以允许服务时间自动更正之前，请务必增加回退时间。</span><span class="sxs-lookup"><span data-stu-id="c5d78-144">It's important to increase the backoff period before retrying the call to allow the service time to self-correct.</span></span> <span data-ttu-id="c5d78-145">最佳做法是实现以指数方式递增的回退（每次重试时加倍一次），以允许足够的更正时间。</span><span class="sxs-lookup"><span data-stu-id="c5d78-145">It's a best practice to implement an exponentially increasing backoff (doubling the period on each retry) to allow adequate correction time.</span></span>

## <a name="circuit-breaker-pattern"></a><span data-ttu-id="c5d78-146">断路器模式</span><span class="sxs-lookup"><span data-stu-id="c5d78-146">Circuit breaker pattern</span></span>

<span data-ttu-id="c5d78-147">尽管重试模式可以在部分失败时帮助抢救请求放大，但在某些情况下，可能会由于意外的事件需要更长的时间来解决，导致失败。</span><span class="sxs-lookup"><span data-stu-id="c5d78-147">While the retry pattern can help salvage a request entangled in a partial failure, there are situations where failures can be caused by unanticipated events that will require longer periods of time to resolve.</span></span> <span data-ttu-id="c5d78-148">这些故障轻则导致部分连接中断，重则导致服务完全瘫痪。</span><span class="sxs-lookup"><span data-stu-id="c5d78-148">These faults can range in severity from a partial loss of connectivity to the complete failure of a service.</span></span> <span data-ttu-id="c5d78-149">在这些情况下，应用程序不必再重试不太可能成功的操作。</span><span class="sxs-lookup"><span data-stu-id="c5d78-149">In these situations, it's pointless for an application to continually retry an operation that is unlikely to succeed.</span></span>

<span data-ttu-id="c5d78-150">要使任务更糟，对非响应式服务执行连续重试操作可以将你转到自行投入使用的拒绝服务方案，在此方案中，你可以通过连续调用耗尽资源（如内存、线程和数据库连接，导致系统中使用相同资源的无关部分出现故障。</span><span class="sxs-lookup"><span data-stu-id="c5d78-150">To make things worse, executing continual retry operations on a non-responsive service can move you into a self-imposed denial of service scenario where you flood your service with continual calls exhausting resources such as memory, threads and database connections, causing failure in unrelated parts of the system that use the same resources.</span></span>

<span data-ttu-id="c5d78-151">在这种情况下，操作会立即失败并仅在有可能成功的情况下尝试调用服务，这是最好的做法。</span><span class="sxs-lookup"><span data-stu-id="c5d78-151">In these situations, it would be preferable for the operation to fail immediately and only attempt to invoke the service if it's likely to succeed.</span></span>

<span data-ttu-id="c5d78-152">[断路器模式](https://docs.microsoft.com/azure/architecture/patterns/circuit-breaker)可以防止应用程序重复尝试执行很可能失败的操作。</span><span class="sxs-lookup"><span data-stu-id="c5d78-152">The [Circuit Breaker pattern](https://docs.microsoft.com/azure/architecture/patterns/circuit-breaker) can prevent an application from repeatedly trying to execute an operation that's likely to fail.</span></span> <span data-ttu-id="c5d78-153">它还使用定期试验调用来监视应用程序，以确定是否已解决错误。</span><span class="sxs-lookup"><span data-stu-id="c5d78-153">It also monitors the application with a periodic trial call to determine whether the fault has resolved.</span></span> <span data-ttu-id="c5d78-154">图6-5 显示了操作中的断路器模式。</span><span class="sxs-lookup"><span data-stu-id="c5d78-154">Figure 6-5 shows the Circuit Breaker pattern in action.</span></span>

![操作中的断路器模式](./media/circuit-breaker-pattern.png)

<span data-ttu-id="c5d78-156">图 6-5。</span><span class="sxs-lookup"><span data-stu-id="c5d78-156">**Figure 6-5**.</span></span> <span data-ttu-id="c5d78-157">操作中的断路器模式</span><span class="sxs-lookup"><span data-stu-id="c5d78-157">Circuit breaker pattern in action</span></span>

<span data-ttu-id="c5d78-158">在上图中，已将断路器模式添加到原始重试模式。</span><span class="sxs-lookup"><span data-stu-id="c5d78-158">In the previous figure, a Circuit Breaker pattern has been added to the original retry pattern.</span></span> <span data-ttu-id="c5d78-159">请注意，请求10个失败后，断路会打开，不再允许对服务的调用。</span><span class="sxs-lookup"><span data-stu-id="c5d78-159">Note how after 10 failed requests, the circuit breakers opens and no longer allows calls to the service.</span></span> <span data-ttu-id="c5d78-160">CheckCircuit 值设置为30秒，指定库允许一个请求继续到服务的频率。</span><span class="sxs-lookup"><span data-stu-id="c5d78-160">The CheckCircuit value, set at 30 seconds, specifies how often the library allows one request to proceed to the service.</span></span> <span data-ttu-id="c5d78-161">如果该调用成功，线路将关闭，并且服务再次可用于通信。</span><span class="sxs-lookup"><span data-stu-id="c5d78-161">If that call succeeds, the circuit closes and the service is once again available to traffic.</span></span>

<span data-ttu-id="c5d78-162">请记住，断路器模式的目的*不同*于重试模式。</span><span class="sxs-lookup"><span data-stu-id="c5d78-162">Keep in mind that the intent of the Circuit Breaker pattern is *different* than that of the Retry pattern.</span></span> <span data-ttu-id="c5d78-163">重试模式使应用程序能够在预期成功的情况下重试操作。</span><span class="sxs-lookup"><span data-stu-id="c5d78-163">The Retry pattern enables an application to retry an operation in the expectation that it will succeed.</span></span> <span data-ttu-id="c5d78-164">断路器模式可以防止应用程序执行可能会失败的操作。</span><span class="sxs-lookup"><span data-stu-id="c5d78-164">The Circuit Breaker pattern prevents an application from doing an operation that is likely to fail.</span></span> <span data-ttu-id="c5d78-165">通常，应用程序将通过使用重试模式来通过断路器调用操作来*合并*这两种模式。</span><span class="sxs-lookup"><span data-stu-id="c5d78-165">Often, an application will *combine* these two patterns by using the Retry pattern to invoke an operation through a circuit breaker.</span></span> <span data-ttu-id="c5d78-166">但是，重试逻辑应对断路器返回的任何异常敏感，并在断路器指示故障不是暂时性时放弃重试尝试。</span><span class="sxs-lookup"><span data-stu-id="c5d78-166">However, the retry logic should be sensitive to any exceptions returned by the circuit breaker and abandon retry attempts if the circuit breaker indicates that a fault isn't transient.</span></span>

<span data-ttu-id="c5d78-167">应用程序复原能力是处理请求的操作时必须执行的操作。</span><span class="sxs-lookup"><span data-stu-id="c5d78-167">Application resiliency is a must for handling problematic requested operations.</span></span> <span data-ttu-id="c5d78-168">但这只是故事的一半。</span><span class="sxs-lookup"><span data-stu-id="c5d78-168">But, it's only half of the story.</span></span> <span data-ttu-id="c5d78-169">接下来，我们介绍 Azure 云中提供的复原功能。</span><span class="sxs-lookup"><span data-stu-id="c5d78-169">Next, we cover resiliency features available in the Azure cloud.</span></span>

>[!div class="step-by-step"]
><span data-ttu-id="c5d78-170">[上一页](resiliency.md)
>[下一页](infrastructure-resiliency-azure.md)</span><span class="sxs-lookup"><span data-stu-id="c5d78-170">[Previous](resiliency.md)
[Next](infrastructure-resiliency-azure.md)</span></span>
